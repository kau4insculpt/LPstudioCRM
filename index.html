<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>StudioCRM v7 ‚Äî LilliputLand</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ TOKENS ‚îÄ‚îÄ */
:root{
  --bg:#0f0f0f;--sf:#1a1a1a;--sf2:#232323;--sf3:#2c2c2c;--bd:#2e2e2e;
  --tx:#f0ede8;--tm:#888;--td:#555;
  --ac:#e8c97a;--acd:#c9a94e;
  --gr:#4caf7d;--rd:#e05c5c;--or:#e8914a;--bl:#5b9bd5;--pu:#9b72cf;--gy:#666;
  --am:#d4a843;--go:#c9a94e;
  /* tag palette */
  --t-booked:#4caf7d;  --t-booked-bg:rgba(76,175,125,.12);
  --t-int:#5b9bd5;     --t-int-bg:rgba(91,155,213,.12);
  --t-warm:#20c5b0;    --t-warm-bg:rgba(32,197,176,.12);
  --t-nore:#e8914a;    --t-nore-bg:rgba(232,145,74,.12);
  --t-cold:#e05c5c;    --t-cold-bg:rgba(224,92,92,.12);
  --t-oop:#9b72cf;     --t-oop-bg:rgba(155,114,207,.12);
  --t-inv:#666;        --t-inv-bg:rgba(102,102,102,.12);
  --t-new:#555;        --t-new-bg:rgba(85,85,85,.08);
  --t-done:#c9a94e;    --t-done-bg:rgba(201,169,78,.12);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;font-size:14px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{background:var(--sf);border-bottom:1px solid var(--bd);padding:0 16px;display:flex;align-items:center;gap:6px;height:52px;position:sticky;top:0;z-index:100}
.logo{font-family:'Playfair Display',serif;font-size:15px;color:var(--ac);white-space:nowrap;margin-right:2px}
.logo em{color:var(--tm);font-size:10px;font-style:normal;font-family:'DM Sans',sans-serif;margin-left:3px}
.tabs{display:flex;gap:1px}
.tb{background:none;border:none;color:var(--tm);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 10px;border-radius:6px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tb:hover{color:var(--tx);background:var(--sf2)}.tb.active{color:var(--ac);background:rgba(232,201,122,.1)}
.hact{margin-left:auto;display:flex;gap:4px;align-items:center}
.bi{background:var(--sf2);border:1px solid var(--bd);color:var(--tm);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 9px;border-radius:6px;cursor:pointer;transition:all .2s;white-space:nowrap}
.bi:hover{color:var(--tx);border-color:var(--ac)}
/* Pipeline selector */
.pipeline-wrap{display:flex;align-items:center;gap:4px}
.pipeline-sel{background:var(--sf2);border:1px solid var(--ac);color:var(--ac);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;padding:5px 8px;border-radius:6px;cursor:pointer;max-width:160px}
.bi:hover{color:var(--tx);border-color:var(--ac)}
.btnadd{background:var(--ac);color:#0f0f0f;border:none;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;padding:6px 13px;border-radius:7px;cursor:pointer;white-space:nowrap;transition:background .2s}
.btnadd:hover{background:var(--acd)}

/* ‚îÄ‚îÄ YOU ARE BAR ‚îÄ‚îÄ */
.ya-bar{background:var(--sf);border-bottom:1px solid var(--bd);padding:5px 18px;display:flex;align-items:center;gap:8px;font-size:12px;color:var(--tm)}
.ya-bar select{background:var(--sf2);border:1px solid var(--ac);color:var(--ac);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;padding:3px 8px;border-radius:6px;cursor:pointer}
.ya-bar .ya-hint{color:var(--td);font-size:11px;margin-left:4px}
/* Agent chip with optional email sub-line */
.ach{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-size:12px;padding:5px 10px;border-radius:8px;display:flex;align-items:center;gap:6px;justify-content:space-between}
.ach-info{display:flex;flex-direction:column;gap:1px}
.ach-name{font-size:12px;font-weight:500}
.ach-email{font-size:10px;color:var(--td)}
/* Audit log tab */
.audit-row{display:grid;grid-template-columns:100px 90px 1fr 130px;gap:6px;padding:6px 10px;border-bottom:1px solid var(--bd);font-size:12px;align-items:start}
.audit-row:hover{background:var(--sf2)}
.audit-hdr{font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.06em;font-weight:600}
.audit-action{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:600}
.aa-add{background:rgba(76,175,125,.15);color:#4caf7d}
.aa-edit{background:rgba(91,155,213,.15);color:#5b9bd5}
.aa-del{background:rgba(224,92,92,.15);color:#e05c5c}
.aa-tag{background:rgba(232,201,122,.15);color:#e8c97a}
/* ‚îÄ‚îÄ ALERT BANNER ‚îÄ‚îÄ */
.alert-bar{background:rgba(224,92,92,.08);border-bottom:1px solid rgba(224,92,92,.25);padding:7px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.alert-bar.hidden{display:none}
.alert-pill{background:rgba(224,92,92,.15);border:1px solid rgba(224,92,92,.3);color:var(--rd);font-size:12px;padding:3px 10px;border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap}
.alert-pill:hover{background:rgba(224,92,92,.25)}
.alert-pill.or{background:rgba(232,145,74,.12);border-color:rgba(232,145,74,.3);color:var(--or)}
.alert-pill.or:hover{background:rgba(232,145,74,.22)}
.alert-dismiss{margin-left:auto;background:none;border:none;color:var(--td);cursor:pointer;font-size:16px}
.alert-dismiss:hover{color:var(--tx)}

/* ‚îÄ‚îÄ FILTER BARS ‚îÄ‚îÄ */
.fbar,.fbar2{background:var(--sf);border-bottom:1px solid var(--bd);padding:6px 16px;display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.fs,.fi{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 8px;border-radius:6px;outline:none;transition:border-color .2s}
.fs{cursor:pointer}.fi::placeholder{color:var(--td)}.fs:focus,.fi:focus{border-color:var(--ac)}
.chip{border:1px solid var(--bd);font-family:'DM Sans',sans-serif;font-size:11px;padding:3px 9px;border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap;background:none}
.chip.or{color:var(--or);border-color:rgba(232,145,74,.35)}.chip.or:hover,.chip.or.on{background:rgba(232,145,74,.12);border-color:var(--or)}
.chip.pu{color:var(--pu);border-color:rgba(155,114,207,.35)}.chip.pu:hover,.chip.pu.on{background:rgba(155,114,207,.12);border-color:var(--pu)}
.chip.bl{color:var(--bl);border-color:rgba(91,155,213,.35)}.chip.bl:hover,.chip.bl.on{background:rgba(91,155,213,.12);border-color:var(--bl)}
.chip.gr{color:var(--gr);border-color:rgba(76,175,125,.35)}.chip.gr:hover,.chip.gr.on{background:rgba(76,175,125,.12);border-color:var(--gr)}
.date-chip{border:1px solid var(--bd);font-family:'DM Sans',sans-serif;font-size:11px;padding:3px 9px;border-radius:20px;cursor:pointer;transition:all .2s;white-space:nowrap;background:none;color:var(--tm)}
.date-chip:hover,.date-chip.on{background:rgba(232,201,122,.1);border-color:var(--ac);color:var(--ac)}
.bclr{background:none;border:1px solid var(--bd);color:var(--tm);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 9px;border-radius:6px;cursor:pointer;transition:all .2s}
.bclr:hover{color:var(--tx);border-color:var(--tm)}
.bexp{background:none;border:1px solid var(--bd);color:var(--tm);font-family:'DM Sans',sans-serif;font-size:11px;padding:4px 9px;border-radius:6px;cursor:pointer;transition:all .2s}
.bexp:hover{border-color:var(--ac);color:var(--ac)}
.fcnt{color:var(--tm);font-size:12px;white-space:nowrap}
.drl{font-size:12px;color:var(--tm);white-space:nowrap}

/* ‚îÄ‚îÄ BULK ACTIONS BAR ‚îÄ‚îÄ */
.bulk-bar{background:rgba(232,201,122,.07);border-bottom:1px solid rgba(232,201,122,.2);padding:6px 16px;display:none;align-items:center;gap:8px}
.bulk-bar.show{display:flex}
.bulk-info{font-size:13px;font-weight:500;color:var(--ac)}
.bulk-assign{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 9px;border-radius:6px;cursor:pointer;outline:none}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.lt{width:100%;border-collapse:collapse}
.lt thead tr{background:var(--sf);border-bottom:1px solid var(--bd)}
.lt th{padding:7px 12px;text-align:left;font-size:10px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;white-space:nowrap}
.lt th.chk{width:32px;padding:7px 8px}
.lt tbody tr{border-bottom:1px solid var(--bd);cursor:pointer;transition:background .15s}
.lt tbody tr:hover{background:var(--sf2)}
.lt tbody tr.sel{background:rgba(232,201,122,.06)}
.lt td{padding:9px 12px;vertical-align:middle}
.lt td.chk{padding:9px 8px;cursor:default}
.col-hide{display:none!important}

/* row left-border by tag */
.lt tbody tr.tag-booked{border-left:3px solid var(--t-booked)}
.lt tbody tr.tag-int{border-left:3px solid var(--t-int)}
.lt tbody tr.tag-warm{border-left:3px solid var(--t-warm)}
.lt tbody tr.tag-nore{border-left:3px solid var(--t-nore)}
.lt tbody tr.tag-cold{border-left:3px solid var(--t-cold)}
.lt tbody tr.tag-oop{border-left:3px solid var(--t-oop)}
.lt tbody tr.tag-inv{border-left:3px solid var(--t-inv)}
.lt tbody tr.wm{border-left:3px solid var(--rd)!important}

/* ‚îÄ‚îÄ DOTS ‚îÄ‚îÄ */
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dg{background:var(--t-booked);box-shadow:0 0 5px var(--t-booked)}
.dr{background:var(--t-cold);box-shadow:0 0 5px var(--t-cold)}
.do{background:var(--t-nore);box-shadow:0 0 5px var(--t-nore)}
.db{background:var(--t-int);box-shadow:0 0 5px var(--t-int)}
.dw{background:var(--t-warm);box-shadow:0 0 5px var(--t-warm)}
.dp{background:var(--t-oop)}
.dgy{background:var(--gy)}
.dn{background:var(--t-new)}
.dgo{background:var(--t-done);box-shadow:0 0 5px var(--t-done)}

/* ‚îÄ‚îÄ TAG BADGES ‚îÄ‚îÄ */
.ln{font-weight:500}.ln.un{color:var(--td);font-style:italic}.lp{color:var(--tm);font-size:12px;margin-top:1px}
.badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:11px;font-weight:500;white-space:nowrap}
.badge-tag{font-size:10px;font-weight:600;padding:2px 7px;border-radius:20px}
.tag-booked .badge-tag{background:var(--t-booked-bg);color:var(--t-booked);border:1px solid rgba(76,175,125,.25)}
.tag-int    .badge-tag{background:var(--t-int-bg);   color:var(--t-int);   border:1px solid rgba(91,155,213,.25)}
.tag-warm   .badge-tag{background:var(--t-warm-bg);  color:var(--t-warm);  border:1px solid rgba(212,168,67,.25)}
.tag-nore   .badge-tag{background:var(--t-nore-bg);  color:var(--t-nore);  border:1px solid rgba(232,145,74,.25)}
.tag-cold   .badge-tag{background:var(--t-cold-bg);  color:var(--t-cold);  border:1px solid rgba(224,92,92,.25)}
.tag-oop    .badge-tag{background:var(--t-oop-bg);   color:var(--t-oop);   border:1px solid rgba(155,114,207,.25)}
.tag-inv    .badge-tag{background:var(--t-inv-bg);   color:var(--t-inv);   border:1px solid rgba(102,102,102,.25)}
.tag-new    .badge-tag{background:var(--t-new-bg);   color:var(--t-new);   border:1px solid rgba(85,85,85,.2)}
.tag-done   .badge-tag{background:var(--t-done-bg);  color:var(--t-done);  border:1px solid rgba(201,169,78,.25)}
/* standalone badge-tag (outside tr context) */
.btag-booked{background:var(--t-booked-bg);color:var(--t-booked);border:1px solid rgba(76,175,125,.25)}
.btag-int{background:var(--t-int-bg);color:var(--t-int);border:1px solid rgba(91,155,213,.25)}
.btag-warm{background:var(--t-warm-bg);color:var(--t-warm);border:1px solid rgba(212,168,67,.25)}
.btag-nore{background:var(--t-nore-bg);color:var(--t-nore);border:1px solid rgba(232,145,74,.25)}
.btag-cold{background:var(--t-cold-bg);color:var(--t-cold);border:1px solid rgba(224,92,92,.25)}
.btag-oop{background:var(--t-oop-bg);color:var(--t-oop);border:1px solid rgba(155,114,207,.25)}
.btag-inv{background:var(--t-inv-bg);color:var(--t-inv);border:1px solid rgba(102,102,102,.25)}
.btag-new{background:var(--t-new-bg);color:var(--t-new);border:1px solid rgba(85,85,85,.2)}
.btag-done{background:var(--t-done-bg);color:var(--t-done);border:1px solid rgba(201,169,78,.25)}
.bs{background:rgba(91,155,213,.15);color:var(--bl)}
.bw{background:rgba(224,92,92,.15);color:var(--rd);font-size:10px}
.bn{background:rgba(155,114,207,.12);color:var(--pu);font-size:10px}
.age-badge{background:rgba(212,168,67,.1);color:var(--am);border:1px solid rgba(212,168,67,.2);font-size:10px;padding:1px 6px;border-radius:20px}
.wa-btn{background:none;border:none;cursor:pointer;color:var(--gr);font-size:13px;padding:0 3px;opacity:.6;vertical-align:middle;line-height:1;transition:opacity .2s}
.wa-btn:hover{opacity:1}

/* ‚îÄ‚îÄ FU DUE LABELS ‚îÄ‚îÄ */
.ovd{color:var(--rd);font-size:11px}.dtd{color:var(--or);font-size:11px}.upc{color:var(--tm);font-size:11px}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.pov{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;opacity:0;pointer-events:none;transition:opacity .3s}
.pov.open{opacity:1;pointer-events:all}
.sp{position:fixed;right:0;top:0;bottom:0;width:800px;max-width:100vw;background:var(--sf);border-left:1px solid var(--bd);z-index:201;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column;overflow:hidden}
.sp.open{transform:translateX(0)}
.ph{padding:10px 18px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:8px}
.ph-tag{padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.ph-nav{display:flex;gap:4px;align-items:center;margin-left:auto}
.ph-nav button{background:var(--sf2);border:1px solid var(--bd);color:var(--tm);font-family:'DM Sans',sans-serif;font-size:12px;padding:4px 10px;border-radius:6px;cursor:pointer;transition:all .2s}
.ph-nav button:hover{border-color:var(--ac);color:var(--ac)}
.ph-nav button:disabled{opacity:.3;cursor:default}
.pt{font-family:'Playfair Display',serif;font-size:15px;color:var(--ac)}
.pc{background:none;border:none;color:var(--tm);font-size:20px;cursor:pointer;padding:2px 5px;border-radius:4px}.pc:hover{color:var(--tx)}
.pb{display:grid;grid-template-columns:280px 1fr;flex:1;overflow:hidden;min-height:0}
.pbl{padding:12px 14px 12px 18px;border-right:1px solid var(--bd);overflow:hidden;display:flex;flex-direction:column}
.pbr{padding:12px 18px 12px 14px;overflow:hidden;display:flex;flex-direction:column}
.pf{padding:9px 18px;border-top:1px solid var(--bd);display:flex;gap:7px;flex-shrink:0}
.fg{margin-bottom:8px}
.fl{font-size:10px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;display:block}
.fi2{width:100%;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:13px;padding:6px 9px;border-radius:6px;outline:none;transition:border-color .2s}
.fi2:focus{border-color:var(--ac)}
.fs2{width:100%;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:13px;padding:6px 9px;border-radius:6px;outline:none;cursor:pointer;transition:border-color .2s}
.fs2:focus{border-color:var(--ac)}
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:7px}
textarea.fi2{resize:none;height:52px}
.sdiv{font-size:10px;font-weight:600;color:var(--td);text-transform:uppercase;letter-spacing:.08em;margin:8px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--bd)}

/* FU stepper */
.fu-stepper{display:flex;flex-direction:column;gap:6px;flex:1;overflow:hidden}
.fus{border:1px solid var(--bd);border-radius:8px;padding:9px 11px;transition:all .2s;background:var(--sf2);flex-shrink:0}
.fus.locked{opacity:.25;pointer-events:none;background:transparent;border-style:dashed}
.fus-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.fus-title{font-size:12px;font-weight:600;color:var(--ac)}
.fus-num{font-size:10px;color:var(--tm);background:var(--sf3);padding:2px 6px;border-radius:20px}
.fus-row{display:flex;gap:7px;align-items:flex-start;margin-bottom:6px}
.fus-date{display:flex;align-items:center;gap:4px;flex-shrink:0}
.fus-date span{font-size:10px;color:var(--tm);white-space:nowrap}
.fus-date input{background:var(--sf3);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:11px;padding:4px 6px;border-radius:5px;outline:none;width:118px}
.fus-date input:focus{border-color:var(--ac)}
.fus-note textarea{width:100%;background:var(--sf3);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:12px;padding:4px 7px;border-radius:5px;outline:none;resize:none;height:40px}
.fus-note textarea:focus{border-color:var(--ac)}
.og{display:flex;flex-wrap:wrap;gap:3px}
.ob{background:var(--sf3);border:1px solid var(--bd);color:var(--tm);font-family:'DM Sans',sans-serif;font-size:11px;padding:2px 8px;border-radius:20px;cursor:pointer;transition:all .15s;white-space:nowrap}
.ob:hover{border-color:var(--ac);color:var(--tx)}
.ob.sg{border-color:var(--t-booked);background:var(--t-booked-bg);color:var(--t-booked);font-weight:600}
.ob.sb{border-color:var(--t-int);background:var(--t-int-bg);color:var(--t-int);font-weight:600}
.ob.so{border-color:var(--t-nore);background:var(--t-nore-bg);color:var(--t-nore);font-weight:600}
.ob.sr{border-color:var(--t-cold);background:var(--t-cold-bg);color:var(--t-cold);font-weight:600}
.ob.sp{border-color:var(--t-oop);background:var(--t-oop-bg);color:var(--t-oop);font-weight:600}
.ob.sa{border-color:var(--t-warm);background:var(--t-warm-bg);color:var(--t-warm);font-weight:600}

/* ‚îÄ‚îÄ QUICK CALL MODE ‚îÄ‚îÄ */
.qcm-bar{background:rgba(76,175,125,.08);border-bottom:1px solid rgba(76,175,125,.25);padding:7px 16px;display:flex;align-items:center;gap:10px;display:none}
.qcm-bar.show{display:flex}
.qcm-info{font-size:13px;color:var(--gr);font-weight:500}
.qcm-prog{font-size:12px;color:var(--tm)}
.qcm-next{background:var(--gr);color:#0f0f0f;border:none;font-family:'DM Sans',sans-serif;font-weight:600;font-size:12px;padding:5px 14px;border-radius:6px;cursor:pointer}
.qcm-exit{background:none;border:1px solid rgba(76,175,125,.3);color:var(--gr);font-family:'DM Sans',sans-serif;font-size:12px;padding:5px 10px;border-radius:6px;cursor:pointer}
.qcm-exit:hover{background:rgba(76,175,125,.1)}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.mov{position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:300;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s}
.mov.open{opacity:1;pointer-events:all}
.modal{background:var(--sf);border:1px solid var(--bd);border-radius:12px;width:100%;max-height:88vh;overflow-y:auto}
.modal.sm{max-width:480px}.modal.md{max-width:620px}.modal.lg{max-width:780px}
.mh{padding:14px 18px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--sf);z-index:1}
.mt{font-family:'Playfair Display',serif;font-size:15px;color:var(--ac)}
.mc{background:none;border:none;color:var(--tm);font-size:20px;cursor:pointer}.mc:hover{color:var(--tx)}
.mb{padding:18px}.mft{padding:11px 18px;border-top:1px solid var(--bd);display:flex;gap:7px;justify-content:flex-end}
.bsm{background:var(--sf3);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:13px;padding:7px 12px;border-radius:7px;cursor:pointer;transition:all .2s}
.bsm:hover{border-color:var(--ac);color:var(--ac)}
.bpr{background:var(--ac);color:#0f0f0f;border:none;font-family:'DM Sans',sans-serif;font-weight:600;font-size:13px;padding:8px 16px;border-radius:7px;cursor:pointer;transition:background .2s}
.bpr:hover{background:var(--acd)}
.bsv{flex:1;background:var(--ac);color:#0f0f0f;border:none;font-family:'DM Sans',sans-serif;font-weight:600;font-size:14px;padding:10px;border-radius:7px;cursor:pointer;transition:background .2s}
.bsv:hover{background:var(--acd)}
.bdl{background:rgba(224,92,92,.1);border:1px solid rgba(224,92,92,.3);color:var(--rd);font-family:'DM Sans',sans-serif;font-size:13px;padding:10px 13px;border-radius:7px;cursor:pointer;transition:all .2s}
.bdl:hover{background:rgba(224,92,92,.2)}

/* IMPORT */
.dz{border:2px dashed var(--bd);border-radius:10px;padding:28px;text-align:center;cursor:pointer;transition:all .2s;color:var(--tm)}
.dz:hover,.dz.dov{border-color:var(--ac);color:var(--ac);background:rgba(232,201,122,.03)}
.dz input{display:none}
.cmt{width:100%;border-collapse:collapse;margin-top:10px}
.cmt th{font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.05em;padding:4px 6px;text-align:left}
.cmt td{padding:4px 6px;border-top:1px solid var(--bd);font-size:13px}
.cmt select{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:12px;padding:3px 5px;border-radius:5px;outline:none;width:100%}
.pvt{width:100%;border-collapse:collapse;font-size:12px;margin-top:6px}
.pvt th{background:var(--sf2);padding:4px 7px;text-align:left;color:var(--tm);font-size:10px}
.pvt td{padding:4px 7px;border-top:1px solid var(--bd);color:var(--tm);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dup-warn{background:rgba(224,92,92,.08);border:1px solid rgba(224,92,92,.2);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--rd);margin-bottom:10px}
.dup-row{display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid rgba(224,92,92,.1)}
.dup-row:last-child{border:none}
.ist{display:none}.ist.active{display:block}
.sdots{display:flex;gap:6px;margin-bottom:14px}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--bd)}.sdot.active{background:var(--ac)}

/* CONFIG */
.ss{margin-bottom:20px}
.ss h3{font-size:11px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;margin-bottom:9px;padding-bottom:5px;border-bottom:1px solid var(--bd)}
.cfg-list{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:7px}
.cfg-chip{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-size:12px;padding:3px 9px;border-radius:20px;display:flex;align-items:center;gap:4px}
.cfg-chip button{background:none;border:none;color:var(--td);cursor:pointer;font-size:14px;line-height:1;padding:0}.cfg-chip button:hover{color:var(--rd)}
.cfg-add{display:flex;gap:6px}
.cfg-add input{flex:1;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:13px;padding:5px 9px;border-radius:6px;outline:none}
.cfg-add input:focus{border-color:var(--ac)}
.col-toggle-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bd)}
.col-toggle-row:last-child{border-bottom:none}
.toggle{position:relative;width:36px;height:20px;cursor:pointer}
.toggle input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{position:absolute;inset:0;background:var(--sf3);border:1px solid var(--bd);border-radius:20px;transition:all .2s}
.toggle input:checked+.toggle-track{background:var(--ac);border-color:var(--ac)}
.toggle-thumb{position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:var(--tm);transition:all .2s}
.toggle input:checked+.toggle-track+.toggle-thumb{background:#0f0f0f;transform:translateX(16px)}
.cct{width:100%;border-collapse:collapse}
.cct th{font-size:10px;color:var(--tm);text-transform:uppercase;padding:5px 7px;text-align:left;letter-spacing:.05em}
.cct td{padding:3px 7px;border-top:1px solid var(--bd);font-size:13px;vertical-align:middle}
.cct input[type=text]{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:monospace;font-size:12px;padding:3px 7px;border-radius:5px;width:56px;outline:none;text-transform:uppercase}
.cct input[type=text]:focus{border-color:var(--ac)}
.cdesc{font-size:11px;color:var(--td);margin-top:1px}
.al{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:7px}
.ach{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-size:12px;padding:3px 9px;border-radius:20px;display:flex;align-items:center;gap:4px}
.ach button{background:none;border:none;color:var(--td);cursor:pointer;font-size:14px;line-height:1;padding:0}.ach button:hover{color:var(--rd)}
.aar{display:flex;gap:5px}
.aar input{flex:1;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:13px;padding:5px 9px;border-radius:6px;outline:none}
.aar input:focus{border-color:var(--ac)}

/* REPORT */
.rg{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;padding:16px}
.sc{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:13px;transition:all .2s}
.sc.clickable{cursor:pointer}.sc.clickable:hover{border-color:var(--ac);background:var(--sf2)}
.sc .sv{font-family:'Playfair Display',serif;font-size:28px;color:var(--ac);line-height:1}
.sc .sl{font-size:11px;color:var(--tm);margin-top:3px}
.sc .sa{font-size:10px;color:var(--td);margin-top:2px}
.rs{padding:0 16px 16px}
.rs h3{font-size:11px;font-weight:600;color:var(--tm);text-transform:uppercase;letter-spacing:.06em;margin-bottom:7px;padding-bottom:5px;border-bottom:1px solid var(--bd)}
.rt{width:100%;border-collapse:collapse}
.rt th{text-align:left;font-size:10px;color:var(--td);font-weight:600;text-transform:uppercase;padding:3px 9px}
.rt td{padding:6px 9px;font-size:13px;border-top:1px solid var(--bd)}
.rt tr.rlink{cursor:pointer}.rt tr.rlink:hover td{color:var(--ac)}
.rc{display:flex;align-items:center;gap:8px;padding:12px 16px;flex-wrap:wrap}

/* POPUP */
.popup-ov{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s}
.popup-ov.open{opacity:1;pointer-events:all}
.popup{background:var(--sf);border:1px solid var(--bd);border-radius:12px;width:100%;max-width:640px;max-height:80vh;display:flex;flex-direction:column}
.popup-h{padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;gap:8px;flex-shrink:0}
.popup-title{font-family:'Playfair Display',serif;font-size:14px;color:var(--ac)}
.popup-body{overflow-y:auto;flex:1}
.popup-row{padding:9px 16px;border-bottom:1px solid var(--bd);cursor:pointer;display:flex;gap:10px;align-items:center;transition:background .15s}
.popup-row:hover{background:var(--sf2)}.popup-row:last-child{border-bottom:none}

/* COL PANEL */
.col-panel{position:absolute;top:100%;right:0;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:9px 13px;min-width:175px;z-index:150;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.col-panel-wrap{position:relative;display:inline-block}

/* AUTO-TAG */
.tag-preview{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px;max-height:120px;overflow-y:auto}
.tag-prev-row{font-size:12px;color:var(--tm);display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid var(--bd);width:100%}
.tag-prev-row:last-child{border-bottom:none}

/* AUTH */
.auth{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:14px;text-align:center;padding:20px}
.alogo{font-family:'Playfair Display',serif;font-size:32px;color:var(--ac)}
.sbox{background:var(--sf2);border:1px solid var(--bd);border-radius:12px;padding:18px;max-width:500px;width:100%;text-align:left}
.sbox h3{color:var(--ac);margin-bottom:10px;font-size:14px}
.sbox ol{color:var(--tm);font-size:13px;line-height:1.8;padding-left:16px}
.cin{width:100%;background:var(--bg);border:1px solid var(--bd);color:var(--tx);font-family:monospace;font-size:13px;padding:7px 9px;border-radius:6px;outline:none;margin-top:3px}
.cin:focus{border-color:var(--ac)}
.bgg{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);font-family:'DM Sans',sans-serif;font-size:14px;padding:11px 22px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:9px;transition:all .2s}
.bgg:hover{border-color:var(--ac);color:var(--ac)}

/* TESTS */
.test-panel{padding:16px;font-family:monospace;font-size:12px}
.tg{font-weight:600;color:var(--ac);margin:12px 0 4px;font-family:'DM Sans',sans-serif;font-size:13px}
.tr2{padding:2px 0;border-bottom:1px solid rgba(46,46,46,.5);display:flex;gap:5px;align-items:baseline}
.tp{color:var(--gr)}.tf{color:var(--rd)}

/* MISC */
.tc{display:none}.tc.active{display:block}
.spinner{width:18px;height:18px;border:2px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.lrow td{text-align:center;padding:36px;color:var(--tm)}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--sf3);border:1px solid var(--bd);color:var(--tx);padding:9px 14px;border-radius:8px;font-size:13px;z-index:999;transition:transform .3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}.toast.ok{border-color:var(--gr);color:var(--gr)}.toast.err{border-color:var(--rd);color:var(--rd)}
.ib{background:rgba(91,155,213,.07);border:1px solid rgba(91,155,213,.2);border-radius:6px;padding:7px 11px;font-size:12px;color:var(--bl);margin-bottom:11px;line-height:1.5}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--gr);display:inline-block;animation:pulse 1.4s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen" class="auth">
  <div class="alogo">StudioCRM</div>
  <p style="color:var(--tm);font-size:13px;max-width:360px;line-height:1.6;margin-bottom:16px">LilliputLand Photography ¬∑ Lead Tracker v7</p>

  <div class="sbox" style="max-width:420px;width:100%">
    <h3 style="margin-bottom:14px">üîó Connect Your Google Sheet</h3>

    <!-- Step-by-step guide -->
    <div style="background:var(--sf2);border-radius:8px;padding:12px 14px;margin-bottom:14px;font-size:12px;line-height:1.8;color:var(--tm)">
      <strong style="color:var(--tx);font-size:12px">Step-by-step for a new sheet:</strong>
      <ol style="margin:6px 0 0 16px;padding:0">
        <li>Open your Google Sheet ‚Üí look at the URL:<br><code style="background:var(--sf);padding:1px 6px;border-radius:4px;font-size:11px;color:var(--ac)">/spreadsheets/d/<strong style="color:#f07070">THIS_PART</strong>/edit</code> ‚Äî paste that below as Sheet ID</li>
        <li>Note the <strong style="color:var(--tx)">exact tab name</strong> at the bottom of the sheet (e.g. <em>"January Leads"</em> not <em>"Leads"</em>) ‚Äî paste it below as Tab Name</li>
        <li>Make sure your Google account has <strong style="color:var(--tx)">Editor access</strong> to the sheet</li>
        <li>Paste your OAuth Client ID ‚Äî or use the LilliputLand default if already configured</li>
      </ol>
    </div>

    <label style="font-size:11px;color:var(--tm)">Google OAuth Client ID</label>
    <input class="cin" id="cfgCid" placeholder="xxxx.apps.googleusercontent.com">

    <label style="font-size:11px;color:var(--tm);margin-top:9px;display:block">Sheet ID <span style="color:var(--td)">(from URL)</span></label>
    <input class="cin" id="cfgSid" placeholder="1pU5bp7J4nEYlg‚Ä¶" oninput="updateTabHint()">

    <label style="font-size:11px;color:var(--tm);margin-top:9px;display:block">Tab Name <span style="color:var(--td)">(exact, case-sensitive)</span></label>
    <input class="cin" id="cfgSname" placeholder="e.g. January Leads" oninput="updateTabHint()">
    <div id="tabHint" style="font-size:11px;color:var(--td);margin-top:4px;min-height:16px"></div>

    <div style="display:flex;flex-direction:column;gap:7px;margin-top:14px">
      <button class="bgg" onclick="initAuth()">
        <svg width="17" height="17" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.31z"/></svg>
        Sign in with Google &amp; Load Sheet
      </button>
      <button class="bsm" style="text-align:center" onclick="loadDemo()">üß™ Demo Mode (no sign-in needed)</button>
    </div>

    <!-- Common errors quick reference -->
    <div style="margin-top:16px;border-top:1px solid var(--bd);padding-top:12px">
      <div style="font-size:11px;color:var(--tm);font-weight:600;margin-bottom:6px">Common errors:</div>
      <div style="font-size:11px;color:var(--td);line-height:1.9">
        <span style="color:#f07070">400</span> ‚Äî Wrong Tab Name (check case &amp; spelling)<br>
        <span style="color:#f07070">403</span> ‚Äî Sheet not shared with your Google account<br>
        <span style="color:#f07070">404</span> ‚Äî Wrong Sheet ID<br>
        <span style="color:#f07070">No leads shown</span> ‚Äî Tab Name is correct but sheet is empty or has different columns
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="appScreen" style="display:none">
  <div class="header">
    <div class="logo">StudioCRM <em id="syncStatus"></em></div>
    <div class="tabs">
      <button class="tb active" onclick="switchTab('active')">Active Leads</button>
      <button class="tb" onclick="switchTab('closed')">Closed</button>
      <button class="tb" onclick="switchTab('archive')">üóÉ Archive</button>
      <button class="tb" onclick="switchTab('report')">Daily Report</button>
      <button class="tb" onclick="switchTab('tests')" style="color:var(--pu)">üß™ Tests</button>
    </div>
    <div class="hact">
      <!-- Pipeline selector -->
      <div class="pipeline-wrap" id="pipelineWrap" style="display:none">
        <select class="pipeline-sel" id="pipelineSel" onchange="switchPipeline(this.value)" title="Switch pipeline"></select>
        <button class="bi" onclick="bookmarkPipeline()" title="Copy bookmark URL for this pipeline">üîñ</button>
      </div>
      <div class="col-panel-wrap" id="colPanelWrap">
        <button class="bi" onclick="toggleColPanel()">‚äû Columns</button>
        <div class="col-panel" id="colPanel" style="display:none">
          <div style="font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px">Show / Hide Columns</div>
          <div id="colToggles"></div>
        </div>
      </div>
      <button class="bi" onclick="openImport()">‚¨Ü Import</button>
      <button class="bi" onclick="openSettings()">‚öô Settings</button>
      <button class="btnadd" onclick="openPanel(null)">+ Add Lead</button>
    </div>
  </div>

  <!-- YOU ARE BAR ‚Äî persistent agent selector -->
  <div class="ya-bar" id="yaBar">
    <span>üë§ You are:</span>
    <select id="yaAgent" onchange="setActiveAgent(this.value)">
      <option value="">‚Äî Select your name ‚Äî</option>
    </select>
    <span class="ya-hint" id="yaHint"></span>
  </div>

  <!-- OVERDUE ALERT BANNER -->
  <div class="alert-bar hidden" id="alertBar">
    <span style="font-size:12px;font-weight:600;color:var(--rd)">‚ö† FU Alerts:</span>
    <button class="alert-pill" id="alertOverdue" onclick="alertFilter('overdue')"></button>
    <button class="alert-pill or" id="alertToday" onclick="alertFilter('today')"></button>
    <button class="alert-dismiss" onclick="document.getElementById('alertBar').classList.add('hidden')" title="Dismiss">√ó</button>
  </div>

  <!-- QUICK CALL MODE BAR -->
  <div class="qcm-bar" id="qcmBar">
    <span class="qcm-info">üìû Quick Call Mode</span>
    <span class="qcm-prog" id="qcmProg"></span>
    <button class="qcm-next" onclick="qcmNext()">Next Lead ‚Üí</button>
    <button class="qcm-exit" onclick="qcmExit()">Exit</button>
  </div>

  <!-- FILTER BARS -->
  <div class="fbar" id="filterBar">
    <input class="fi" id="fSearch" placeholder="Name or phone‚Ä¶" style="width:130px" oninput="applyFilters()">
    <select class="fs" id="fAgent" onchange="applyFilters()"><option value="">All Agents</option></select>
    <select class="fs" id="fSource" onchange="applyFilters()">
      <option value="">All Sources</option>
    </select>
    <select class="fs" id="fShoot" onchange="applyFilters()"><option value="">All Shoots</option></select>
    <select class="fs" id="fTag" onchange="applyFilters()">
      <option value="">All Statuses</option>
      <option value="booked">üü¢ Booked</option><option value="done">üèÜ Shoot Done</option>
      <option value="int">üîµ Interested</option><option value="warm">üü° Warm</option>
      <option value="nore">üü† No Response</option><option value="cold">üî¥ Cold</option>
      <option value="oop">üü£ Out of Area</option><option value="inv">‚ö´ Invalid</option><option value="new">‚¨ú New</option>
    </select>
    <select class="fs" id="fFU" onchange="applyFilters()">
      <option value="">All FU Stages</option>
      <option value="new">New ‚Äî no contact yet</option>
      <option value="fu1done">Callback pending</option>
      <option value="fu2done">Warm FU pending</option>
      <option value="fu3done">Final FU pending</option>
    </select>
    <button class="chip or" id="btnOverdue" onclick="toggleChip('overdue')">üî¥ Overdue</button>
    <button class="chip or" id="btnDue" onclick="toggleChip('due')">üîî Due Today</button>
    <button class="chip pu" id="btnNN" onclick="toggleChip('nn')">üë§ No Name</button>
    <button class="bclr" onclick="clearFilters()">Clear</button>
    <span class="fcnt" id="filterCount"></span>
    <button class="bexp" onclick="exportFiltered('active')" title="Export filtered leads as CSV">‚¨á CSV</button>
    <button class="bi" onclick="startQCM()" title="Quick Call Mode ‚Äî work through leads one by one" style="margin-left:2px">üìû Call Queue</button>
  </div>
  <!-- BULK ACTIONS -->
  <div class="bulk-bar" id="bulkBar">
    <span class="bulk-info" id="bulkInfo">0 selected</span>
    <select class="bulk-assign" id="bulkAgent" onchange="bulkAssign()"><option value="">Assign Agent‚Ä¶</option></select>
    <button class="bsm" onclick="bulkClear()">Clear Selection</button>
  </div>
  <!-- DATE FILTER ROW -->
  <div class="fbar2" id="filterBar2">
    <span class="drl">üìÖ Date Added:</span>
    <button class="date-chip" id="dc0" onclick="setDatePreset('today')">Today</button>
    <button class="date-chip" id="dc1" onclick="setDatePreset('yesterday')">Yesterday</button>
    <button class="date-chip" id="dc2" onclick="setDatePreset('2days')">2 Days Ago</button>
    <button class="date-chip" id="dc3" onclick="setDatePreset('3days')">3 Days Ago</button>
    <button class="date-chip" id="dc4" onclick="setDatePreset('week')">This Week</button>
    <button class="date-chip" id="dc5" onclick="setDatePreset('month')">This Month</button>
    <input type="date" class="fs" id="fDateFrom" onchange="setDatePreset('custom')" style="width:130px">
    <span class="drl" style="font-size:11px">‚Äì</span>
    <input type="date" class="fs" id="fDateTo" onchange="setDatePreset('custom')" style="width:130px">
    <button class="date-chip" onclick="setDatePreset('clear')">All Dates</button>
  </div>

  <div>
    <!-- ACTIVE LEADS -->
    <div class="tc active" id="tab-active">
      <table class="lt" id="activeTable">
        <thead><tr>
          <th class="chk"><input type="checkbox" id="chkAll" onchange="toggleAllChk(this.checked)" style="cursor:pointer"></th>
          <th>Lead</th>
          <th class="col-tag">Status</th>
          <th class="col-shoot">Shoot</th>
          <th class="col-source">Source</th>
          <th class="col-location">Location</th>
          <th class="col-babyage">Baby Age</th>
          <th>FU Stage</th>
          <th class="col-agent">Agent</th>
          <th>Last Note</th><th>Next FU</th><th>Added</th>
        </tr></thead>
        <tbody id="leadsBody"><tr class="lrow"><td colspan="12"><div class="spinner"></div></td></tr></tbody>
      </table>
    </div>
    <!-- CLOSED -->
    <div class="tc" id="tab-closed">
      <div style="padding:7px 16px;border-bottom:1px solid var(--bd);display:flex;gap:6px;align-items:center">
        <span style="font-size:12px;color:var(--tm)">Closed Leads</span>
        <button class="bexp" onclick="exportFiltered('closed')">‚¨á CSV</button>
      </div>
      <table class="lt" id="closedTable">
        <thead><tr>
          <th>Lead</th>
          <th class="col-tag">Status</th>
          <th class="col-shoot">Shoot</th>
          <th class="col-agent">Agent</th>
          <th>Final Note</th><th>Added</th>
        </tr></thead>
        <tbody id="closedBody"><tr class="lrow"><td colspan="7"><div class="spinner"></div></td></tr></tbody>
      </table>
    </div>
    <!-- ARCHIVE TAB -->
    <div class="tc" id="tab-archive">
      <div style="padding:10px 18px;display:flex;align-items:center;gap:10px;background:var(--sf);border-bottom:1px solid var(--bd);flex-wrap:wrap">
        <span style="font-size:13px;color:var(--tm)">Archived leads ‚Äî read only</span>
        <input class="fi" id="archiveSearch" placeholder="Search‚Ä¶" style="width:140px" oninput="renderArchive()">
        <button class="bexp" onclick="exportFiltered('archive')">‚¨á Export</button>
        <button class="bsm" onclick="openSettings()" style="margin-left:auto">‚öô Archive Settings</button>
      </div>
      <table class="lt" id="archiveTable">
        <thead><tr>
          <th>Lead</th><th>Shoot</th><th>Agent</th><th>Tag</th><th>Last Note</th><th>Added</th><th>Age</th>
        </tr></thead>
        <tbody id="archiveBody"><tr><td colspan="8" style="text-align:center;padding:30px;color:var(--tm)">No archived leads</td></tr></tbody>
      </table>
    </div>
    <!-- REPORT TAB -->
    <div class="tc" id="tab-report">
      <div class="rc" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--bd)">
        <label style="font-size:12px;color:var(--tm);font-weight:600">üìä Time Range:</label>
        <button class="date-chip" id="rp-today" onclick="setReportRange('today')">Today</button>
        <button class="date-chip" id="rp-yesterday" onclick="setReportRange('yesterday')">Yesterday</button>
        <button class="date-chip" id="rp-week" onclick="setReportRange('week')">This Week</button>
        <button class="date-chip" id="rp-month" onclick="setReportRange('month')">This Month</button>
        <button class="date-chip" id="rp-7d" onclick="setReportRange('7d')">Last 7 Days</button>
        <button class="date-chip" id="rp-30d" onclick="setReportRange('30d')">Last 30 Days</button>
        <span style="color:var(--td);margin:0 6px">or</span>
        <input type="date" class="fs" id="reportFrom" style="width:130px" onchange="setReportRange('custom')">
        <span style="color:var(--tm)">to</span>
        <input type="date" class="fs" id="reportTo" style="width:130px" onchange="setReportRange('custom')">
        <button class="bpr" onclick="renderReport()" style="margin-left:auto">üîÑ Refresh</button>
        <button class="bexp" onclick="exportReport()">‚¨á Export CSV</button>
      </div>
      
      <div class="rg" id="reportStats"></div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(480px,1fr));gap:16px;padding:16px">
        <!-- Agent Workload -->
        <div class="rs" id="reportAgentWorkload"></div>
        
        <!-- Source Performance -->
        <div class="rs" id="reportSourcePerf"></div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr;gap:16px;padding:0 16px 16px">
        <!-- Lead Quality Metrics -->
        <div class="rs" id="reportQuality"></div>
        
        <!-- FU Activity Breakdown -->
        <div class="rs" id="reportByFU"></div>
      </div>
    </div>
    <!-- TESTS -->
    <div class="tc" id="tab-tests">
      <div style="padding:16px 16px 7px;display:flex;gap:9px;align-items:center;flex-wrap:wrap">
        <button class="bpr" onclick="runTests()">‚ñ∂ Run All Tests</button>
        <span style="color:var(--tm);font-size:13px" id="testSummary"></span>
      </div>
      <div class="test-panel" id="testOutput"></div>
    </div>
  </div>
</div>

<!-- LEAD PANEL -->
<div class="pov" id="pov" onclick="closePanel()"></div>
<div class="sp" id="sp">
  <div class="ph">
    <div class="pt" id="panelTitle">New Lead</div>
    <span class="badge badge-tag ph-tag" id="panelTagBadge" style="display:none"></span>
    <div class="ph-nav" id="panelNav" style="display:none">
      <button onclick="qcmPrev()" id="btnPrev">‚Üê Prev</button>
      <span id="qcmCount" style="font-size:11px;color:var(--tm)"></span>
      <button onclick="qcmNext()" id="btnNext">Next ‚Üí</button>
    </div>
    <button class="pc" onclick="closePanel()">√ó</button>
  </div>
  <div class="pb">
    <div class="pbl">
      <input type="hidden" id="pRI">
      <div class="sdiv" style="margin-top:0">Lead Info</div>
      <div class="fr2">
        <div class="fg"><label class="fl">Name</label><input class="fi2" id="pName" placeholder="Client name"></div>
        <div class="fg">
          <label class="fl">Phone *</label>
          <div style="display:flex;gap:4px;align-items:center">
            <input class="fi2" id="pPhone" placeholder="+91 98765‚Ä¶" style="flex:1">
            <button class="wa-btn" id="waBtn" onclick="openWA()" title="Open in WhatsApp" style="display:none">üí¨</button>
          </div>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Agent</label><select class="fs2" id="pAgent"></select></div>
        <div class="fg"><label class="fl">Source</label>
          <select class="fs2" id="pSource"><option value="">Select‚Ä¶</option></select>
        </div>
      </div>
      <div class="fr2">
        <div class="fg"><label class="fl">Location</label><input class="fi2" id="pLoc" placeholder="Area in Pune"></div>
        <div class="fg"><label class="fl">Baby Age</label><input class="fi2" id="pAge" placeholder="e.g. 3 months"></div>
      </div>
      <div class="fg">
        <label class="fl">Shoot Type</label>
        <div class="og" id="shootOpts"></div>
        <input type="hidden" id="pShoot">
      </div>
      <div class="fg" style="flex:1">
        <label class="fl">General Notes</label>
        <textarea class="fi2" id="pNotes" style="height:100%;min-height:48px" placeholder="Notes‚Ä¶"></textarea>
      </div>
    </div>
    <div class="pbr">
      <div class="sdiv" style="margin-top:0">Follow-up Timeline</div>
      <div class="fu-stepper">
        <div class="fus" id="fu1b">
          <div class="fus-head"><div class="fus-title" id="fu1label">üìû Initial Contact</div><div class="fus-num">FU 1</div></div>
          <div class="fus-row">
            <div class="fus-date"><span>Date</span><input type="date" id="p1d" onchange="unlockFU()"></div>
            <div class="fus-note"><textarea id="p1n" placeholder="Notes / outcome‚Ä¶" oninput="unlockFU()"></textarea></div>
          </div>
          <div class="og" id="fu1Opts"></div><input type="hidden" id="p1s">
        </div>
        <div class="fus locked" id="fu2b">
          <div class="fus-head"><div class="fus-title" id="fu2label">üîÅ Callback</div><div class="fus-num">FU 2</div></div>
          <div class="fus-row">
            <div class="fus-date"><span>Date</span><input type="date" id="p2d" onchange="unlockFU()"></div>
            <div class="fus-note"><textarea id="p2n" placeholder="Notes / outcome‚Ä¶" oninput="unlockFU()"></textarea></div>
          </div>
          <div class="og" id="fu2Opts"></div><input type="hidden" id="p2s">
        </div>
        <div class="fus locked" id="fu3b">
          <div class="fus-head"><div class="fus-title" id="fu3label">üå°Ô∏è Warm Follow-up</div><div class="fus-num">FU 3</div></div>
          <div class="fus-row">
            <div class="fus-date"><span>Date</span><input type="date" id="p3d" onchange="unlockFU()"></div>
            <div class="fus-note"><textarea id="p3n" placeholder="Notes / outcome‚Ä¶" oninput="unlockFU()"></textarea></div>
          </div>
          <div class="og" id="fu3Opts"></div><input type="hidden" id="p3s">
        </div>
        <div class="fus locked" id="fu4b">
          <div class="fus-head"><div class="fus-title" id="fu4label">üèÅ Final Follow-up</div><div class="fus-num">FU 4</div></div>
          <div class="fus-row">
            <div class="fus-date"><span>Date</span><input type="date" id="p4d"></div>
            <div class="fus-note"><textarea id="p4n" placeholder="Notes / outcome‚Ä¶"></textarea></div>
          </div>
          <div class="og" id="fu4Opts"></div><input type="hidden" id="p4s">
        </div>
      </div>
    </div>
  </div>
  <div class="pf">
    <button class="bdl" id="btnDel" onclick="deleteLead()" style="display:none">Delete</button>
    <button class="bsv" onclick="saveLead()">Save to Sheet</button>
  </div>
</div>

<!-- REPORT POPUP -->
<div class="popup-ov" id="popupOv" onclick="closePopup()">
  <div class="popup" onclick="event.stopPropagation()">
    <div class="popup-h">
      <div class="popup-title" id="popupTitle">Leads</div>
      <button class="bexp" onclick="exportPopupList()" style="margin-left:auto">‚¨á CSV</button>
      <button class="mc" onclick="closePopup()">√ó</button>
    </div>
    <div class="popup-body" id="popupBody"></div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="mov" id="importMov">
  <div class="modal md">
    <div class="mh"><div class="mt">Import CSV</div><button class="mc" onclick="closeImport()">√ó</button></div>
    <div class="mb">
      <div class="sdots"><div class="sdot active" id="sd1"></div><div class="sdot" id="sd2"></div><div class="sdot" id="sd3"></div><div class="sdot" id="sd4"></div></div>
      <div class="ist active" id="ist1">
        <div class="ib">CSV with any column order. Numbers-only CSVs fine ‚Äî names added later.</div>
        <div class="dz" id="dz" onclick="document.getElementById('csvIn').click()" ondragover="dvr(event)" ondragleave="dvl()" ondrop="ddrop(event)">
          <input type="file" id="csvIn" accept=".csv,.txt" onchange="fsel(event)">
          <div style="font-size:26px;margin-bottom:5px">üìÇ</div>
          <div style="font-size:14px;margin-bottom:2px">Drop CSV here or click to browse</div>
          <div style="font-size:11px;color:var(--td)">.csv and .txt supported</div>
        </div>
      </div>
      <div class="ist" id="ist2">
        <div class="ib" id="iinfo"></div>
        <p style="font-size:13px;color:var(--tm);margin-bottom:9px">Map each column to a CRM field.</p>
        <div style="overflow-x:auto"><table class="cmt"><thead><tr><th>CSV Column</th><th>Sample</th><th>Maps To</th></tr></thead><tbody id="cmb"></tbody></table></div>
      </div>
      <div class="ist" id="ist3">
        <div id="dupWarn"></div>
        <div id="iprev" style="font-size:13px;color:var(--tm);margin-bottom:9px"></div>
        <div style="overflow-x:auto;border:1px solid var(--bd);border-radius:6px"><table class="pvt"><thead id="pvh"></thead><tbody id="pvb"></tbody></table></div>
        <p style="font-size:11px;color:var(--td);margin-top:7px">All rows imported with today's date. Agent blank ‚Äî assign later.</p>
      </div>
      <div class="ist" id="ist4">
        <div style="text-align:center;padding:20px;color:var(--gr);font-size:32px">‚úì</div>
        <div id="importResult" style="text-align:center;color:var(--tm);font-size:14px"></div>
      </div>
    </div>
    <div class="mft">
      <button class="bsm" id="iback" onclick="istep(-1)" style="display:none">‚Üê Back</button>
      <button class="bpr" id="inext" onclick="istep(1)">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="mov" id="settingsMov">
  <div class="modal lg">
    <div class="mh"><div class="mt">‚öô Settings</div><button class="mc" onclick="closeSettings()">√ó</button></div>
    <div class="mb">

      <!-- AUTO-TAG BACKFILL -->
      <div class="ss">
        <h3>üè∑ Auto-Tag from Notes <span class="sh">(fills blank tags only)</span></h3>
        <p class="sp">Derives a tag from each lead's latest FU note. Only fills leads where Tag is blank. Tags are also auto-set on every Save going forward.</p>
        <button class="bpr" onclick="autoTagPreview()">Preview Tags</button>
        <div id="tagPreview" style="margin-top:10px"></div>
        <button class="bsm" id="btnRunTag" onclick="runAutoTag()" style="display:none;margin-top:6px">Apply Tags to Sheet</button>
      </div>

      <!-- SOURCES -->
      <div class="ss">
        <h3>üì≤ Lead Sources <span class="sh">(synced to Config)</span></h3>
        <div class="cfg-list" id="sourceList"></div>
        <div class="cfg-add">
          <input id="newSourceInput" placeholder="Add source‚Ä¶ e.g. Incoming Call" onkeydown="if(event.key==='Enter')addSource()">
          <button class="bsm" onclick="addSource()">+ Add</button>
        </div>
      </div>

      <!-- CUSTOM TAGS -->
      <div class="ss">
        <h3>üé® Tag List <span class="sh">(add custom tags ‚Äî mapped to colors by keyword)</span></h3>
        <p class="sp">Tags shown in the panel and filter. Color is auto-assigned based on keywords (Booked=green, Cold=red, etc). Custom tags default to teal.</p>
        <div class="cfg-list" id="customTagList"></div>
        <div class="cfg-add">
          <input id="newTagInput" placeholder="Add tag‚Ä¶ e.g. Pricing Shared" onkeydown="if(event.key==='Enter')addCustomTag()">
          <button class="bsm" onclick="addCustomTag()">+ Add</button>
        </div>
      </div>

      <!-- SHOOT TYPES -->
      <div class="ss">
        <h3>üì∑ Shoot Types <span class="sh">(synced to Config)</span></h3>
        <div class="cfg-list" id="shootList"></div>
        <div class="cfg-add">
          <input id="newShootInput" placeholder="Add shoot type‚Ä¶" onkeydown="if(event.key==='Enter')addShootType()">
          <button class="bsm" onclick="addShootType()">+ Add</button>
        </div>
      </div>

      <!-- AGENTS -->
      <div class="ss">
        <h3>üë• Agents</h3>
        <p class="sp">Add agents by name. Email is optional ‚Äî used to match against the Settings Sheet for future use.</p>
        <div class="al" id="agentList"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:6px;align-items:end;margin-top:8px">
          <div class="fg"><label class="fl">Name</label><input id="naInput" class="fi2" placeholder="e.g. Sapna" onkeydown="if(event.key==='Enter')addAgent()"></div>
          <div class="fg"><label class="fl">Email <span style="color:var(--td);font-weight:400">(optional)</span></label><input id="naEmail" class="fi2" placeholder="sapna@gmail.com" type="email"></div>
          <button class="bpr" onclick="addAgent()" style="align-self:end">+ Add</button>
        </div>
      </div>

      <!-- FU LABELS + PER-STAGE OUTCOMES -->
      <div class="ss">
        <h3>üìã Follow-up Stage Names &amp; Outcomes <span class="sh">(synced to Config)</span></h3>
        <p class="sp">Each stage has its own outcome buttons. Outcome buttons set the lead's <strong>Tag</strong>; the notes field is for free-text comments.</p>
        <div id="fuStageSettings"></div>
        <button class="bsm" style="margin-top:8px" onclick="saveFUConfig()">Save All FU Settings</button>
      </div>

      <!-- ARCHIVE -->
      <div class="ss">
        <h3>üóÉ Archive Old Leads <span class="sh">(moves to Archive tab ‚Äî read-only)</span></h3>
        <p class="sp">Archive leads where <strong>Date Added</strong> is more than <input id="archiveDaysInput" type="number" min="1" max="365" value="60" style="width:48px;font-family:inherit;background:var(--sf2);border:1px solid var(--bd);color:var(--tx);padding:2px 6px;border-radius:4px;font-size:12px"> days ago AND no future follow-up date is set.</p>
        <button class="bpr" onclick="previewArchive()" style="background:rgba(100,100,100,.15);color:var(--tm);border:1px solid var(--bd)">Preview Archiveable Leads</button>
        <div id="archivePreview" style="margin-top:8px"></div>
        <button class="bsm" id="btnRunArchive" onclick="runArchive()" style="display:none;margin-top:6px;background:rgba(224,92,92,.1);color:var(--rd);border-color:rgba(224,92,92,.3)">Archive These Leads</button>
      </div>

      <!-- MULTI-ACCOUNT ACCESS -->
      <div class="ss">
        <h3>üë§ Multi-Account Access <span class="sh">(how to share with agents)</span></h3>
        <div style="font-size:12px;color:var(--tm);line-height:1.8">
          <p><strong style="color:var(--tx)">Option 1 ‚Äî Share Sheet directly (easiest, up to ~10 users):</strong><br>
          Open your Google Sheet ‚Üí Share ‚Üí add each agent's Gmail address as an Editor. They sign into this CRM with their own Google account. Each agent sees their own name in the auth prompt.</p>
          <p><strong style="color:var(--tx)">Option 2 ‚Äî One shared studio account:</strong><br>
          Create a single Gmail like <code style="background:var(--sf2);padding:1px 5px;border-radius:3px">lilliputland.studio@gmail.com</code>. All agents use those credentials. Simple but no per-agent audit trail.</p>
          <p><strong style="color:var(--tx)">Option 3 ‚Äî Google Apps Script Web App (recommended for 5+ agents):</strong><br>
          This removes the need for agents to have Sheet access entirely. The app runs as the owner. Agents open a URL ‚Äî no OAuth needed. Contact your developer to set this up, or ask for the companion <code>.gs</code> script.</p>
          <p style="color:var(--td);font-size:11px">‚ö° For LilliputLand: Option 1 is recommended right now. Go to your sheet ‚Üí Share ‚Üí add each agent's Gmail ‚Üí set to Editor.</p>
        </div>
      </div>

      <!-- PIPELINES -->
      <div class="ss">
        <h3>üìÇ Pipelines <span class="sh">(one per agent / per sheet)</span></h3>
        <p class="sp">Each pipeline is a separate Google Sheet tab. Add bookmarkable URLs per pipeline so each agent opens their own view directly.</p>
        <div id="pipelineList" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:6px;align-items:end">
          <div class="fg"><label class="fl">Pipeline Name</label><input class="fi2" id="newPipeName" placeholder="e.g. Sapna"></div>
          <div class="fg"><label class="fl">Sheet ID</label><input class="fi2" id="newPipeSheet" placeholder="Google Sheet ID"></div>
          <button class="bpr" onclick="addPipeline()" style="align-self:end">Add</button>
        </div>
        <div class="fg" style="margin-top:6px"><label class="fl">Tab Name (same for all)</label><input class="fi2" id="newPipeTab" placeholder="Leads" value="Leads"></div>
      </div>

      <!-- SETTINGS SHEET -->
      <div class="ss">
        <h3>‚òÅ Settings Sheet <span class="sh">(share config across devices)</span></h3>
        <p class="sp">Store agents, shoot types, FU labels, and pipelines in a dedicated Google Sheet. All devices stay in sync. Create a new blank sheet and paste the ID below.</p>
        <div class="fg"><label class="fl">Settings Sheet ID</label>
          <input class="fi2" id="settingsSheetId" placeholder="Paste Settings Sheet ID here" style="font-family:monospace;font-size:11px">
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <button class="bpr" onclick="saveSettingsSheet()">Save &amp; Sync Now</button>
          <button class="bsm" onclick="pushSettingsToCloud()">‚¨Ü Push to Sheet</button>
          <button class="bsm" onclick="pullSettingsFromCloud()">‚¨á Pull from Sheet</button>
        </div>
        <p style="font-size:10px;color:var(--td);margin-top:7px" id="settingsSyncStatus"></p>
      </div>

      <!-- COLUMN MAPPING -->
      <div class="ss">
        <h3>üìä Column Mapping</h3>
        <p class="sp">Map CRM fields to your sheet columns. These are saved to your Settings Sheet and carried across connections.</p>
        <table class="cct"><thead><tr><th>CRM Field</th><th>Col</th><th></th></tr></thead><tbody id="ccb"></tbody></table>
        <button class="bpr" style="margin-top:10px" onclick="saveColMap()">Save Mapping</button>
      </div>

      <!-- CONNECTION (legacy single-sheet) -->
      <div class="ss">
        <h3>üîó Sheet Connection</h3>
        <p class="sp">Change which sheet you're reading leads from. The Tab Name must match <strong>exactly</strong> ‚Äî check the tab at the bottom of your Google Sheet.</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
          <div class="fg"><label class="fl">Sheet ID <span style="color:var(--td);font-weight:400">(from URL)</span></label><input class="fi2" id="ssi" style="font-family:monospace;font-size:11px" oninput="updateConnHint()"></div>
          <div class="fg"><label class="fl">Tab Name <span style="color:var(--td);font-weight:400">(exact)</span></label><input class="fi2" id="ssn" oninput="updateConnHint()"></div>
        </div>
        <div id="connHint" style="font-size:11px;color:var(--td);margin:5px 0 8px;min-height:14px"></div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="bpr" onclick="saveConn()">Save &amp; Reload</button>
          <button class="bsm" onclick="testConnection()">üîç Test Connection</button>
          <button class="bsm" onclick="listTabs()">üìã List Available Tabs</button>
        </div>
        <div id="tabList" style="margin-top:8px;font-size:12px;color:var(--tm)"></div>
      </div>

      <!-- AUDIT TRAIL -->
      <div class="ss">
        <h3>üìã Audit Trail <span class="sh">(7-day rolling log)</span></h3>
        <p class="sp">Logs every lead save, delete, tag change, and agent assignment. Stored in the <strong>Audit</strong> tab of your Settings Sheet. Auto-fills the submitting agent from your "You are" selection.</p>
        <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;align-items:center">
          <button class="bsm" onclick="renderAuditLog()">üîÑ Refresh</button>
          <button class="bsm" onclick="pruneAudit()" style="color:var(--rd);border-color:rgba(224,92,92,.3)">üóë Clear entries older than 7 days</button>
          <span id="auditStatus" style="font-size:11px;color:var(--td)"></span>
        </div>
        <div id="auditLog" style="max-height:320px;overflow-y:auto;border:1px solid var(--bd);border-radius:7px">
          <div class="audit-row audit-hdr">
            <span>Time</span><span>Agent</span><span>Action</span><span>Lead</span>
          </div>
          <div id="auditBody" style="color:var(--tm);font-size:12px;padding:20px;text-align:center">Click Refresh to load</div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let SHEET_ID='1pU5bp7J4nEYlgUkl-0RevfPFwHIJLlA09KYQ-hZhvz8';
let SHEET_NAME='Leads';let CLIENT_ID='';let demoMode=false;
let SETTINGS_SHEET_ID='';
let PIPELINES=[];
let ACTIVE_PIPELINE=0;
let ACTIVE_AGENT='';   // Currently selected agent ‚Äî persisted in localStorage
let leads=[],filtered=[],chips={due:false,overdue:false,nn:false};
let selectedRis=new Set();
let csvD=null,csvStep=1;
let qcmQueue=[],qcmIdx=0,qcmActive=false;
let popupCurrentRis=[];
let activeDatePreset='';

let CM={
  'Date Added':'A','Source':'B','Name':'C','Phone':'D','Shoot Type':'E',
  'Location':'F','Baby Age':'G','Agent':'H','FU1 Date':'I','FU1 Notes':'J',
  'General Notes':'K','FU2 Date':'L','FU2 Notes':'M','FU3 Date':'N',
  'FU3 Notes':'O','FU4 Date':'P','FU4 Notes':'Q','Tag':'R','Stage':'S'
};
const FIELDS=Object.keys(CM);
const FDESC={'Date Added':'col A','Source':'col B','Name':'col C','Phone':'col D','Shoot Type':'col E','Location':'col F','Baby Age':'col G','Agent':'col H','FU1 Date':'col I','FU1 Notes':'col J','General Notes':'col K','FU2 Date':'col L','FU2 Notes':'col M','FU3 Date':'col N','FU3 Notes':'col O','FU4 Date':'col P','FU4 Notes':'col Q','Tag':'col R','Stage':'col S'};

let CFG={
  shootTypes:['Newborn','Milestone','Pre Birthday Shoot','Birthday / Cake Smash','Kids','Maternity','Family'],
  agents:['Rajshree','Rashmi','Ravi','Priya','Manager'],
  agentEmails:{},  // {agentName: emailString} ‚Äî optional per agent
  fuLabels:['Initial Contact','Callback','Warm Follow-up','Final Follow-up'],
  sources:['Whatsapp','Instagram','Facebook','Google','Referral','Incoming Call','Walk-in','JustDial'],
  customTags:['Booked','Shoot Done','Interested','Warm','No Response','Cold','Out of Area','Invalid','New'],
  fuOutcomes:[
    ['Interested','No Response','Not Interested','Budget Issue','Out of Area','Future Plan','Sent Package Details','Call Later','Booked','Invalid Number'],
    ['Still Interested','Sent Package Details','No Response','Budget Issue','Not Interested','Booked','Cancelled','Call Later'],
    ['No Response','Confirmed Date','Lost Lead','Booked','Rescheduled'],
    ['Booked','Lost Lead','No Response','Shoot Done','Cancelled']
  ],
  archiveDays:60
};

const SW={'Newborn':14,'Milestone':45,'Pre Birthday Shoot':30,'Birthday / Cake Smash':7,'Kids':365,'Maternity':84,'Family':365};

// ‚îÄ‚îÄ SHOOT TYPE CLASSIFIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Rules: 0-1m=Newborn, 2-6m=Milestone, 7-10m=Pre Birthday, 11-13m=Birthday/CakeSmash
// 14m+=Kids (unless notes say "family"‚ÜíFamily), maternity keyword‚ÜíMaternity
function classifyShootType(rawAge, notes=''){
  if(!rawAge)return'';
  const s=rawAge.trim().toLowerCase();
  const n=(notes||'').toLowerCase();
  // Maternity ‚Äî check both age field and notes
  if(/mat|mater|matern|pregnancy/.test(s)||s==='mat'||n.includes('maternity'))return'Maternity';
  if(/mat|mater|matern/.test(n)&&!rawAge)return'Maternity';
  // Newborn keyword
  if(s==='nb'||s.includes('newborn')||s.includes('new born'))return'Newborn';
  // Days old
  const dm=s.match(/(\d+)\s*days?/);
  if(dm){const d=parseInt(dm[1]);return d<=45?'Newborn':'Milestone';}
  // Parse months
  const ym=s.match(/(\d+(?:\.\d+)?)\s*(?:y(?:r?s?|ear?s?))/);
  const mm=s.match(/(\d+(?:\.\d+)?)\s*(?:m(?:o(?:n(?:th?s?)?)?)?h?)(?![a-z])/);
  let months=null;
  if(ym&&!mm) months=parseFloat(ym[1])*12;
  else if(mm&&!ym) months=parseFloat(mm[1]);
  else if(ym&&mm) months=Math.min(parseFloat(mm[1]),parseFloat(ym[1])*12);
  else{
    // Pure number ‚Äî try first token only
    const nm=s.split(/[\/&,\s]/)[0].match(/^(\d+(?:\.\d+)?)$/);
    if(nm){const v=parseFloat(nm[1]);months=v<=24?v:v*12;}
  }
  if(months===null)return'';
  if(months<=1)  return'Newborn';
  if(months<=6)  return'Milestone';
  if(months<11)  return'Pre Birthday Shoot';
  if(months<14)  return'Birthday / Cake Smash';
  // 14m+ ‚Äî Kids unless notes explicitly say "family shoot"
  if(n.includes('family shoot')||n.includes('family package'))return'Family';
  return'Kids';
}

// ‚îÄ‚îÄ TAG SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Built-in tag definitions ‚Äî colors keyed to semantic meaning
const TAG_DEFS={
  booked:    {label:'Booked',       emoji:'üü¢',dot:'dg', badge:'btag-booked',    row:'row-booked',    bg:'rgba(76,175,125,.18)',  color:'#4cde96', border:'rgba(76,175,125,.4)'},
  done:      {label:'Shoot Done',   emoji:'üèÜ',dot:'dgo',badge:'btag-done',      row:'row-done',      bg:'rgba(232,201,60,.22)', color:'#f0d050', border:'rgba(232,201,60,.5)'},
  interested:{label:'Interested',   emoji:'üîµ',dot:'db', badge:'btag-interested',row:'row-interested',bg:'rgba(91,155,213,.18)', color:'#7ab3e8', border:'rgba(91,155,213,.4)'},
  warm:      {label:'Warm',         emoji:'ü©µ',dot:'dt', badge:'btag-warm',      row:'row-warm',      bg:'rgba(56,210,190,.15)', color:'#38d2be', border:'rgba(56,210,190,.4)'},
  noresponse:{label:'No Response',  emoji:'üü†',dot:'do', badge:'btag-noresponse',row:'row-noresponse',bg:'rgba(232,145,74,.15)', color:'#f0a060', border:'rgba(232,145,74,.35)'},
  cold:      {label:'Cold',         emoji:'üî¥',dot:'dr', badge:'btag-cold',      row:'row-cold',      bg:'rgba(224,92,92,.15)',  color:'#f07070', border:'rgba(224,92,92,.35)'},
  outofarea: {label:'Out of Area',  emoji:'üü£',dot:'dp', badge:'btag-outofarea', row:'row-outofarea', bg:'rgba(155,114,207,.15)',color:'#b88ae0', border:'rgba(155,114,207,.35)'},
  invalid:   {label:'Invalid',      emoji:'‚ö´',dot:'dgy',badge:'btag-invalid',   row:'row-invalid',   bg:'rgba(100,100,100,.12)',color:'#888',    border:'rgba(100,100,100,.3)'},
  scheduled: {label:'Scheduled',    emoji:'‚è∞',dot:'ds', badge:'btag-scheduled', row:'row-scheduled', bg:'rgba(100,160,240,.12)',color:'#7aaae0', border:'rgba(100,160,240,.3)'},
  new:       {label:'New',          emoji:'‚¨ú',dot:'dn', badge:'btag-new',       row:'',              bg:'rgba(255,255,255,.04)',color:'var(--td)',border:'var(--bd)'},
};
// tagInfo(lead) ‚Äî PRIMARY accessor used by all render code. Returns TAG_DEF shape with all fields.
function tagInfo(l){return TAG_DEFS[getTag(l)]||TAG_DEFS.new;}
// Resolve a tag key: custom tags from CFG map to nearest built-in by matching keywords
function resolveTagKey(rawTag){
  const t=(rawTag||'').toLowerCase().trim();
  if(!t)return null;
  if(TAG_DEFS[t])return t;
  // Map common keywords to canonical keys
  if(t.includes('booked'))return'booked';
  if(t.includes('shoot done')||t.includes('session done'))return'done';
  if(t.includes('interested')&&!t.includes('not'))return'interested';
  if(t.includes('warm')||t.includes('teal'))return'warm';
  if(t.includes('no response')||t.includes('cnr')||t.includes('busy'))return'noresponse';
  if(t.includes('cold')||t.includes('not interested')||t.includes('lost'))return'cold';
  if(t.includes('out of area')||t.includes('out of pune')||t.includes('outsider'))return'outofarea';
  if(t.includes('invalid')||t.includes('wrong number'))return'invalid';
  if(t.includes('schedul')||t.includes('reminder')||t.includes('future'))return'scheduled';
  return null;
}

// Keyword-based auto-derive (checks last note, most specific first)
function deriveTag(l){
  // Notes from most recent to oldest ‚Äî last FU wins
  const notes=[l['FU4 Notes'],l['FU3 Notes'],l['FU2 Notes'],l['FU1 Notes'],l['General Notes']].filter(Boolean);
  const combined=notes.join(' ').toLowerCase();
  const n=(notes[0]||'').toLowerCase();
  if(!n&&!combined)return'new';

  // BOOKED / DONE ‚Äî scan all notes, any match wins
  if(combined.includes('shoot done')||combined.includes('session done'))return'done';
  if(combined.includes('booking confirmed')||combined.includes('booked'))return'booked';

  // COLD ‚Äî not interested, budget issue, cancelled
  if(n.includes('not interested')||n.includes('not intrested')||
     n.includes('lost lead')||n.includes('cancelled')||n.includes('cancel shoot')||
     n.includes('budget issue')||n.includes('budget problem'))return'cold';

  // OUT OF AREA ‚Äî geographic: not from Pune, other cities, referred to partner studio
  // NOTE: "Out of Service" is NOT out of area ‚Äî it's an invalid number (handled below)
  if(n.includes('not from pune')||n.includes('outsider')||n.includes('out of pune')||
     n.includes('location is far')||n.includes('too far')||
     n.includes('nagpur')||n.includes('nashik')||n.includes('mumbai')||
     n.includes('hyderabad')||n.includes('patna')||n.includes('jalgaon')||
     n.includes('jalgoan')||n.includes('kolkata')||n.includes('delhi')||
     n.includes('bangalore')||n.includes('pune outsider')||
     n.includes('reffered mp')||n.includes('referred mp')||
     n.includes('passed to mp')||n.includes('refer mp'))return'outofarea';

  // INVALID NUMBER ‚Äî phone unreachable (NOT geography)
  if(n.includes('invalid number')||n.includes('invalid no')||n.includes('wrong number')||
     n.includes('no incoming calls')||n.includes('out of service')||
     n.includes('out of network')||n.includes('not reachable')||
     n.includes('number does not exist')||n.includes('disconnected number'))return'invalid';

  // INTERESTED ‚Äî explicit interest or details sent
  if(n.includes('interested')&&!n.includes('not interested')&&!n.includes('not intrested')||
     n.includes('details shared')||n.includes('details share')||n.includes('shared details')||
     n.includes('send details')||n.includes('sent details')||n.includes('sent package')||
     n.includes('package details')||n.includes('shared package')||
     n.includes('follow up required')||n.includes('followup required'))return'interested';

  // WARM ‚Äî planning, future follow-up, callback requested
  if(n.includes('call later')||n.includes('call back')||n.includes('callback')||
     n.includes('asked to call')||n.includes('asked me to call')||
     n.includes('future enquiry')||n.includes('future plan')||
     n.includes('plan for')||n.includes('planning for')||n.includes('planning in')||
     n.includes('next week')||n.includes('next month')||n.includes('will call')||
     n.includes('will visit')||n.includes('feb end')||n.includes('coming week')||
     n.includes('coming month'))return'warm';

  // NO RESPONSE ‚Äî CNA / CNR / busy / voicemail (very high volume in this sheet)
  if(n.includes('no response')||n.includes('cnr')||n.includes('cna')||
     n.includes('call busy')||n.includes('number busy')||
     n.includes('call not answered')||n.includes('call not received')||n.includes('call not done')||
     n.includes('no answer')||n.includes('voice mail')||n.includes('voicemail')||
     n.includes('switched off')||n.includes('call disconnected')||
     n.includes('call forward')||n.includes('call cut')||
     n.includes('call on whatsapp'))return'noresponse';

  return'new';
}

function getTag(l){
  // Prefer explicit stored tag
  const stored=(l['Tag']||'').trim();
  if(stored){const k=resolveTagKey(stored);if(k)return k;}
  // Check if lead has a future date set but no outcome tag ‚Üí scheduled
  if(isScheduledReminder(l))return'scheduled';
  return deriveTag(l);
}

function tagHTML(l){const t=getTag(l);const d=TAG_DEFS[t]||TAG_DEFS.new;
  return`<span class="tag" style="background:${d.bg};color:${d.color};border:1px solid ${d.border}">${d.emoji} ${d.label}</span>`;}

// ‚îÄ‚îÄ SCHEDULED REMINDER LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A lead is a "scheduled reminder" if a FU date exists but no outcome tag on that stage
// Hidden from Due Today and Overdue before the reminder date ‚Äî surfaces only on exact date
function isScheduledReminder(l){
  // Check each FU: date set but NO notes on that stage
  const stages=[['FU1 Date','FU1 Notes'],['FU2 Date','FU2 Notes'],['FU3 Date','FU3 Notes'],['FU4 Date','FU4 Notes']];
  return stages.some(([dk,nk])=>{
    const d=(l[dk]||'').trim();const n=(l[nk]||'').trim();
    if(!d||n)return false; // needs date + empty notes
    const parsed=parseDate(d);if(!parsed)return false;
    const today=new Date();today.setHours(0,0,0,0);parsed.setHours(0,0,0,0);
    return parsed>=today; // future or today only
  });
}
// Get the next reminder date for a scheduled lead
function reminderDate(l){
  const stages=[['FU1 Date','FU1 Notes'],['FU2 Date','FU2 Notes'],['FU3 Date','FU3 Notes'],['FU4 Date','FU4 Notes']];
  for(const [dk,nk] of stages){
    const d=(l[dk]||'').trim();const n=(l[nk]||'').trim();
    if(d&&!n){const parsed=parseDate(d);if(parsed){const t=new Date();t.setHours(0,0,0,0);parsed.setHours(0,0,0,0);if(parsed>=t)return d;}}
  }
  return'';
}

// ‚îÄ‚îÄ ARCHIVE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isArchiveable(l){
  if(isClosed(l))return false; // already closed leads handled separately
  const days=leadAgeDays(l);
  if(days<(CFG.archiveDays||60))return false;
  // Must have no future FU date
  const nfd=nextFUDate(l);if(!nfd)return true;
  const d=parseDate(nfd);if(!d)return true;
  const today=new Date();today.setHours(0,0,0,0);d.setHours(0,0,0,0);
  return d<=today; // past or no future date
}

// FU outcome options now come from CFG.fuOutcomes (not hardcoded)
// Color mapping for outcome buttons: certain keywords get semantic colors
function outcomeColor(label){
  const l=label.toLowerCase();
  if(l.includes('booked')||l.includes('shoot done'))return'sg';
  if(l.includes('not interested')||l.includes('lost lead')||l.includes('cancel'))return'sr';
  if(l.includes('no response')||l.includes('cnr')||l.includes('busy')||l.includes('budget'))return'so';
  if(l.includes('interested')&&!l.includes('not'))return'sb';
  if(l.includes('out of')||l.includes('outsider'))return'sp';
  return'sa'; // amber/default
}

const HIDEABLE_COLS=[
  {key:'col-tag',label:'Status Tag'},{key:'col-source',label:'Source'},
  {key:'col-location',label:'Location'},{key:'col-babyage',label:'Baby Age'},
  {key:'col-agent',label:'Agent'},{key:'col-shoot',label:'Shoot Type'},
];
let colVisibility={'col-tag':true,'col-source':true,'col-location':true,'col-babyage':true,'col-agent':true,'col-shoot':true};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN / DATE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cl(f){return(CM[f]||'').toUpperCase();}
function ci(f){const l=cl(f);if(!l)return -1;let n=0;for(let i=0;i<l.length;i++)n=n*26+(l.charCodeAt(i)-64);return n-1;}
function maxCI(){return Math.max(...FIELDS.map(f=>ci(f)).filter(i=>i>=0));}
function n2l(n){let s='';n++;while(n>0){n--;s=String.fromCharCode(65+(n%26))+s;n=Math.floor(n/26);}return s;}
function rowToLead(row){const l={};FIELDS.forEach(f=>{const i=ci(f);l[f]=i>=0?(row[i]||''):'';});return l;}
function leadToRow(lead){const max=maxCI();const row=new Array(max+1).fill('');FIELDS.forEach(f=>{const i=ci(f);if(i>=0)row[i]=lead[f]||'';});return row;}

function parseDate(s){
  if(!s)return null;s=String(s).trim();
  const dm=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(dm){let y=parseInt(dm[3]);if(y<100)y+=2000;return new Date(y,parseInt(dm[2])-1,parseInt(dm[1]));}
  const ym=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(ym)return new Date(parseInt(ym[1]),parseInt(ym[2])-1,parseInt(ym[3]));
  return null;
}
function toISO(s){if(!s)return'';const d=parseDate(s);if(!d||isNaN(d))return'';return d.toISOString().split('T')[0];}
function fmtDate(s){if(!s)return'‚Äî';const d=parseDate(s);if(!d||isNaN(d))return s;return d.toLocaleDateString('en-IN',{day:'numeric',month:'short'});}
function todayISO(){return new Date().toISOString().split('T')[0];}
function daysAgoISO(n){const d=new Date();d.setDate(d.getDate()-n);return d.toISOString().split('T')[0];}
function dateInRange(ds,from,to){
  const d=parseDate(ds);
  if(!from&&!to)return true;if(!d)return false;
  if(from){const df=parseDate(from);if(df&&d<df)return false;}
  if(to){const dt=parseDate(to);if(dt&&d>dt)return false;}
  return true;
}

function setDatePreset(p){
  const dc=['dc0','dc1','dc2','dc3','dc4','dc5'];
  dc.forEach(id=>document.getElementById(id)?.classList.remove('on'));
  activeDatePreset=p;
  if(p==='clear'||p==='custom'){
    if(p==='clear'){document.getElementById('fDateFrom').value='';document.getElementById('fDateTo').value='';}
  } else {
    const presets={today:[0,0],yesterday:[1,1],'2days':[2,2],'3days':[3,3],week:[6,0],month:[null,0]};
    const chipMap={today:'dc0',yesterday:'dc1','2days':'dc2','3days':'dc3',week:'dc4',month:'dc5'};
    if(chipMap[p])document.getElementById(chipMap[p])?.classList.add('on');
    if(p==='month'){
      const t=new Date();document.getElementById('fDateFrom').value=new Date(t.getFullYear(),t.getMonth(),1).toISOString().split('T')[0];
      document.getElementById('fDateTo').value=todayISO();
    } else if(presets[p]){
      const[from,to]=presets[p];
      document.getElementById('fDateFrom').value=daysAgoISO(from);
      document.getElementById('fDateTo').value=daysAgoISO(to);
    }
  }
  applyFilters();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE AUTH + SHEET OPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTabHint(){
  const sid=(document.getElementById('cfgSid')||{}).value?.trim()||'';
  const sn=(document.getElementById('cfgSname')||{}).value?.trim()||'';
  const hint=document.getElementById('tabHint');if(!hint)return;
  if(sid&&sid.length>20&&!sn)hint.textContent='‚ö† Tab Name is required ‚Äî check the tab at the bottom of your sheet';
  else if(sn)hint.textContent='‚úì Will load tab: "'+sn+'"';
  else hint.textContent='';
}
function initAuth(){
  CLIENT_ID=(document.getElementById('cfgCid')||{}).value?.trim()||'';
  const sid=(document.getElementById('cfgSid')||{}).value?.trim()||'';
  const sn=(document.getElementById('cfgSname')||{}).value?.trim()||'Leads';
  if(!CLIENT_ID){toast('Enter your OAuth Client ID','err');return;}
  if(!sid){toast('Enter your Sheet ID (from the URL)','err');return;}
  SHEET_ID=sid;SHEET_NAME=sn;
  localStorage.setItem('sc',CLIENT_ID);localStorage.setItem('ss2',SHEET_ID);localStorage.setItem('sn2',SHEET_NAME);
  const s1=document.createElement('script');s1.src='https://accounts.google.com/gsi/client';
  s1.onload=()=>{
    const s2=document.createElement('script');s2.src='https://apis.google.com/js/api.js';
    s2.onload=()=>{
      gapi.load('client',async()=>{
        await gapi.client.init({discoveryDocs:['https://sheets.googleapis.com/$discovery/rest?version=v4']});
        const tc=google.accounts.oauth2.initTokenClient({
          client_id:CLIENT_ID,scope:'https://www.googleapis.com/auth/spreadsheets',
          callback:async(r)=>{
            if(r.error){toast('Auth failed: '+r.error,'err');return;}
            showApp();await loadConfig();await loadLeads();
          }
        });
        tc.requestAccessToken({prompt:'consent'});
      });
    };
    document.head.appendChild(s2);
  };
  document.head.appendChild(s1);
}
async function testConnection(){
  if(!SHEET_ID){toast('No Sheet ID ‚Äî set it in Sheet Connection below','err');return;}
  toast('Testing connection‚Ä¶','ok');
  try{
    const r=await gapi.client.sheets.spreadsheets.get({spreadsheetId:SHEET_ID});
    const sheets=r.result.sheets||[];
    const tabNames=sheets.map(s=>s.properties.title);
    const match=tabNames.find(t=>t===SHEET_NAME);
    if(match)toast('‚úì Connected! Tab "'+SHEET_NAME+'" found. Reloading‚Ä¶','ok');
    else toast('‚ö† Sheet found but tab "'+SHEET_NAME+'" not found.\nAvailable tabs: '+tabNames.join(', '),'err');
    if(match)loadLeads();
  }catch(e){
    let detail=e.message||'Unknown';
    try{const b=JSON.parse(e.body||'{}');detail=(b.error?.message||detail)+' ('+e.status+')';}catch(pe){}
    const hint=e.status===403?'Make sure this Google account has Editor access to the sheet'
              :e.status===404?'Sheet not found ‚Äî double-check the Sheet ID in the URL'
              :'Check your Sheet ID and OAuth Client ID';
    toast('Connection failed: '+detail+'\n'+hint,'err');
    console.error('testConnection',{sheetId:SHEET_ID,tabName:SHEET_NAME,status:e.status,body:e.body});
  }
}
function showApp(){
  document.getElementById('authScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
  loadLocalCfg();initUI();applyURLPipeline();
}
function loadDemo(){
  demoMode=true;
  document.getElementById('authScreen').style.display='none';
  document.getElementById('appScreen').style.display='block';
  loadLocalCfg();initUI();
  leads=generateDemoLeads();
  applyFilters();renderReport();updateAlertBanner();
  switchTab('tests');setTimeout(()=>runTests(),300);
}

async function loadConfig(){
  if(demoMode)return;
  // Try dedicated Settings Sheet first ‚Äî no hidden tabs in Leads sheets ever again
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(ssId){
    try{
      const r=await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:ssId,range:'Settings!A1:B100'});
      const rows=r.result.values||[];const map={};rows.forEach(([k,v])=>{if(k)map[k]=v||'';});
      _applyConfigMap(map);toast('Settings loaded from Settings Sheet ‚úì','ok');initUI();return;
    }catch(e){/* fall through to local */}
  }
  loadLocalCfg();initUI();
}
function _applyConfigMap(map){
  if(map['shootTypes'])CFG.shootTypes=map['shootTypes'].split('|').filter(Boolean);
  if(map['agents'])CFG.agents=map['agents'].split('|').filter(Boolean);
  if(map['agentEmails'])try{CFG.agentEmails=JSON.parse(map['agentEmails']);}catch(e){}
  if(map['fuLabels'])CFG.fuLabels=map['fuLabels'].split('|').filter(Boolean);
  if(map['sources'])CFG.sources=map['sources'].split('|').filter(Boolean);
  if(map['customTags'])CFG.customTags=map['customTags'].split('|').filter(Boolean);
  if(map['archiveDays'])CFG.archiveDays=parseInt(map['archiveDays'])||60;
  if(map['fuOutcomes'])try{CFG.fuOutcomes=JSON.parse(map['fuOutcomes']);}catch(e){}
  if(map['colMap'])try{CM={...CM,...JSON.parse(map['colMap'])};}catch(e){}
  if(map['pipelines'])try{PIPELINES=JSON.parse(map['pipelines']);renderPipelineList();buildPipelineDropdown();}catch(e){}
}
async function saveConfig(){
  if(demoMode){toast('Config saved (demo mode)','ok');return;}
  saveLocalCfg();
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(ssId)await pushSettingsToCloud();
  else toast('Config saved locally. Add a Settings Sheet to sync across devices.','ok');
}
function saveLocalCfg(){
  try{
    const data={shootTypes:CFG.shootTypes,agents:CFG.agents,agentEmails:CFG.agentEmails,
      fuLabels:CFG.fuLabels,sources:CFG.sources,customTags:CFG.customTags,
      archiveDays:CFG.archiveDays,fuOutcomes:CFG.fuOutcomes,colMap:CM,
      pipelines:PIPELINES,settingsSheetId:SETTINGS_SHEET_ID};
    localStorage.setItem('crm_cfg_v7',JSON.stringify(data));
  }catch(e){}
}
function loadLocalCfg(){
  const cols=localStorage.getItem('s_cols');if(cols)try{colVisibility={...colVisibility,...JSON.parse(cols)};}catch(e){}
  try{
    const raw=localStorage.getItem('crm_cfg_v7');
    if(raw){const d=JSON.parse(raw);
      if(d.shootTypes)CFG.shootTypes=d.shootTypes;
      if(d.agents)CFG.agents=d.agents;
      if(d.agentEmails)CFG.agentEmails=d.agentEmails;
      if(d.fuLabels)CFG.fuLabels=d.fuLabels;
      if(d.sources)CFG.sources=d.sources;
      if(d.customTags)CFG.customTags=d.customTags;
      if(d.archiveDays)CFG.archiveDays=d.archiveDays;
      if(d.fuOutcomes)CFG.fuOutcomes=d.fuOutcomes;
      if(d.colMap)CM={...CM,...d.colMap};
      if(d.pipelines){PIPELINES=d.pipelines;renderPipelineList();buildPipelineDropdown();}
      if(d.settingsSheetId)SETTINGS_SHEET_ID=d.settingsSheetId;
    }
  }catch(e){}
  // Restore active agent
  const aa=localStorage.getItem('activeAgent');
  if(aa)ACTIVE_AGENT=aa;
  // Legacy keys from v5/v6
  const ls=localStorage.getItem('ss2'),ln=localStorage.getItem('sn2'),lc=localStorage.getItem('sc');
  if(ls&&!SHEET_ID)SHEET_ID=ls;
  if(ln)SHEET_NAME=ln;
  if(lc&&!CLIENT_ID)CLIENT_ID=lc;
  const lssId=localStorage.getItem('settingsSheetId');
  if(lssId)SETTINGS_SHEET_ID=lssId;
}
async function pushSettingsToCloud(){
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(!ssId){toast('No Settings Sheet ID configured','err');return;}
  const rows=[
    ['shootTypes',CFG.shootTypes.join('|')],['agents',CFG.agents.join('|')],
    ['agentEmails',JSON.stringify(CFG.agentEmails||{})],
    ['fuLabels',CFG.fuLabels.join('|')],['sources',CFG.sources.join('|')],
    ['customTags',CFG.customTags.join('|')],['archiveDays',String(CFG.archiveDays||60)],
    ['fuOutcomes',JSON.stringify(CFG.fuOutcomes)],['colMap',JSON.stringify(CM)],
    ['pipelines',JSON.stringify(PIPELINES)],
  ];
  try{
    try{await gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:ssId,resource:{requests:[{addSheet:{properties:{title:'Settings'}}}]}});}catch(e){}
    await gapi.client.sheets.spreadsheets.values.update({spreadsheetId:ssId,range:`Settings!A1:B${rows.length}`,valueInputOption:'RAW',resource:{values:rows}});
    const el=document.getElementById('settingsSyncStatus');if(el)el.textContent='Last pushed: '+new Date().toLocaleTimeString();
    toast('Settings pushed to cloud ‚úì','ok');
  }catch(e){toast('Push failed: '+e.message,'err');}
}
async function pullSettingsFromCloud(){
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(!ssId){toast('No Settings Sheet ID configured','err');return;}
  try{
    const r=await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:ssId,range:'Settings!A1:B100'});
    const rows=r.result.values||[];const map={};rows.forEach(([k,v])=>{if(k)map[k]=v||'';});
    _applyConfigMap(map);saveLocalCfg();
    const el=document.getElementById('settingsSyncStatus');if(el)el.textContent='Last pulled: '+new Date().toLocaleTimeString();
    toast('Settings pulled from cloud ‚úì','ok');initUI();
  }catch(e){toast('Pull failed: '+e.message,'err');}
}
function saveSettingsSheet(){
  const id=(document.getElementById('settingsSheetId')||{}).value?.trim();
  if(!id){toast('Paste a Settings Sheet ID first','err');return;}
  SETTINGS_SHEET_ID=id;localStorage.setItem('settingsSheetId',id);
  toast('Settings Sheet saved ‚Äî pushing config‚Ä¶','ok');pushSettingsToCloud();
}
// ‚îÄ‚îÄ PIPELINE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addPipeline(){
  const name=(document.getElementById('newPipeName')||{}).value?.trim();
  const sheetId=(document.getElementById('newPipeSheet')||{}).value?.trim();
  const tabName=(document.getElementById('newPipeTab')||{}).value?.trim()||'Leads';
  if(!name||!sheetId){toast('Enter a pipeline name and Sheet ID','err');return;}
  if(PIPELINES.find(p=>p.name===name)){toast('Name already exists','err');return;}
  PIPELINES.push({name,sheetId,tabName});
  if(document.getElementById('newPipeName'))document.getElementById('newPipeName').value='';
  if(document.getElementById('newPipeSheet'))document.getElementById('newPipeSheet').value='';
  renderPipelineList();buildPipelineDropdown();saveConfig();toast('Pipeline added: '+name,'ok');
}
function removePipeline(i){
  if(PIPELINES.length<=1){toast('Keep at least one pipeline','err');return;}
  PIPELINES.splice(i,1);if(ACTIVE_PIPELINE>=PIPELINES.length)ACTIVE_PIPELINE=0;
  renderPipelineList();buildPipelineDropdown();saveConfig();
}
function renderPipelineList(){
  const el=document.getElementById('pipelineList');if(!el)return;
  if(!PIPELINES.length){el.innerHTML='<p style="font-size:12px;color:var(--tm)">No pipelines yet.</p>';return;}
  el.innerHTML=PIPELINES.map((p,i)=>`
    <div style="display:grid;grid-template-columns:1fr 2fr auto;gap:6px;align-items:center;background:var(--sf2);border-radius:6px;padding:7px 10px">
      <span style="font-weight:600;font-size:13px;color:${i===ACTIVE_PIPELINE?'var(--ac)':'var(--tx)'}">${esc(p.name)}${i===ACTIVE_PIPELINE?' ‚óè':''}</span>
      <span style="font-family:monospace;font-size:10px;color:var(--tm);overflow:hidden;text-overflow:ellipsis" title="${esc(p.sheetId)}">${esc(p.sheetId.slice(0,30)+'‚Ä¶')}</span>
      <button class="bsm" onclick="removePipeline(${i})">√ó</button>
    </div>`).join('');
}
function buildPipelineDropdown(){
  const sel=document.getElementById('pipelineSel');const wrap=document.getElementById('pipelineWrap');
  if(!sel)return;
  if(PIPELINES.length<2){if(wrap)wrap.style.display='none';return;}
  if(wrap)wrap.style.display='flex';
  sel.innerHTML=PIPELINES.map((p,i)=>`<option value="${i}"${i===ACTIVE_PIPELINE?' selected':''}>${esc(p.name)}</option>`).join('');
}
function switchPipeline(idx){
  ACTIVE_PIPELINE=parseInt(idx)||0;
  const p=PIPELINES[ACTIVE_PIPELINE];if(!p)return;
  SHEET_ID=p.sheetId;SHEET_NAME=p.tabName;
  buildPipelineDropdown();leads=[];applyFilters();loadLeads();
  toast('Switched to: '+p.name,'ok');
}
function bookmarkPipeline(){
  const p=PIPELINES[ACTIVE_PIPELINE];if(!p){toast('No pipeline active','err');return;}
  const url=new URL(window.location.href);url.searchParams.set('c',p.name);
  navigator.clipboard?.writeText(url.toString()).then(()=>toast('Bookmark URL copied ‚Äî paste in browser or share with agent ‚úì','ok')).catch(()=>prompt('Copy this URL:',url.toString()));
}
function applyURLPipeline(){
  const name=new URLSearchParams(window.location.search).get('c');
  if(!name||!PIPELINES.length)return;
  const idx=PIPELINES.findIndex(p=>p.name.toLowerCase()===name.toLowerCase());
  if(idx>=0)switchPipeline(idx);
}
async function loadLeads(){
  if(demoMode)return;
  if(!SHEET_ID){toast('No Sheet ID set ‚Äî open Settings ‚Üí Sheet Connection','err');return;}
  sync(true);
  try{
    // Use a wide safe range ‚Äî Sheets API returns only columns that exist
    const safeRange=`${SHEET_NAME}!A2:Z`;
    const r=await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:SHEET_ID,range:safeRange});
    leads=(r.result.values||[]).map((row,i)=>{const l=rowToLead(row);l._ri=i+2;l._wm=wmCheck(l);return l;}).filter(l=>l['Phone']||l['Name']);
    applyFilters();renderReport();updateAlertBanner();
    sync(false);
    if(!leads.length)toast('Sheet loaded but no leads found. Check tab name "'+SHEET_NAME+'" matches your sheet exactly.','ok');
  }catch(e){
    sync(false);
    // Parse verbose error from Google API
    let detail='Unknown error';
    let status='unknown';
    
    // Try to extract error details from different error structures
    if(e.message)detail=e.message;
    if(e.status)status=e.status;
    if(e.result?.error?.message)detail=e.result.error.message;
    
    try{
      const body=JSON.parse(e.body||'{}');
      if(body.error?.message)detail=body.error.message;
      if(body.error?.status)status=body.error.status;
    }catch(pe){}
    
    const statusNum=parseInt(status)||0;
    const hint=statusNum===400?'\n\n‚Üí Check: Tab name "'+SHEET_NAME+'" exists in your sheet (case-sensitive)'
              :statusNum===403?'\n\n‚Üí Check: Your Google account has Editor access to this sheet'
              :statusNum===404?'\n\n‚Üí Check: Sheet ID is correct (from the URL)'
              :statusNum===401?'\n\n‚Üí Check: Re-authenticate (refresh page and sign in again)'
              :'';
    
    const fullMsg=`Load failed: ${detail}\nStatus: ${status}\nSheet: ${SHEET_ID}\nTab: ${SHEET_NAME}${hint}`;
    toast(fullMsg,'err');
    console.error('loadLeads error',{sheetId:SHEET_ID,tabName:SHEET_NAME,status,body:e.body,message:e.message,fullError:e});
  }
}
async function writeRow(lead,ri){
  if(demoMode)return;
  try{
    const row=leadToRow(lead);
    const lastCol=n2l(Math.max(row.length-1,18));
    await gapi.client.sheets.spreadsheets.values.update({spreadsheetId:SHEET_ID,range:`${SHEET_NAME}!A${ri}:${lastCol}${ri}`,valueInputOption:'USER_ENTERED',resource:{values:[row]}});
  }catch(e){
    let detail=e.message||'Write error';
    try{const b=JSON.parse(e.body||'{}');detail=(b.error?.message||detail)+' ('+e.status+')';}catch(pe){}
    toast('Save error: '+detail,'err');console.error('writeRow error',{ri,status:e.status,body:e.body});
    throw e;
  }
}
async function appendRows(rows){
  if(demoMode)return;
  try{
    // Use A:A range ‚Äî Sheets appends to next empty row regardless of column range specified
    // USER_ENTERED handles dates and numbers correctly
    await gapi.client.sheets.spreadsheets.values.append({spreadsheetId:SHEET_ID,range:`${SHEET_NAME}!A:A`,valueInputOption:'USER_ENTERED',insertDataOption:'INSERT_ROWS',resource:{values:rows}});
  }catch(e){
    let detail=e.message||'Append error';
    try{const b=JSON.parse(e.body||'{}');detail=(b.error?.message||detail)+' ('+e.status+')';}catch(pe){}
    toast('Append error: '+detail,'err');console.error('appendRows error',{status:e.status,body:e.body});
    throw e;
  }
}
async function delRow(ri){
  if(demoMode)return;
  const m=await gapi.client.sheets.spreadsheets.get({spreadsheetId:SHEET_ID});
  const sh=m.result.sheets.find(s=>s.properties.title===SHEET_NAME);
  await gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:SHEET_ID,resource:{requests:[{deleteDimension:{range:{sheetId:sh.properties.sheetId,dimension:'ROWS',startIndex:ri-1,endIndex:ri}}}]}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAD HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function wmCheck(lead){
  const sh=lead['Shoot Type'],ba=lead['Baby Age'],da=lead['Date Added'];
  if(!sh||!ba||!da)return false;const wd=SW[sh];if(!wd)return false;
  let ad=0;
  if(/newborn|nb/i.test(ba))ad=7;
  else{const m=ba.match(/(\d+)\s*month/i);const w=ba.match(/(\d+)\s*week/i);
    if(m)ad=parseInt(m[1])*30;else if(w)ad=parseInt(w[1])*7;else return false;}
  const dObj=parseDate(da);if(!dObj)return false;
  return(ad+Math.floor((new Date()-dObj)/86400000))>wd;
}
function getLastNote(l){return l['FU4 Notes']||l['FU3 Notes']||l['FU2 Notes']||l['FU1 Notes']||l['General Notes']||'';}
function getStage(l){
  if(l['FU4 Notes']||l['FU4 Date'])return CFG.fuLabels[3]+' ‚úì';
  if(l['FU3 Notes']||l['FU3 Date'])return CFG.fuLabels[2]+' ‚Üí '+CFG.fuLabels[3];
  if(l['FU2 Notes']||l['FU2 Date'])return CFG.fuLabels[1]+' ‚Üí '+CFG.fuLabels[2];
  if(l['FU1 Notes']||l['FU1 Date'])return CFG.fuLabels[0]+' ‚Üí '+CFG.fuLabels[1];
  return'New ‚Üí '+CFG.fuLabels[0];
}
function isClosed(l){
  // Tags that close a lead (move to Closed tab): booked, done, cold, invalid
  // outofarea stays ACTIVE (still in pipeline, just redirected)
  const closedTags=['booked','done','cold','invalid'];
  const storedTag=resolveTagKey((l['Tag']||''));
  if(storedTag&&closedTags.includes(storedTag))return true;
  // Also close based on explicit closing notes
  return['FU1 Notes','FU2 Notes','FU3 Notes','FU4 Notes'].some(k=>{
    const v=(l[k]||'').toLowerCase();
    return v.includes('booked')||v.includes('booking confirmed')||
           v.includes('shoot done')||v.includes('session done')||
           v.includes('not interested')||v.includes('not intrested')||
           v.includes('cancelled')||v.includes('lost lead')||
           v.includes('invalid number')||v.includes('no incoming calls');
  });
}
function nextFUDate(l){
  // Returns the date for the NEXT expected follow-up (stage with date but no notes)
  // This is separate from reminderDate ‚Äî it's for overdue/due tracking
  if((l['FU3 Notes']||l['FU3 Date'])&&!l['FU4 Notes']&&l['FU4 Date'])return l['FU4 Date'];
  if((l['FU2 Notes']||l['FU2 Date'])&&!l['FU3 Notes']&&l['FU3 Date'])return l['FU3 Date'];
  if((l['FU1 Notes']||l['FU1 Date'])&&!l['FU2 Notes']&&l['FU2 Date'])return l['FU2 Date'];
  if(l['FU1 Notes']&&!l['FU2 Date'])return''; // has contact, no next date set
  if(!l['FU1 Notes']&&l['FU1 Date'])return l['FU1 Date']; // first contact date
  return'';
}
// Separate: is this lead overdue (past FU date with completed stage note)?
function isOverdue(l){
  if(isClosed(l))return false;
  if(isScheduledReminder(l))return false; // scheduled leads are not overdue
  const nd=nextFUDate(l);if(!nd)return false;
  const d=parseDate(nd);if(!d)return false;
  const today=new Date();today.setHours(0,0,0,0);d.setHours(0,0,0,0);
  return d<today;
}
function isDueToday(l){
  if(isClosed(l))return false;
  // Scheduled reminder due today
  if(isScheduledReminder(l)){
    const rd=reminderDate(l);if(!rd)return false;
    const d=parseDate(rd);if(!d)return false;
    const today=new Date();today.setHours(0,0,0,0);d.setHours(0,0,0,0);
    return d.getTime()===today.getTime();
  }
  const nd=nextFUDate(l);if(!nd)return false;
  const d=parseDate(nd);if(!d)return false;
  const today=new Date();today.setHours(0,0,0,0);d.setHours(0,0,0,0);
  return d.getTime()===today.getTime();
}
function dueLabel(ds,l){
  if(!ds)return'<span style="color:var(--td)">‚Äî</span>';
  const d=parseDate(ds),t=new Date();if(!d)return ds;
  d.setHours(0,0,0,0);t.setHours(0,0,0,0);const diff=(d-t)/86400000;
  if(l&&isScheduledReminder(l)){
    if(diff>0)return`<span class="sched">‚è∞ ${fmtDate(ds)}</span>`;
    if(diff===0)return'<span class="dtd">‚è∞ Due Today</span>';
  }
  if(diff<0)return`<span class="ovd">Overdue ${Math.abs(Math.round(diff))}d</span>`;
  if(diff===0)return'<span class="dtd">Due Today</span>';
  if(diff<=2)return`<span class="upc">In ${Math.round(diff)}d</span>`;
  return`<span class="upc">${fmtDate(ds)}</span>`;
}
function leadAgeDays(l){
  const d=parseDate(l['Date Added']);if(!d)return 0;
  return Math.floor((new Date()-d)/86400000);
}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function trunc(s,n=40){return s&&s.length>n?s.slice(0,n)+'‚Ä¶':(s||'');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERT BANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAlertBanner(){
  const active=leads.filter(l=>!isClosed(l)&&!l._archived);
  const overdue=active.filter(isOverdue);
  const dueToday=active.filter(isDueToday);
  const bar=document.getElementById('alertBar');
  if(overdue.length===0&&dueToday.length===0){bar.classList.add('hidden');return;}
  bar.classList.remove('hidden');
  const ov=document.getElementById('alertOverdue');
  const td=document.getElementById('alertToday');
  ov.textContent=overdue.length?`${overdue.length} Overdue`:'';
  ov.style.display=overdue.length?'':'none';
  td.textContent=dueToday.length?`${dueToday.length} Due Today`:'';
  td.style.display=dueToday.length?'':'none';
}
function alertFilter(type){
  clearFilters();
  if(type==='overdue'){chips.overdue=true;document.getElementById('btnOverdue').classList.add('on');}
  else{chips.due=true;document.getElementById('btnDue').classList.add('on');}
  applyFilters();switchTab('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS + RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyFilters(){
  const search=document.getElementById('fSearch').value.toLowerCase();
  const agent=document.getElementById('fAgent').value;
  const source=document.getElementById('fSource').value;
  const shoot=document.getElementById('fShoot').value;
  const tagF=document.getElementById('fTag').value;
  const fu=document.getElementById('fFU').value;
  const dfrom=document.getElementById('fDateFrom').value;
  const dto=document.getElementById('fDateTo').value;

  filtered=leads.filter(l=>{
    if(isClosed(l))return false;
    if(l._archived)return false;
    if(search){const nm=(l['Name']||'').toLowerCase(),ph=(l['Phone']||'').toLowerCase();if(!nm.includes(search)&&!ph.includes(search))return false;}
    if(agent&&l['Agent']!==agent)return false;
    if(source&&l['Source']!==source)return false;
    if(shoot&&(l['Shoot Type']||'')!==shoot)return false;
    if(tagF&&getTag(l)!==tagF)return false;
    if(fu){
      const h1=!!(l['FU1 Notes']||l['FU1 Date']);const h2=!!(l['FU2 Notes']||l['FU2 Date']);const h3=!!(l['FU3 Notes']||l['FU3 Date']);
      if(fu==='new'&&h1)return false;if(fu==='fu1done'&&(!h1||h2))return false;
      if(fu==='fu2done'&&(!h2||h3))return false;if(fu==='fu3done'&&!h3)return false;
    }
    if((dfrom||dto)&&!dateInRange(l['Date Added'],dfrom,dto))return false;
    if(chips.overdue&&!isOverdue(l))return false;
    if(chips.due&&!isDueToday(l))return false;
    if(chips.nn&&(l['Name']||'').trim()!=='')return false;
    return true;
  });
  renderActive();renderClosed();
  
  // Update filter count display
  const activeCount=getActiveFilterCount();
  document.getElementById('filterCount').textContent=`${filtered.length} lead${filtered.length!==1?'s':''}`;
  
  // Update Clear button text
  const clearBtn=document.querySelector('.bclr');
  if(clearBtn)clearBtn.textContent=activeCount>0?`Clear (${activeCount})`:'Clear';
  
  updateAlertBanner();updateBulkBar();
}

function getActiveFilterCount(){
  let count=0;
  if(document.getElementById('fSearch').value)count++;
  if(document.getElementById('fAgent').value)count++;
  if(document.getElementById('fSource').value)count++;
  if(document.getElementById('fShoot').value)count++;
  if(document.getElementById('fTag').value)count++;
  if(document.getElementById('fFU').value)count++;
  if(document.getElementById('fDateFrom').value||document.getElementById('fDateTo').value)count++;
  if(chips.overdue)count++;
  if(chips.due)count++;
  if(chips.nn)count++;
  return count;
}
function toggleChip(c){
  if(c==='due'){chips.due=!chips.due;chips.overdue=false;document.getElementById('btnOverdue').classList.remove('on');}
  else if(c==='overdue'){chips.overdue=!chips.overdue;chips.due=false;document.getElementById('btnDue').classList.remove('on');}
  else chips[c]=!chips[c];
  document.getElementById(c==='due'?'btnDue':c==='overdue'?'btnOverdue':'btnNN').classList.toggle('on',chips[c]);
  applyFilters();
}
function clearFilters(){
  ['fSearch','fAgent','fSource','fShoot','fFU','fDateFrom','fDateTo','fTag'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  chips={due:false,overdue:false,nn:false};
  ['btnDue','btnOverdue','btnNN'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('on');});
  setDatePreset('clear');applyFilters();
}
function colClass(key){return colVisibility[key]?'':'col-hide';}

function renderActive(){
  const tb=document.getElementById('leadsBody');
  if(!filtered.length){
    // Build verbose filter message
    const activeFilters=[];
    const search=document.getElementById('fSearch').value;
    const agent=document.getElementById('fAgent').value;
    const source=document.getElementById('fSource').value;
    const shoot=document.getElementById('fShoot').value;
    const tagF=document.getElementById('fTag').value;
    const fu=document.getElementById('fFU').value;
    const dfrom=document.getElementById('fDateFrom').value;
    const dto=document.getElementById('fDateTo').value;
    
    if(search)activeFilters.push(`Search: "${search}"`);
    if(agent)activeFilters.push(`Agent: ${agent}`);
    if(source)activeFilters.push(`Source: ${source}`);
    if(shoot)activeFilters.push(`Shoot: ${shoot}`);
    if(tagF){const opt=document.querySelector(`#fTag option[value="${tagF}"]`);activeFilters.push(`Status: ${opt?opt.textContent:tagF}`);}
    if(fu){const opt=document.querySelector(`#fFU option[value="${fu}"]`);activeFilters.push(`FU Stage: ${opt?opt.textContent:fu}`);}
    if(dfrom||dto)activeFilters.push(`Date: ${dfrom||'any'} to ${dto||'today'}`);
    if(chips.overdue)activeFilters.push('Overdue only');
    if(chips.due)activeFilters.push('Due today only');
    if(chips.nn)activeFilters.push('No name only');
    
    const msg=activeFilters.length
      ?`No leads match filters:<br><br><strong style="color:var(--ac)">${activeFilters.join(' ‚Ä¢ ')}</strong><br><br><span style="color:var(--td);font-size:11px">Try clearing filters or adjusting your search</span>`
      :`No active leads yet.<br><br><span style="color:var(--td);font-size:11px">Add a lead using the "+ Add Lead" button</span>`;
    
    tb.innerHTML=`<tr><td colspan="12" style="text-align:center;padding:48px;color:var(--tm);line-height:1.8">${msg}</td></tr>`;
    return;
  }
  tb.innerHTML=filtered.map(l=>{
    const noN=!(l['Name']||'').trim();
    const ti=tagInfo(l);
    const age=leadAgeDays(l);
    const ageTag=(!isClosed(l)&&age>14)?`<span class="age-badge">${age}d</span>`:'';
    const waLink=`<button class="wa-btn" onclick="event.stopPropagation();window.open('https://wa.me/91${(l['Phone']||'').replace(/\D/g,'')}')" title="Open WhatsApp">üí¨</button>`;
    const isSel=selectedRis.has(l._ri);
    return`<tr onclick="openPanel(${l._ri})" class="${ti.row}${l._wm?' wm':''}${isSel?' sel':''}">
      <td class="chk" onclick="event.stopPropagation()"><input type="checkbox" ${isSel?'checked':''} onchange="toggleChk(${l._ri},this.checked)" style="cursor:pointer"></td>
      <td>
        <div class="ln ${noN?'un':''}">${noN?'(no name)':esc(l['Name'])} ${ageTag}</div>
        <div class="lp">${esc(l['Phone']||'')} ${l['Phone']?waLink:''}</div>
        ${l._wm?'<span class="badge bw">‚ö† Window</span>':''} ${noN?'<span class="badge bn">üë§</span>':''}
      </td>
      <td class="col-tag ${colClass('col-tag')}"><span class="badge badge-tag ${ti.badge}" style="font-size:11px;padding:3px 9px">${ti.emoji} ${ti.label}</span></td>
      <td class="col-shoot ${colClass('col-shoot')}"><span class="badge bs" style="font-size:11px">${esc(l['Shoot Type']||'‚Äî')}</span></td>
      <td class="col-source ${colClass('col-source')}" style="color:var(--tm);font-size:12px">${esc(l['Source']||'‚Äî')}</td>
      <td class="col-location ${colClass('col-location')}" style="color:var(--tm);font-size:12px">${esc(l['Location']||'‚Äî')}</td>
      <td class="col-babyage ${colClass('col-babyage')}" style="color:var(--tm);font-size:12px">${esc(l['Baby Age']||'‚Äî')}</td>
      <td style="font-size:11px"><strong>${esc(getStage(l))}</strong></td>
      <td class="col-agent ${colClass('col-agent')}" style="color:var(--tm);font-size:12px">${esc(l['Agent']||'‚Äî')}</td>
      <td style="color:var(--tm);font-size:12px;max-width:150px">${esc(trunc(getLastNote(l)))}</td>
      <td>${dueLabel(nextFUDate(l))}</td>
      <td style="color:var(--tm);font-size:12px;white-space:nowrap">${fmtDate(l['Date Added'])}</td>
    </tr>`;
  }).join('');
}

function renderClosed(){
  const cls=leads.filter(isClosed);
  const tb=document.getElementById('closedBody');
  if(!cls.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;padding:48px;color:var(--tm)">No closed leads</td></tr>';return;}
  tb.innerHTML=cls.map(l=>{
    const noN=!(l['Name']||'').trim();
    const ti=tagInfo(l);
    return`<tr onclick="openPanel(${l._ri})" class="${ti.row}">
      <td><div class="ln ${noN?'un':''}">${noN?'(no name)':esc(l['Name'])}</div><div class="lp">${esc(l['Phone']||'')}</div></td>
      <td class="col-tag ${colClass('col-tag')}"><span class="badge badge-tag ${ti.badge}">${ti.emoji} ${ti.label}</span></td>
      <td class="col-shoot ${colClass('col-shoot')}"><span class="badge bs" style="font-size:11px">${esc(l['Shoot Type']||'‚Äî')}</span></td>
      <td class="col-agent ${colClass('col-agent')}" style="color:var(--tm)">${esc(l['Agent']||'‚Äî')}</td>
      <td style="font-size:12px;font-weight:500"><span class="badge badge-tag ${ti.badge}">${ti.emoji} ${esc(trunc(getLastNote(l)))}</span></td>
      <td style="color:var(--tm);font-size:12px;white-space:nowrap">${fmtDate(l['Date Added'])}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BULK SELECT + ASSIGN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleChk(ri,checked){
  if(checked)selectedRis.add(ri);else selectedRis.delete(ri);
  updateBulkBar();renderActive();
}
function toggleAllChk(checked){
  if(checked)filtered.forEach(l=>selectedRis.add(l._ri));else selectedRis.clear();
  updateBulkBar();renderActive();
}
function updateBulkBar(){
  const n=selectedRis.size;
  const bar=document.getElementById('bulkBar');
  bar.classList.toggle('show',n>0);
  document.getElementById('bulkInfo').textContent=`${n} lead${n!==1?'s':''} selected`;
}
function bulkClear(){selectedRis.clear();document.getElementById('chkAll').checked=false;updateBulkBar();renderActive();}
async function bulkAssign(){
  const agent=document.getElementById('bulkAgent').value;
  if(!agent)return;
  if(!confirm(`Assign ${selectedRis.size} leads to ${agent}?`)){document.getElementById('bulkAgent').value='';return;}
  const toUpdate=leads.filter(l=>selectedRis.has(l._ri));
  toUpdate.forEach(l=>l['Agent']=agent);
  if(!demoMode){
    try{
      for(const l of toUpdate)await writeRow(l,l._ri);
      toast(`${toUpdate.length} leads assigned to ${agent}!`,'ok');
    }catch(e){toast('Bulk assign failed: '+e.message,'err');return;}
  } else {toast(`${toUpdate.length} leads assigned to ${agent} (demo)!`,'ok');}
  document.getElementById('bulkAgent').value='';
  bulkClear();applyFilters();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COLUMN VISIBILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initColToggles(){
  document.getElementById('colToggles').innerHTML=HIDEABLE_COLS.map(({key,label})=>`
    <div class="col-toggle-row">
      <span style="font-size:13px">${label}</span>
      <label class="toggle">
        <input type="checkbox" ${colVisibility[key]?'checked':''} onchange="toggleCol('${key}',this.checked)">
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
    </div>`).join('');
}
function toggleCol(key,visible){
  colVisibility[key]=visible;
  localStorage.setItem('s_cols',JSON.stringify(colVisibility));
  renderActive();renderClosed();
}
function toggleColPanel(){const p=document.getElementById('colPanel');p.style.display=p.style.display==='none'?'block':'none';}
document.addEventListener('click',e=>{
  const wrap=document.getElementById('colPanelWrap');
  if(wrap&&!wrap.contains(e.target))document.getElementById('colPanel').style.display='none';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPanel(ri,fromQCM=false){
  const isNew=ri===null;
  document.getElementById('panelTitle').textContent=isNew?'New Lead':'Edit Lead';
  document.getElementById('btnDel').style.display=isNew?'none':'block';
  document.getElementById('panelNav').style.display=(qcmActive&&!isNew)?'flex':'none';
  document.getElementById('panelTagBadge').style.display='none';

  const ids=['pName','pPhone','pLoc','pAge','pNotes','pShoot','p1s','p2s','p3s','p4s','p1d','p2d','p3d','p4d','p1n','p2n','p3n','p4n'];
  ids.forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('pRI').value=ri||'';
  document.getElementById('waBtn').style.display='none';
  clearOBtns();

  if(!isNew){
    const l=leads.find(x=>x._ri===ri);if(!l)return;
    const ti=tagInfo(l);
    const badge=document.getElementById('panelTagBadge');
    badge.className=`badge badge-tag ph-tag ${ti.badge}`;
    badge.textContent=ti.emoji+' '+ti.label;
    badge.style.display='inline-block';
    document.getElementById('pName').value=l['Name']||'';
    document.getElementById('pPhone').value=l['Phone']||'';
    if(l['Phone']){document.getElementById('waBtn').style.display='block';}
    document.getElementById('pAgent').value=l['Agent']||'';
    document.getElementById('pSource').value=l['Source']||'';
    document.getElementById('pLoc').value=l['Location']||'';
    document.getElementById('pAge').value=l['Baby Age']||'';
    document.getElementById('pNotes').value=l['General Notes']||'';
    setOBtn('shootOpts',l['Shoot Type']||'','sb');
    document.getElementById('pShoot').value=l['Shoot Type']||'';
    const fuMap=[['p1d','FU1 Date','p1n','FU1 Notes','p1s',0],['p2d','FU2 Date','p2n','FU2 Notes','p2s',1],['p3d','FU3 Date','p3n','FU3 Notes','p3s',2],['p4d','FU4 Date','p4n','FU4 Notes','p4s',3]];
    fuMap.forEach(([dd,dk,nn,nk,ss,idx])=>{
      document.getElementById(dd).value=toISO(l[dk]);
      document.getElementById(nn).value=l[nk]||'';
      document.getElementById(ss).value=l[nk]||'';
      setOBtn('fu'+(idx+1)+'Opts',l[nk]||'','sg');
    });
    if(qcmActive){
      document.getElementById('qcmCount').textContent=`${qcmIdx+1} / ${qcmQueue.length}`;
      document.getElementById('btnPrev').disabled=qcmIdx===0;
      document.getElementById('btnNext').disabled=qcmIdx>=qcmQueue.length-1;
    }
  }
  unlockFU();
  // Pre-fill agent for new leads from active agent selector
  if(isNew&&ACTIVE_AGENT){
    const pag=document.getElementById('pAgent');
    if(pag)pag.value=ACTIVE_AGENT;
  }
  document.getElementById('pov').classList.add('open');
  document.getElementById('sp').classList.add('open');
}
function closePanel(){document.getElementById('pov').classList.remove('open');document.getElementById('sp').classList.remove('open');}
function unlockFU(){
  // Unlock next stage if current stage has a date OR an outcome selected
  const h1=!!(document.getElementById('p1d').value||document.getElementById('p1s').value||document.getElementById('p1n').value);
  const h2=!!(document.getElementById('p2d').value||document.getElementById('p2s').value||document.getElementById('p2n').value);
  const h3=!!(document.getElementById('p3d').value||document.getElementById('p3s').value||document.getElementById('p3n').value);
  document.getElementById('fu2b').classList.toggle('locked',!h1);
  document.getElementById('fu3b').classList.toggle('locked',!h2);
  document.getElementById('fu4b').classList.toggle('locked',!h3);
}
function clearOBtns(){['shootOpts','fu1Opts','fu2Opts','fu3Opts','fu4Opts'].forEach(id=>{document.querySelectorAll(`#${id} .ob`).forEach(b=>b.className='ob');});}
function setOBtn(gid,val,cls){if(!val)return;document.querySelectorAll(`#${gid} .ob`).forEach(b=>{if(b.dataset.val===val)b.classList.add(cls);});}
function selectOB(gid,val,cls,hid){
  document.querySelectorAll(`#${gid} .ob`).forEach(b=>b.className='ob');
  document.querySelectorAll(`#${gid} .ob`).forEach(b=>{if(b.dataset.val===val)b.classList.add(cls);});
  if(hid)document.getElementById(hid).value=val;
  unlockFU();
}
// v6: FU outcome buttons set the TAG on the lead (separate from notes)
function selectFUOutcome(stage,label,cls){
  const gid=`fu${stage}Opts`;
  document.querySelectorAll(`#${gid} .ob`).forEach(b=>b.className='ob');
  document.querySelectorAll(`#${gid} .ob`).forEach(b=>{if(b.dataset.val===label)b.classList.add(cls);});
  // Map the outcome label to a tag key and store in hidden pXs field
  const tagKey=resolveTagKey(label)||deriveTag({'FU1 Notes':label});
  document.getElementById(`p${stage}s`).value=tagKey;
  // Show the resulting tag in the panel header
  const td=TAG_DEFS[tagKey]||TAG_DEFS.new;
  document.getElementById('panelTagBadge').style.display='inline-flex';
  document.getElementById('panelTagBadge').style.background=td.bg;
  document.getElementById('panelTagBadge').style.color=td.color;
  document.getElementById('panelTagBadge').textContent=`${td.emoji} ${td.label}`;
  unlockFU();
}
function openWA(){
  const ph=(document.getElementById('pPhone').value||'').replace(/\D/g,'');
  if(ph)window.open('https://wa.me/91'+ph);
}
async function saveLead(){
  const ri=document.getElementById('pRI').value;const isNew=!ri;
  const today=todayISO();const ex=isNew?{}:(leads.find(l=>l._ri==ri)||{});
  const fv=id=>{const el=document.getElementById(id);return el?el.value.trim():'';};
  // Read manual tag chosen via outcome buttons (stored in hidden p1s-p4s)
  // p1s-p4s hold tagKey strings; pick the last non-empty one (most recent stage)
  const manualTag=[fv('p4s'),fv('p3s'),fv('p2s'),fv('p1s')].find(t=>t&&t.trim())||'';
  const lead={
    'Date Added':isNew?today:(ex['Date Added']||today),
    'Name':fv('pName'),'Phone':fv('pPhone'),'Agent':document.getElementById('pAgent').value,
    'Source':document.getElementById('pSource').value,'Location':fv('pLoc'),'Baby Age':fv('pAge'),
    'Shoot Type':fv('pShoot'),'FU1 Date':fv('p1d'),'FU1 Notes':fv('p1n'),
    'FU2 Date':fv('p2d'),'FU2 Notes':fv('p2n'),'FU3 Date':fv('p3d'),'FU3 Notes':fv('p3n'),
    'FU4 Date':fv('p4d'),'FU4 Notes':fv('p4n'),'General Notes':fv('pNotes'),
    'Tag':'','Stage':''
  };
  // Tag priority: 1) Manual outcome button selection, 2) auto-derive from notes, 3) previous stored tag
  lead['Tag']=manualTag||deriveTag(lead)||ex['Tag']||'';
  // Stage: Closed if tag maps to a closing outcome, else Active
  lead['Stage']=isClosed(lead)?'Closed':'Active';
  lead['_wm']=wmCheck(lead);
  if(!lead['Phone']){toast('Phone number is required','err');return;}
  // Duplicate phone check ‚Äî warn and block on new leads
  if(isNew){
    const ph=lead['Phone'].replace(/\D/g,'');
    const dup=leads.find(l=>l['Phone']&&l['Phone'].replace(/\D/g,'')===ph);
    if(dup){toast(`‚ö† Phone ${lead['Phone']} already exists ‚Äî ${dup['Name']||'(no name)'} (${dup['Tag']||'New'}). Edit that lead instead.`,'err');return;}
  }
  if(demoMode){
    if(isNew){lead._ri=leads.length+2;leads.push(lead);}
    else{const idx=leads.findIndex(l=>l._ri==ri);if(idx>=0)leads[idx]={...leads[idx],...lead};}
    toast(isNew?'Lead added (demo)':'Lead updated (demo)','ok');
    closePanel();applyFilters();updateAlertBanner();
    if(qcmActive)qcmNext();
    return;
  }
  try{
    if(isNew){
      await appendRows([leadToRow(lead)]);
      toast('Lead added!','ok');
      writeAudit('ADD',lead['Agent']||ACTIVE_AGENT,lead['Name'],lead['Phone']);
    }else{
      lead._ri=parseInt(ri);
      const prev=leads.find(l=>l._ri===parseInt(ri));
      await writeRow(lead,parseInt(ri));
      toast('Lead updated!','ok');
      // Detect tag change for audit
      const action=(prev&&prev['Tag']!==lead['Tag'])?'TAG':'EDIT';
      const detail=action==='TAG'?`Tag: ${prev['Tag']||'New'} ‚Üí ${lead['Tag']}`:'Lead updated';
      writeAudit(action,lead['Agent']||ACTIVE_AGENT,lead['Name'],lead['Phone'],detail);
    }
    closePanel();await loadLeads();
    if(qcmActive)qcmNext();
  }catch(e){toast('Save failed: '+e.message,'err');}
}
function lead_temp(fv,fuNote){
  return{'FU1 Notes':fuNote('p1n','p1s'),'FU2 Notes':fuNote('p2n','p2s'),'FU3 Notes':fuNote('p3n','p3s'),'FU4 Notes':fuNote('p4n','p4s')};
}
async function deleteLead(){
  const ri=parseInt(document.getElementById('pRI').value);
  if(!ri||!confirm('Delete this lead?'))return;
  if(demoMode){leads=leads.filter(l=>l._ri!==ri);toast('Deleted (demo)','ok');closePanel();applyFilters();return;}
  try{
    const l=leads.find(x=>x._ri===ri);
    await delRow(ri);
    toast('Deleted','ok');
    writeAudit('DELETE',ACTIVE_AGENT,l?.Name||'',l?.Phone||'');
    closePanel();await loadLeads();
  }catch(e){toast('Delete failed: '+e.message,'err');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK CALL MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startQCM(){
  if(!filtered.length){toast('No leads in current filter','err');return;}
  qcmQueue=[...filtered];qcmIdx=0;qcmActive=true;
  document.getElementById('qcmBar').classList.add('show');
  qcmShowCurrent();
}
function qcmShowCurrent(){
  if(qcmIdx<0||qcmIdx>=qcmQueue.length){qcmExit();return;}
  const l=qcmQueue[qcmIdx];
  document.getElementById('qcmProg').textContent=`${qcmIdx+1} of ${qcmQueue.length} leads`;
  openPanel(l._ri,true);
}
function qcmNext(){
  if(qcmIdx<qcmQueue.length-1){qcmIdx++;qcmShowCurrent();}
  else{toast('All leads reviewed!','ok');qcmExit();}
}
function qcmPrev(){if(qcmIdx>0){qcmIdx--;qcmShowCurrent();}}
function qcmExit(){
  qcmActive=false;qcmQueue=[];qcmIdx=0;
  document.getElementById('qcmBar').classList.remove('show');
  closePanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-TAG BACKFILL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoTagPreview(){
  const toTag=leads.filter(l=>!(l['Tag']||'').trim());
  if(!toTag.length){document.getElementById('tagPreview').innerHTML='<span style="color:var(--gr)">All leads already have tags.</span>';document.getElementById('btnRunTag').style.display='none';return;}
  document.getElementById('tagPreview').innerHTML=toTag.slice(0,20).map(l=>{
    const ti=tagInfo(l);
    return`<div class="tag-prev-row">
      <span style="font-weight:500;flex:1">${esc(l['Name']||l['Phone']||'(unknown)')}</span>
      <span class="badge badge-tag ${ti.badge}">${ti.emoji} ${ti.label}</span>
    </div>`;
  }).join('')+(toTag.length>20?`<div style="color:var(--td);font-size:11px;padding:4px 0">+${toTag.length-20} more</div>`:'');
  document.getElementById('btnRunTag').style.display='block';
  document.getElementById('btnRunTag').textContent=`Apply Tags to ${toTag.length} Leads`;
}
async function runAutoTag(){
  const toTag=leads.filter(l=>!(l['Tag']||'').trim());
  if(!toTag.length){toast('Nothing to tag','ok');return;}
  toTag.forEach(l=>l['Tag']=deriveTag(l));
  if(!demoMode){
    document.getElementById('btnRunTag').textContent='Saving‚Ä¶';document.getElementById('btnRunTag').disabled=true;
    try{for(const l of toTag)await writeRow(l,l._ri);toast(`${toTag.length} leads tagged!`,'ok');}
    catch(e){toast('Tag write failed: '+e.message,'err');}
    document.getElementById('btnRunTag').disabled=false;
  } else {toast(`${toTag.length} leads tagged (demo)!`,'ok');}
  applyFilters();document.getElementById('btnRunTag').style.display='none';
  document.getElementById('tagPreview').innerHTML='<span style="color:var(--gr)">Done! All leads tagged.</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORT + POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTING ‚Äî Comprehensive Dashboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let REPORT_RANGE={from:'',to:'',preset:'today'};

function setReportRange(preset){
  const today=new Date();
  const fd=document.getElementById('reportFrom');
  const td=document.getElementById('reportTo');
  REPORT_RANGE.preset=preset;
  
  // Clear all chip active states
  ['rp-today','rp-yesterday','rp-week','rp-month','rp-7d','rp-30d'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.classList.remove('active');
  });
  
  if(preset==='custom'){
    REPORT_RANGE.from=fd.value;
    REPORT_RANGE.to=td.value;
  }else{
    const btn=document.getElementById('rp-'+preset);
    if(btn)btn.classList.add('active');
    
    if(preset==='today'){
      REPORT_RANGE.from=REPORT_RANGE.to=todayISO();
    }else if(preset==='yesterday'){
      const y=new Date(today);y.setDate(y.getDate()-1);
      REPORT_RANGE.from=REPORT_RANGE.to=y.toISOString().split('T')[0];
    }else if(preset==='week'){
      const start=new Date(today);
      start.setDate(today.getDate()-today.getDay()); // Sunday
      REPORT_RANGE.from=start.toISOString().split('T')[0];
      REPORT_RANGE.to=todayISO();
    }else if(preset==='month'){
      REPORT_RANGE.from=new Date(today.getFullYear(),today.getMonth(),1).toISOString().split('T')[0];
      REPORT_RANGE.to=todayISO();
    }else if(preset==='7d'){
      const start=new Date(today);start.setDate(today.getDate()-6);
      REPORT_RANGE.from=start.toISOString().split('T')[0];
      REPORT_RANGE.to=todayISO();
    }else if(preset==='30d'){
      const start=new Date(today);start.setDate(today.getDate()-29);
      REPORT_RANGE.from=start.toISOString().split('T')[0];
      REPORT_RANGE.to=todayISO();
    }
    
    fd.value=REPORT_RANGE.from;
    td.value=REPORT_RANGE.to;
  }
  
  renderReport();
}

function renderReport(){
  if(!REPORT_RANGE.from)setReportRange('today'); // Initialize on first load
  
  const inRange=ds=>{
    const dt=parseDate(ds);
    if(!dt)return false;
    const iso=dt.toISOString().split('T')[0];
    return iso>=REPORT_RANGE.from && iso<=REPORT_RANGE.to;
  };
  
  // Core filters
  const newLeads=leads.filter(l=>inRange(l['Date Added']));
  const fuActivity=leads.filter(l=>['FU1 Date','FU2 Date','FU3 Date','FU4 Date'].some(k=>inRange(l[k])));
  const booked=leads.filter(l=>getTag(l)==='booked');
  const lost=leads.filter(l=>getTag(l)==='cold');
  const active=leads.filter(l=>!isClosed(l));
  const noName=leads.filter(l=>!(l['Name']||'').trim());
  
  // Stat card helper
  const sc=(val,label,hint,arr,color='')=>`
    <div class="sc ${arr.length?'clickable':''}" onclick="${arr.length?`showPopup('${esc(label)}',${JSON.stringify(arr.map(l=>l._ri))})`:''}" style="${color?'border-color:'+color:''}">
      <div class="sv" style="${color?'color:'+color:''}">${val}</div>
      <div class="sl">${label}</div>${hint?`<div class="sa">${hint}</div>`:''}
    </div>`;
  
  // Top stats
  const rangeLabel=REPORT_RANGE.from===REPORT_RANGE.to?REPORT_RANGE.from:`${REPORT_RANGE.from} to ${REPORT_RANGE.to}`;
  document.getElementById('reportStats').innerHTML=
    sc(newLeads.length,'New Leads',rangeLabel,newLeads)+
    sc(fuActivity.length,'FU Activity',rangeLabel,fuActivity)+
    sc(booked.length,'Total Booked','all time',booked,'var(--t-booked)')+
    sc(lost.length,'Total Lost','all time',lost,'var(--t-cold)')+
    sc(active.length,'Active Pipeline','right now',active)+
    sc(noName.length,'No Name Yet','needs cleanup',noName,'var(--t-oop)');
  
  // Agent Workload
  const agentData={};
  CFG.agents.forEach(a=>agentData[a]={new:0,fu:0,converted:0,lost:0,active:0});
  agentData['Unassigned']={new:0,fu:0,converted:0,lost:0,active:0};
  
  newLeads.forEach(l=>{
    const a=l['Agent']||'Unassigned';
    if(!agentData[a])agentData[a]={new:0,fu:0,converted:0,lost:0,active:0};
    agentData[a].new++;
  });
  
  fuActivity.forEach(l=>{
    const a=l['Agent']||'Unassigned';
    if(!agentData[a])agentData[a]={new:0,fu:0,converted:0,lost:0,active:0};
    agentData[a].fu++;
  });
  
  leads.forEach(l=>{
    const a=l['Agent']||'Unassigned';
    if(!agentData[a])agentData[a]={new:0,fu:0,converted:0,lost:0,active:0};
    if(getTag(l)==='booked')agentData[a].converted++;
    if(getTag(l)==='cold')agentData[a].lost++;
    if(!isClosed(l))agentData[a].active++;
  });
  
  document.getElementById('reportAgentWorkload').innerHTML=`
    <h3>üë• Agent Workload</h3>
    <table class="rt">
      <tr><th>Agent</th><th>New</th><th>FUs</th><th>Converted</th><th>Lost</th><th>Active</th></tr>
      ${Object.entries(agentData).filter(([a,d])=>d.new+d.fu+d.converted+d.lost+d.active>0).map(([a,d])=>`
        <tr>
          <td style="font-weight:500">${esc(a)}</td>
          <td>${d.new||'‚Äî'}</td>
          <td>${d.fu||'‚Äî'}</td>
          <td style="color:var(--t-booked)">${d.converted||'‚Äî'}</td>
          <td style="color:var(--t-cold)">${d.lost||'‚Äî'}</td>
          <td><strong>${d.active}</strong></td>
        </tr>
      `).join('')||'<tr><td colspan="6" style="color:var(--td);padding:9px">No agent activity</td></tr>'}
    </table>`;
  
  // Source Performance
  const sourceData={};
  newLeads.forEach(l=>{
    const s=l['Source']||'Unknown';
    if(!sourceData[s])sourceData[s]={leads:0,booked:0,avgDays:0,days:[]};
    sourceData[s].leads++;
    if(getTag(l)==='booked'){
      sourceData[s].booked++;
      const daysDiff=Math.floor((parseDate(l['FU4 Date']||l['FU3 Date']||l['FU2 Date']||l['FU1 Date']||l['Date Added'])-parseDate(l['Date Added']))/86400000);
      if(daysDiff>=0)sourceData[s].days.push(daysDiff);
    }
  });
  
  Object.keys(sourceData).forEach(s=>{
    const d=sourceData[s].days;
    sourceData[s].avgDays=d.length?(d.reduce((a,b)=>a+b,0)/d.length).toFixed(1):0;
  });
  
  document.getElementById('reportSourcePerf').innerHTML=`
    <h3>üìä Source Performance <span style="font-size:11px;color:var(--td);font-weight:400">(${rangeLabel})</span></h3>
    <table class="rt">
      <tr><th>Source</th><th>Leads</th><th>Booked</th><th>Conv %</th><th>Avg Days</th></tr>
      ${Object.entries(sourceData).sort((a,b)=>b[1].leads-a[1].leads).map(([s,d])=>{
        const convPct=d.leads?(d.booked/d.leads*100).toFixed(1):0;
        return`<tr>
          <td style="font-weight:500">${esc(s)}</td>
          <td>${d.leads}</td>
          <td style="color:var(--t-booked)">${d.booked||'‚Äî'}</td>
          <td><strong>${convPct}%</strong></td>
          <td>${d.avgDays?d.avgDays+'d':'‚Äî'}</td>
        </tr>`;
      }).join('')||'<tr><td colspan="5" style="color:var(--td);padding:9px">No source data</td></tr>'}
    </table>`;
  
  // Lead Quality Metrics
  const totalContacted=leads.length;
  const totalBooked=booked.length;
  const convRate=totalContacted?(totalBooked/totalContacted*100).toFixed(1):0;
  const responded=leads.filter(l=>l['FU1 Notes']||l['FU2 Notes']||l['FU3 Notes']||l['FU4 Notes']).length;
  const responseRate=totalContacted?(responded/totalContacted*100).toFixed(1):0;
  
  const bookedWithDates=booked.filter(l=>l['Date Added']&&(l['FU4 Date']||l['FU3 Date']||l['FU2 Date']||l['FU1 Date']));
  const avgConvDays=bookedWithDates.length
    ?(bookedWithDates.reduce((sum,l)=>{
      const start=parseDate(l['Date Added']);
      const end=parseDate(l['FU4 Date']||l['FU3 Date']||l['FU2 Date']||l['FU1 Date']);
      return sum+(end-start)/86400000;
    },0)/bookedWithDates.length).toFixed(1)
    :0;
  
  document.getElementById('reportQuality').innerHTML=`
    <h3>üìà Lead Quality Metrics <span style="font-size:11px;color:var(--td);font-weight:400">(all time)</span></h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
      <div style="background:var(--sf2);padding:14px;border-radius:8px;border:1px solid var(--bd)">
        <div style="font-size:24px;font-weight:600;color:var(--t-booked)">${convRate}%</div>
        <div style="font-size:11px;color:var(--tm);margin-top:2px">Conversion Rate</div>
        <div style="font-size:10px;color:var(--td);margin-top:4px">${totalBooked} booked / ${totalContacted} total</div>
      </div>
      <div style="background:var(--sf2);padding:14px;border-radius:8px;border:1px solid var(--bd)">
        <div style="font-size:24px;font-weight:600;color:var(--t-int)">${responseRate}%</div>
        <div style="font-size:11px;color:var(--tm);margin-top:2px">Response Rate</div>
        <div style="font-size:10px;color:var(--td);margin-top:4px">${responded} responded / ${totalContacted} contacted</div>
      </div>
      <div style="background:var(--sf2);padding:14px;border-radius:8px;border:1px solid var(--bd)">
        <div style="font-size:24px;font-weight:600;color:var(--ac)">${avgConvDays}</div>
        <div style="font-size:11px;color:var(--tm);margin-top:2px">Avg Days to Convert</div>
        <div style="font-size:10px;color:var(--td);margin-top:4px">From first contact to booking</div>
      </div>
      <div style="background:var(--sf2);padding:14px;border-radius:8px;border:1px solid var(--bd)">
        <div style="font-size:24px;font-weight:600;color:var(--t-cold)">${lost.length}</div>
        <div style="font-size:11px;color:var(--tm);margin-top:2px">Lost Leads</div>
        <div style="font-size:10px;color:var(--td);margin-top:4px">Tagged as cold/not interested</div>
      </div>
    </div>`;
  
  // FU Activity Breakdown (for selected range)
  const fm={};
  [['FU1 Date','FU1 Notes',CFG.fuLabels[0]],['FU2 Date','FU2 Notes',CFG.fuLabels[1]],['FU3 Date','FU3 Notes',CFG.fuLabels[2]],['FU4 Date','FU4 Notes',CFG.fuLabels[3]]].forEach(([dk,nk,label])=>{
    leads.filter(l=>inRange(l[dk])&&l[nk]).forEach(l=>{
      const k=`${label} ‚Üí ${(l[nk]||'').slice(0,30)}`;
      fm[k]=(fm[k]||{count:0,ris:[]});
      fm[k].count++;
      fm[k].ris.push(l._ri);
    });
  });
  
  document.getElementById('reportByFU').innerHTML=`
    <h3>üìû Follow-up Activity Breakdown <span style="font-size:11px;color:var(--td);font-weight:400">(${rangeLabel})</span></h3>
    <table class="rt">
      <tr><th>Stage / Outcome</th><th>Count</th></tr>
      ${Object.entries(fm).sort((a,b)=>b[1].count-a[1].count).map(([k,{count,ris}])=>`
        <tr class="rlink" onclick="showPopup('${esc(k)}',${JSON.stringify(ris)})">
          <td>${esc(k)}</td><td><strong>${count}</strong> ‚Üó</td>
        </tr>
      `).join('')||'<tr><td colspan="2" style="color:var(--td);padding:9px">No FU activity in this range</td></tr>'}
    </table>`;
}

function showPopup(title,ris){
  popupCurrentRis=[...ris];
  const pl=leads.filter(l=>ris.includes(l._ri));
  document.getElementById('popupTitle').textContent=`${title} (${pl.length})`;
  document.getElementById('popupBody').innerHTML=pl.length
    ?pl.map(l=>{const ti=tagInfo(l);return`<div class="popup-row" onclick="closePopup();openPanel(${l._ri})">
      <div style="flex:1"><div style="font-weight:500;font-size:13px">${esc(l['Name']||'(no name)')} <span style="color:var(--tm);font-weight:400;font-size:12px">${esc(l['Phone']||'')}</span></div>
      <div style="font-size:12px;color:var(--tm)">${esc(trunc(getLastNote(l),55))}</div></div>
      <span class="badge badge-tag ${ti.badge}" style="font-size:10px">${ti.emoji} ${ti.label}</span>
      <div style="font-size:11px;color:var(--td);white-space:nowrap">${fmtDate(l['Date Added'])}</div>
    </div>`;}).join('')
    :'<div style="padding:30px;text-align:center;color:var(--tm)">No leads found</div>';
  document.getElementById('popupOv').classList.add('open');
}
function closePopup(){document.getElementById('popupOv').classList.remove('open');}
function exportPopupList(){
  if(!popupCurrentRis.length)return;
  const pl=leads.filter(l=>popupCurrentRis.includes(l._ri));
  exportLeadList(pl,'popup_export');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportLeadList(list,filename){
  if(!list.length){toast('Nothing to export','err');return;}
  const rows=[FIELDS,...list.map(l=>FIELDS.map(f=>l[f]||''))];
  const csv=rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=filename+'_'+todayISO()+'.csv';a.click();
  toast('Exported!','ok');
}
function exportFiltered(tab){
  if(tab==='active')exportLeadList(filtered,'active_leads');
  else exportLeadList(leads.filter(isClosed),'closed_leads');
}
function exportReport(){
  const d=document.getElementById('reportDate').value;
  const isoMatch=ds=>{const dt=parseDate(ds);return dt&&dt.toISOString().split('T')[0]===d;};
  const rel=leads.filter(l=>isoMatch(l['Date Added'])||['FU1 Date','FU2 Date','FU3 Date','FU4 Date'].some(k=>isoMatch(l[k])));
  exportLeadList(rel,'report_'+d);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CSV IMPORT (with duplicate detection)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openImport(){csvD=null;csvStep=1;gotoStep(1);document.getElementById('importMov').classList.add('open');}
function closeImport(){document.getElementById('importMov').classList.remove('open');}
function dvr(e){e.preventDefault();document.getElementById('dz').classList.add('dov');}
function dvl(){document.getElementById('dz').classList.remove('dov');}
function ddrop(e){e.preventDefault();dvl();procFile(e.dataTransfer.files[0]);}
function fsel(e){procFile(e.target.files[0]);}
function procFile(file){
  if(!file)return;
  const rd=new FileReader();
  rd.onload=e=>{
    csvD=parseCSV(e.target.result);
    if(!csvD.rows.length){toast('CSV appears empty','err');return;}
    document.getElementById('iinfo').textContent=`üìÑ ${file.name} ‚Äî ${csvD.rows.length} rows, ${csvD.headers.length} columns`;
    buildMapUI();gotoStep(2);
  };
  rd.readAsText(file);
}
function parseCSV(txt){
  // RFC 4180 compliant parser ‚Äî handles quoted fields with commas, newlines, escaped quotes
  function parseRow(line){
    const cols=[];let cur='',inQ=false,i=0;
    while(i<line.length){
      const c=line[i];
      if(inQ){
        if(c==='"'&&line[i+1]==='"'){cur+='"';i+=2;} // escaped quote ""
        else if(c==='"'){inQ=false;i++;}
        else{cur+=c;i++;}
      } else {
        if(c==='"'){inQ=true;i++;}
        else if(c===','){cols.push(cur.trim());cur='';i++;}
        else{cur+=c;i++;}
      }
    }
    cols.push(cur.trim());return cols;
  }
  // Join lines respecting quoted newlines (rare but RFC-correct)
  const lines=[];let buf='',inQ=false;
  for(const ch of txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n')){
    if(ch==='"')inQ=!inQ;
    if(ch==='\n'&&!inQ){lines.push(buf);buf='';}else buf+=ch;
  }
  if(buf)lines.push(buf);
  const nonEmpty=lines.filter(l=>l.trim());
  if(!nonEmpty.length)return{headers:[],rows:[]};
  const first=parseRow(nonEmpty[0]);
  const isHdr=first.some(c=>isNaN(c.replace(/[+\-\s]/g,''))&&c.length>0&&!/^\d{10,}$/.test(c.replace(/\s/g,'')));
  const headers=isHdr?first:first.map((_,i)=>`Column ${i+1}`);
  const rows=(isHdr?nonEmpty.slice(1):nonEmpty).map(parseRow).filter(r=>r.some(c=>c.trim()));
  return{headers,rows};
}
function buildMapUI(){
  const MAPPABLE=['‚Äî skip ‚Äî','Phone','Name','Agent','Source','Location','Baby Age','Shoot Type','General Notes','FU1 Notes','Date Added'];
  const auto=csvD.headers.map(h=>{const l=h.toLowerCase();
    if(/phone|mobile|number|whatsapp/.test(l))return'Phone';
    if(/name|client/.test(l))return'Name';
    if(/agent|sales/.test(l))return'Agent';
    if(/source|channel/.test(l))return'Source';
    if(/location|area|city/.test(l))return'Location';
    if(/age|baby/.test(l))return'Baby Age';
    if(/shoot|type/.test(l))return'Shoot Type';
    if(/note|comment/.test(l))return'General Notes';
    return'';});
  document.getElementById('cmb').innerHTML=csvD.headers.map((h,i)=>{
    const sample=csvD.rows.slice(0,3).map(r=>r[i]||'').filter(Boolean).join(', ');
    return`<tr><td style="font-weight:500">${esc(h)}</td>
      <td style="color:var(--tm);font-size:11px;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(sample||'‚Äî')}</td>
      <td><select id="mc${i}">${MAPPABLE.map(f=>`<option value="${f}"${auto[i]===f?' selected':''}>${f}</option>`).join('')}</select></td>
    </tr>`;}).join('');
}
function buildPreview(){
  const mapping=csvD.headers.map((_,i)=>document.getElementById(`mc${i}`).value);
  if(!mapping.includes('Phone')){toast('Please map the Phone column','err');return false;}
  // Duplicate detection
  const phoneCol=csvD.headers.findIndex((_,i)=>mapping[i]==='Phone');
  const existingPhones=new Set(leads.map(l=>(l['Phone']||'').replace(/\D/g,'')).filter(Boolean));
  const dups=csvD.rows.filter(row=>{
    const ph=(row[phoneCol]||'').replace(/\D/g,'');
    return ph&&existingPhones.has(ph);
  });
  const dupWarn=document.getElementById('dupWarn');
  if(dups.length){
    dupWarn.className='dup-warn';
    dupWarn.innerHTML=`<strong>‚ö† ${dups.length} duplicate phone number${dups.length>1?'s':''} found</strong> ‚Äî these already exist in your sheet:<br>
      <div style="margin-top:6px">${dups.slice(0,5).map(r=>`<div class="dup-row"><span style="font-family:monospace">${esc(r[phoneCol])}</span></div>`).join('')}
      ${dups.length>5?`<div style="color:var(--rd);font-size:11px">+${dups.length-5} more</div>`:''}</div>
      <div style="margin-top:6px;font-size:11px">Duplicates will be skipped on import.</div>`;
  } else {dupWarn.className='';dupWarn.innerHTML='';}
  const used=mapping.filter(m=>m&&m!=='‚Äî skip ‚Äî');
  document.getElementById('pvh').innerHTML=`<tr>${used.map(f=>`<th>${esc(f)}</th>`).join('')}<th>Date Added</th></tr>`;
  document.getElementById('pvb').innerHTML=csvD.rows.slice(0,5).map(row=>
    `<tr>${mapping.map((f,i)=>f&&f!=='‚Äî skip ‚Äî'?`<td>${esc(row[i]||'')}</td>`:'').join('')}<td>${todayISO()}</td></tr>`).join('');
  const validCount=csvD.rows.length-dups.length;
  document.getElementById('iprev').textContent=`Ready to import ${validCount} leads (${dups.length} duplicates will be skipped).`;
  return true;
}
function gotoStep(n){
  csvStep=n;[1,2,3,4].forEach(i=>{
    document.getElementById(`ist${i}`).classList.toggle('active',i===n);
    document.getElementById(`sd${i}`)?.classList.toggle('active',i===n);
  });
  document.getElementById('iback').style.display=n>1&&n<4?'block':'none';
  document.getElementById('inext').style.display=n===4?'none':'block';
  document.getElementById('inext').textContent=n===3?'‚¨Ü Import Now':'Next ‚Üí';
}
function istep(dir){
  if(dir>0){
    if(csvStep===1){toast('Please select a CSV file first','err');return;}
    if(csvStep===2){if(!buildPreview())return;gotoStep(3);return;}
    if(csvStep===3)doImport();
  }else if(csvStep>1&&csvStep<4)gotoStep(csvStep-1);
}
async function doImport(){
  const mapping=csvD.headers.map((_,i)=>document.getElementById(`mc${i}`).value);
  const phoneCol=csvD.headers.findIndex((_,i)=>mapping[i]==='Phone');
  const existingPhones=new Set(leads.map(l=>(l['Phone']||'').replace(/\D/g,'')).filter(Boolean));
  const rows=csvD.rows.filter(row=>{
    const ph=(row[phoneCol]||'').replace(/\D/g,'');
    return ph&&!existingPhones.has(ph);
  }).map(row=>{
    const l={};FIELDS.forEach(f=>l[f]='');l['Date Added']=todayISO();l['Stage']='Active';
    mapping.forEach((f,i)=>{if(f&&f!=='‚Äî skip ‚Äî')l[f]=row[i]||'';});
    l['Tag']=deriveTag(l);
    return leadToRow(l);
  });
  if(!rows.length){toast('No new leads to import (all duplicates)','err');return;}
  document.getElementById('inext').textContent='Importing‚Ä¶';document.getElementById('inext').disabled=true;
  try{
    await appendRows(rows);
    document.getElementById('importResult').textContent=`Successfully imported ${rows.length} leads!`;
    gotoStep(4);
    setTimeout(()=>{closeImport();loadLeads();},1500);
  }catch(e){toast('Import failed: '+e.message,'err');}
  document.getElementById('inext').disabled=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG / SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings(){
  renderColMap();renderAgents();renderShootList();renderSourceList();renderCustomTagList();renderFUStageSettings();
  const adi=document.getElementById('archiveDaysInput');if(adi)adi.value=CFG.archiveDays||60;
  const ssi=document.getElementById('ssi');if(ssi)ssi.value=SHEET_ID;
  const ssn=document.getElementById('ssn');if(ssn)ssn.value=SHEET_NAME;
  const ssEl=document.getElementById('settingsSheetId');if(ssEl)ssEl.value=SETTINGS_SHEET_ID||'';
  renderPipelineList();
  const tp=document.getElementById('tagPreview');if(tp)tp.innerHTML='';
  const brt=document.getElementById('btnRunTag');if(brt)brt.style.display='none';
  const ap=document.getElementById('archivePreview');if(ap)ap.innerHTML='';
  const bra=document.getElementById('btnRunArchive');if(bra)bra.style.display='none';
  const tl=document.getElementById('tabList');if(tl)tl.innerHTML='';
  const ab=document.getElementById('auditBody');if(ab)ab.innerHTML='<div style="padding:16px;color:var(--tm)">Click Refresh to load</div>';
  const as=document.getElementById('auditStatus');if(as)as.textContent='';
  updateConnHint();
  document.getElementById('settingsMov').classList.add('open');
}
function closeSettings(){document.getElementById('settingsMov').classList.remove('open');}

// SOURCES
function renderSourceList(){document.getElementById('sourceList').innerHTML=CFG.sources.map((s,i)=>`<div class="cfg-chip">${esc(s)} <button onclick="removeSource(${i})">√ó</button></div>`).join('');}
function addSource(){const v=document.getElementById('newSourceInput').value.trim();if(!v||CFG.sources.includes(v))return;CFG.sources.push(v);document.getElementById('newSourceInput').value='';renderSourceList();rebuildSourceFilter();populatePanelSource();saveConfig();}
function removeSource(i){CFG.sources.splice(i,1);renderSourceList();rebuildSourceFilter();populatePanelSource();saveConfig();}
function rebuildSourceFilter(){
  const sel=document.getElementById('fSource');const cur=sel.value;
  sel.innerHTML='<option value="">All Sources</option>'+CFG.sources.map(s=>`<option${cur===s?' selected':''}>${esc(s)}</option>`).join('');
}
function populatePanelSource(){
  const sel=document.getElementById('pSource');if(!sel)return;
  sel.innerHTML='<option value="">Select‚Ä¶</option>'+CFG.sources.map(s=>`<option>${esc(s)}</option>`).join('');
}

// CUSTOM TAGS
function renderCustomTagList(){document.getElementById('customTagList').innerHTML=CFG.customTags.map((t,i)=>{const k=resolveTagKey(t)||'new';const d=TAG_DEFS[k]||TAG_DEFS.new;return`<div class="cfg-chip"><span style="background:${d.bg};color:${d.color};border:1px solid ${d.border};border-radius:20px;padding:1px 8px;font-size:11px">${d.emoji} ${esc(t)}</span><button onclick="removeCustomTag(${i})">√ó</button></div>`;}).join('');}
function addCustomTag(){const v=document.getElementById('newTagInput').value.trim();if(!v||CFG.customTags.includes(v))return;CFG.customTags.push(v);document.getElementById('newTagInput').value='';renderCustomTagList();rebuildTagFilter();saveConfig();}
function removeCustomTag(i){CFG.customTags.splice(i,1);renderCustomTagList();rebuildTagFilter();saveConfig();}
function rebuildTagFilter(){
  const sel=document.getElementById('fTag');if(!sel)return;
  sel.innerHTML='<option value="">All Tags</option>'+CFG.customTags.map(t=>{const k=resolveTagKey(t)||'new';const d=TAG_DEFS[k]||TAG_DEFS.new;return`<option value="${k}">${d.emoji} ${esc(t)}</option>`;}).join('');
  // Always include scheduled
  sel.innerHTML+='<option value="scheduled">‚è∞ Scheduled</option>';
}

// SHOOT TYPES
function renderShootList(){document.getElementById('shootList').innerHTML=CFG.shootTypes.map((t,i)=>`<div class="cfg-chip">${esc(t)} <button onclick="removeShootType(${i})">√ó</button></div>`).join('');}
function addShootType(){const v=document.getElementById('newShootInput').value.trim();if(!v||CFG.shootTypes.includes(v))return;CFG.shootTypes.push(v);document.getElementById('newShootInput').value='';renderShootList();rebuildShootFilter();renderShootOpts();saveConfig();}
function removeShootType(i){CFG.shootTypes.splice(i,1);renderShootList();rebuildShootFilter();renderShootOpts();saveConfig();}

// AGENTS
// ‚îÄ‚îÄ AGENT MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAgents(){
  const el=document.getElementById('agentList');if(!el)return;
  if(!CFG.agents.length){el.innerHTML='<p style="font-size:12px;color:var(--tm)">No agents yet.</p>';return;}
  el.innerHTML=CFG.agents.map((a,i)=>{
    const email=CFG.agentEmails[a]||'';
    return`<div class="ach">
      <div class="ach-info">
        <span class="ach-name">${esc(a)}</span>
        ${email?`<span class="ach-email">${esc(email)}</span>`:'<span class="ach-email" style="color:var(--bd)">no email set</span>'}
      </div>
      <button onclick="rmAgent(${i})" style="background:none;border:none;color:var(--td);cursor:pointer;font-size:14px;padding:0 2px">√ó</button>
    </div>`;
  }).join('');
}
function addAgent(){
  const v=(document.getElementById('naInput')||{}).value?.trim()||'';
  const email=(document.getElementById('naEmail')||{}).value?.trim()||'';
  if(!v){toast('Enter an agent name','err');return;}
  if(CFG.agents.includes(v)){toast('Agent already exists','err');return;}
  CFG.agents.push(v);
  if(email)CFG.agentEmails[v]=email;
  if(document.getElementById('naInput'))document.getElementById('naInput').value='';
  if(document.getElementById('naEmail'))document.getElementById('naEmail').value='';
  renderAgents();popAgents();populateYaBar();saveConfig();
  toast('Agent added: '+v,'ok');
}
function rmAgent(i){
  const name=CFG.agents[i];
  CFG.agents.splice(i,1);
  delete CFG.agentEmails[name];
  if(ACTIVE_AGENT===name){ACTIVE_AGENT='';localStorage.removeItem('activeAgent');updateYaBar();}
  renderAgents();popAgents();populateYaBar();saveConfig();
}

// ‚îÄ‚îÄ YOU ARE / ACTIVE AGENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setActiveAgent(name){
  ACTIVE_AGENT=name;
  localStorage.setItem('activeAgent',name);
  updateYaBar();
}
function updateYaBar(){
  const sel=document.getElementById('yaAgent');
  const hint=document.getElementById('yaHint');
  if(!sel)return;
  if(ACTIVE_AGENT&&CFG.agents.includes(ACTIVE_AGENT)){
    sel.value=ACTIVE_AGENT;
    if(hint)hint.textContent='Agent field pre-fills as you on new leads';
  }else{
    sel.value='';
    if(hint)hint.textContent='Select your name to auto-fill agent on new leads';
  }
}
function populateYaBar(){
  const sel=document.getElementById('yaAgent');if(!sel)return;
  sel.innerHTML='<option value="">‚Äî Select your name ‚Äî</option>'+
    CFG.agents.map(a=>`<option value="${esc(a)}"${a===ACTIVE_AGENT?' selected':''}>${esc(a)}</option>`).join('');
  updateYaBar();
}

// FU STAGE SETTINGS (label + per-stage outcomes)
function renderFUStageSettings(){
  const icons=['üìû','üîÅ','üå°Ô∏è','üèÅ'];
  document.getElementById('fuStageSettings').innerHTML=CFG.fuLabels.map((label,i)=>`
    <div style="margin-bottom:14px;padding:10px;background:var(--sf2);border-radius:8px;border:1px solid var(--bd)">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <span style="font-size:16px">${icons[i]}</span>
        <label class="fl" style="width:50px">FU ${i+1}</label>
        <input class="fi2" id="fuLabelInp${i}" value="${esc(label)}" placeholder="Stage ${i+1} name" style="flex:1">
      </div>
      <div style="font-size:11px;color:var(--tm);margin-bottom:5px">Outcome buttons (comma-separated):</div>
      <textarea class="fi2" id="fuOutInp${i}" rows="2" style="font-size:12px;width:100%">${(CFG.fuOutcomes[i]||[]).join(', ')}</textarea>
    </div>`).join('');
}
function saveFUConfig(){
  CFG.fuLabels=Array.from({length:4},(_,i)=>{const el=document.getElementById(`fuLabelInp${i}`);return(el?el.value.trim():'')||['Initial Contact','Callback','Warm Follow-up','Final Follow-up'][i];});
  CFG.fuOutcomes=Array.from({length:4},(_,i)=>{const el=document.getElementById(`fuOutInp${i}`);if(!el)return[];return el.value.split(',').map(s=>s.trim()).filter(Boolean);});
  updateFUHeaders();renderFUOpts();saveConfig();toast('FU config saved ‚úì','ok');
}
function saveFULabels(){saveFUConfig();} // alias for compatibility

// COLUMN MAP
function renderColMap(){
  const el=document.getElementById('ccb');if(!el)return;
  el.innerHTML=FIELDS.map(f=>`
    <tr><td><div style="font-weight:500;font-size:13px">${esc(f)}</div><div class="cdesc">${esc(FDESC[f]||'')}</div></td>
    <td><input type="text" id="cc_${f.replace(/[\s\/]/g,'_')}" value="${CM[f]||''}" placeholder="A" maxlength="3" oninput="this.value=this.value.toUpperCase()"></td>
    <td style="color:var(--td);font-size:11px">${CM[f]?'Col '+CM[f]:'unmapped'}</td></tr>`).join('');
}
function saveColMap(){FIELDS.forEach(f=>{const el=document.getElementById(`cc_${f.replace(/[\s\/]/g,'_')}`);if(el)CM[f]=el.value.toUpperCase().trim();});saveConfig();toast('Column mapping saved ‚úì','ok');renderColMap();}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIT TRAIL ‚Äî fire-and-forget, never blocks main flow
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AUDIT_ACTIONS={ADD:'aa-add',EDIT:'aa-edit',DELETE:'aa-del',TAG:'aa-tag'};

async function writeAudit(action, agent, name, phone, detail=''){
  // Silently skip ‚Äî never throw, never block UI
  if(demoMode)return;
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(!ssId)return; // No settings sheet = no audit, that's fine
  try{
    const ts=new Date().toLocaleString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
    const row=[ts, agent||'‚Äî', action+(detail?': '+detail:''), name||'‚Äî', phone||'‚Äî'];
    // Ensure Audit tab exists ‚Äî ignore error if already exists
    try{await gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:ssId,resource:{requests:[{addSheet:{properties:{title:'Audit'}}}]}});}catch(e){}
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId:ssId,range:'Audit!A:A',
      valueInputOption:'USER_ENTERED',insertDataOption:'INSERT_ROWS',
      resource:{values:[row]}
    });
  }catch(e){
    // Silent ‚Äî audit failure must NEVER surface to user or block saves
    console.warn('Audit write failed (non-critical):',e.message);
  }
}

async function renderAuditLog(){
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  const body=document.getElementById('auditBody');
  const status=document.getElementById('auditStatus');
  if(!ssId){
    if(body)body.innerHTML='<div style="padding:16px;color:var(--td)">No Settings Sheet configured ‚Äî audit requires a Settings Sheet ID.</div>';
    return;
  }
  if(body)body.innerHTML='<div style="padding:16px;color:var(--tm)">Loading‚Ä¶</div>';
  try{
    const r=await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:ssId,range:'Audit!A:E'});
    const rows=(r.result.values||[]).filter(r=>r[0]); // skip empty
    if(!rows.length){
      if(body)body.innerHTML='<div style="padding:16px;color:var(--tm)">No audit entries yet.</div>';
      if(status)status.textContent='';
      return;
    }
    // Render newest first
    const html=[...rows].reverse().map(r=>{
      const [ts,agent,action,name,phone]=r;
      const actionKey=(action||'').split(':')[0].trim().toUpperCase();
      const cls=AUDIT_ACTIONS[actionKey]||'aa-edit';
      return`<div class="audit-row">
        <span style="color:var(--tm)">${esc(ts||'')}</span>
        <span style="font-weight:500">${esc(agent||'‚Äî')}</span>
        <span><span class="audit-action ${cls}">${esc(actionKey)}</span> <span style="color:var(--tm);font-size:11px">${esc((action||'').replace(actionKey,'').replace(/^: /,''))}</span></span>
        <span style="color:var(--tm)">${esc(name||'')} ${phone?'<span style="font-size:10px">'+esc(phone)+'</span>':''}</span>
      </div>`;
    }).join('');
    if(body)body.innerHTML=html;
    if(status)status.textContent=rows.length+' entries';
  }catch(e){
    if(body)body.innerHTML=`<div style="padding:16px;color:var(--rd)">Could not load audit: ${esc(e.message)}</div>`;
  }
}

async function pruneAudit(){
  const ssId=SETTINGS_SHEET_ID||localStorage.getItem('settingsSheetId')||'';
  if(!ssId){toast('No Settings Sheet configured','err');return;}
  const status=document.getElementById('auditStatus');
  if(status)status.textContent='Pruning‚Ä¶';
  try{
    const r=await gapi.client.sheets.spreadsheets.values.get({spreadsheetId:ssId,range:'Audit!A:E'});
    const rows=r.result.values||[];
    if(!rows.length){toast('Audit log is empty','ok');return;}
    const cutoff=new Date();cutoff.setDate(cutoff.getDate()-7);
    // Keep rows that are within 7 days OR can't be parsed (keep safe)
    const keep=rows.filter(row=>{
      try{
        const d=new Date(row[0]);
        return isNaN(d.getTime())||d>=cutoff;
      }catch(e){return true;}
    });
    const removed=rows.length-keep.length;
    if(!removed){toast('No entries older than 7 days found','ok');if(status)status.textContent='';return;}
    // Rewrite the Audit sheet with kept rows
    await gapi.client.sheets.spreadsheets.values.clear({spreadsheetId:ssId,range:'Audit!A:E'});
    if(keep.length){
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId:ssId,range:'Audit!A1',
        valueInputOption:'USER_ENTERED',resource:{values:keep}
      });
    }
    toast(`Pruned ${removed} old audit entries ‚úì`,'ok');
    renderAuditLog();
  }catch(e){toast('Prune failed: '+e.message,'err');}
}

function saveConn(){
  SHEET_ID=(document.getElementById('ssi')||{}).value?.trim()||SHEET_ID;
  SHEET_NAME=(document.getElementById('ssn')||{}).value?.trim()||'Leads';
  localStorage.setItem('ss2',SHEET_ID);localStorage.setItem('sn2',SHEET_NAME);
  toast('Saved! Reloading leads‚Ä¶','ok');closeSettings();loadLeads();
}
function updateConnHint(){
  const hint=document.getElementById('connHint');if(!hint)return;
  const sn=(document.getElementById('ssn')||{}).value?.trim()||'';
  if(sn)hint.textContent='Will read from tab: "'+sn+'" (must match exactly ‚Äî case-sensitive)';
  else hint.textContent='';
}
async function listTabs(){
  const sid=(document.getElementById('ssi')||{}).value?.trim()||SHEET_ID;
  const tl=document.getElementById('tabList');if(tl)tl.innerHTML='Loading‚Ä¶';
  try{
    const r=await gapi.client.sheets.spreadsheets.get({spreadsheetId:sid});
    const names=(r.result.sheets||[]).map(s=>s.properties.title);
    if(tl)tl.innerHTML='<strong>Available tabs:</strong> '+names.map(n=>`<span style="background:var(--sf2);padding:2px 8px;border-radius:4px;margin:2px;display:inline-block;cursor:pointer" onclick="document.getElementById('ssn').value='${n.replace(/'/g,"\\'")}'">üìÑ ${n}</span>`).join(' ');
  }catch(e){
    let detail=e.message||'Error';
    try{const b=JSON.parse(e.body||'{}');detail=(b.error?.message||detail);}catch(pe){}
    if(tl)tl.innerHTML='<span style="color:var(--rd)">Could not list tabs: '+detail+'</span>';
  }
}

// ‚îÄ‚îÄ ARCHIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let archivedLeads=[];
function previewArchive(){
  CFG.archiveDays=parseInt(document.getElementById('archiveDaysInput').value)||60;
  const candidates=leads.filter(l=>!isClosed(l)&&!l._archived&&isArchiveable(l));
  const el=document.getElementById('archivePreview');
  if(!candidates.length){el.innerHTML='<div style="font-size:12px;color:var(--tm);padding:6px 0">No leads qualify for archiving right now.</div>';document.getElementById('btnRunArchive').style.display='none';return;}
  el.innerHTML=`<div style="font-size:12px;color:var(--or);padding:6px 0;line-height:1.7"><strong>${candidates.length} lead${candidates.length!==1?'s':''}</strong> will be archived (${CFG.archiveDays}+ days old, no future FU date):<br>
    ${candidates.slice(0,5).map(l=>`<span class="cfg-chip" style="background:rgba(232,145,74,.07)">${esc(l['Name']||l['Phone']||'unknown')} ¬∑ ${leadAgeDays(l)}d old</span>`).join(' ')}
    ${candidates.length>5?`<span style="color:var(--td)">+${candidates.length-5} more</span>`:''}
  </div>`;
  document.getElementById('btnRunArchive').style.display='inline-flex';
}
async function runArchive(){
  CFG.archiveDays=parseInt(document.getElementById('archiveDaysInput').value)||60;
  const candidates=leads.filter(l=>!isClosed(l)&&!l._archived&&isArchiveable(l));
  if(!candidates.length){toast('Nothing to archive','err');return;}
  candidates.forEach(l=>l._archived=true);
  archivedLeads=[...archivedLeads,...candidates];
  if(!demoMode){
    sync(true);
    // Write 'Archive' tag to sheet so they're flagged
    await Promise.all(candidates.map(l=>{l['Stage']='Archived';return writeRow(l,l._ri);}));
    sync(false);
  }
  toast(`${candidates.length} leads archived ‚úì`,'ok');
  document.getElementById('btnRunArchive').style.display='none';
  document.getElementById('archivePreview').innerHTML='';
  applyFilters();renderArchive();switchTab('archive');closeSettings();
}
function renderArchive(){
  const search=(document.getElementById('archiveSearch')?.value||'').toLowerCase();
  const rows=archivedLeads.filter(l=>!search||(l['Name']||'').toLowerCase().includes(search)||(l['Phone']||'').toLowerCase().includes(search));
  const tb=document.getElementById('archiveBody');
  if(!rows.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--tm)">No archived leads</td></tr>';return;}
  tb.innerHTML=rows.map(l=>{
    const t=getTag(l);const d=TAG_DEFS[t]||TAG_DEFS.new;
    return`<tr style="opacity:.8">
      <td><div class="ln">${esc(l['Name']||'(no name)')}</div><div class="lp">${esc(l['Phone']||'')}</div></td>
      <td><span class="badge bs">${esc(l['Shoot Type']||'‚Äî')}</span></td>
      <td style="color:var(--tm);font-size:12px">${esc(l['Agent']||'‚Äî')}</td>
      <td>${tagHTML(l)}</td>
      <td style="font-size:12px;color:var(--tm)">${esc(trunc(getLastNote(l)))}</td>
      <td style="font-size:12px;color:var(--tm)">${fmtDate(l['Date Added'])}</td>
      <td>${ageBadge(l)}</td>
    </tr>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initUI(){rebuildShootFilter();renderShootOpts();renderFUOpts();popAgents();initColToggles();updateFUHeaders();populateBulkAgents();rebuildSourceFilter();populatePanelSource();rebuildTagFilter();populateYaBar();}
function rebuildShootFilter(){const sel=document.getElementById('fShoot');const cur=sel.value;sel.innerHTML='<option value="">All Shoots</option>'+CFG.shootTypes.map(t=>`<option${cur===t?' selected':''}>${esc(t)}</option>`).join('');}
function renderShootOpts(){document.getElementById('shootOpts').innerHTML=CFG.shootTypes.map(t=>`<button class="ob" data-val="${esc(t)}" onclick="selectOB('shootOpts','${esc(t)}','sb','pShoot')">${esc(t)}</button>`).join('');}
function updateFUHeaders(){
  const icons=['üìû','üîÅ','üå°Ô∏è','üèÅ'];
  ['fu1label','fu2label','fu3label','fu4label'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.textContent=icons[i]+' '+CFG.fuLabels[i];});
}
function renderFUOpts(){
  // Outcome buttons now set the TAG field (not fill notes) ‚Äî notes are for free-text comments
  CFG.fuOutcomes.forEach((opts,i)=>{
    const stageEl=document.getElementById(`fu${i+1}Opts`);
    if(!stageEl)return;
    stageEl.innerHTML=opts.map(label=>{
      const c=outcomeColor(label);
      return`<button class="ob ${c}" data-val="${esc(label)}"
        onclick="selectFUOutcome(${i+1},'${esc(label)}','${c}')">${esc(label)}</button>`;
    }).join('');
  });
}
function updateFUHeaders(){
  const icons=['üìû','üîÅ','üå°Ô∏è','üèÅ'];
  ['fu1label','fu2label','fu3label','fu4label'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.textContent=icons[i]+' '+CFG.fuLabels[i];});
}
function popAgents(){
  ['fAgent','pAgent'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    const blank=id==='fAgent'?'<option value="">All Agents</option>':'<option value="">Select agent</option>';
    el.innerHTML=blank+CFG.agents.map(a=>`<option>${esc(a)}</option>`).join('');
  });
  populateYaBar();
}
function populateBulkAgents(){
  const sel=document.getElementById('bulkAgent');
  sel.innerHTML='<option value="">Assign Agent‚Ä¶</option>'+CFG.agents.map(a=>`<option>${esc(a)}</option>`).join('');
}
function switchTab(t){
  document.querySelectorAll('.tc').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tb').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick')?.includes(`'${t}'`)));
  const tc=document.getElementById(`tab-${t}`);if(tc)tc.classList.add('active');
  const isActive=t==='active';
  document.getElementById('filterBar').style.display=isActive?'flex':'none';
  document.getElementById('filterBar2').style.display=isActive?'flex':'none';
  const bb=document.getElementById('bulkBar');if(bb)bb.className=isActive&&selectedRis.size>0?'bulk-bar show':'bulk-bar';
  if(t==='report')renderReport();
  if(t==='archive')renderArchive();
}
let tt;
function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast show ${type}`;clearTimeout(tt);tt=setTimeout(()=>t.classList.remove('show'),3200);}
function sync(v){document.getElementById('syncStatus').innerHTML=v?'<span class="sync-dot"></span> syncing‚Ä¶':'';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateDemoLeads(){
  const t=todayISO(),yd=daysAgoISO(1),w=daysAgoISO(6),jan15='15/01/2026';
  const mk=(ri,da,nm,ph,ag,src,loc,ba,sh,f1d,f1n,f2d,f2n,f3d,f3n,f4d,f4n,gn)=>{
    const l={_ri:ri,'Date Added':da,'Name':nm,'Phone':ph,'Agent':ag,'Source':src,'Location':loc,'Baby Age':ba,'Shoot Type':sh,'FU1 Date':f1d,'FU1 Notes':f1n,'FU2 Date':f2d,'FU2 Notes':f2n,'FU3 Date':f3d,'FU3 Notes':f3n,'FU4 Date':f4d,'FU4 Notes':f4n,'General Notes':gn,'Tag':'','Stage':'Active'};
    l['Tag']=deriveTag(l);l._wm=wmCheck(l);return l;
  };
  return[
    mk(2,jan15,'Priya Sharma','9876543210','Rajshree','Whatsapp','Pimpri','3 months','Baby Milestone','16/01/2026','Interested','22/01/2026','Still Interested','','','','','Hot lead'),
    mk(3,jan15,'','9123456780','Rashmi','Instagram','','Newborn','Newborn','16/01/2026','No Response','','','','','','',''),
    mk(4,w,'Anita Joshi','9871234560','Rajshree','Whatsapp','Pune','8 months','Baby Milestone',w,'Interested',yd,'Still Interested',t,'','','',''),
    mk(5,jan15,'Rahul Patil','8899001122','Rajshree','Facebook','Nagpur','','Family','16/01/2026','Not Interested','','','','','','',''),
    mk(6,t,'Kavya Singh','9900112233','Rashmi','Google','Pune','5 months','Baby Milestone',t,'Sent Package Details','','','','','','',''),
    mk(7,yd,'','7766554433','Rajshree','Whatsapp','Pimpri','','Maternity',yd,'Call Later',t,'','','','','',''),
    mk(8,'10/01/2026','Suresh More','9988776655','Ravi','Referral','Hadapsar','Newborn','Newborn','11/01/2026','Booked','','','','','','','Confirmed session'),
    mk(9,'12/01/2026','Deepika Roy','8877665544','Rashmi','Instagram','Aundh','2 months','Newborn','13/01/2026','Budget Issue','14/01/2026','Lost Lead','','','','',''),
    mk(10,t,'','6655443322','','Whatsapp','','','','','','','','','','','',''),
    mk(11,w,'Meena Das','9911223344','Ravi','Whatsapp','Pune','6 months','Baby Milestone',w,'Interested',t,'','','','','',''),
    mk(12,jan15,'Gurukrupa Naik','9158243139','Rajshree','Whatsapp','Swargate','1 year','Baby Milestone','17/01/2026','Interested','18/01/2026','voice mail','','','','',''),
    mk(13,jan15,'Neha Kulkarni','9960015204','Rashmi','Whatsapp','Chakan','6 months','Baby Milestone','17/01/2026','Interested','18/01/2026','cancel shoot','','','','',''),
    mk(14,daysAgoISO(20),'Sonal Mehta','9812345670','Rajshree','Instagram','Pune','3 months','Newborn',daysAgoISO(19),'Interested',daysAgoISO(16),'Still Interested',daysAgoISO(13),'No Response','','',''),
  ];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNIT TESTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runTests(){
  const results=[];let pass=0,fail=0;
  function assert(name,cond){const ok=!!cond;results.push({name,ok});if(ok)pass++;else fail++;}
  function group(name){results.push({group:name});}

  // ‚îÄ‚îÄ DATE PARSING (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Date Parsing');
  assert('DD/MM/YYYY',parseDate('15/01/2026')?.getFullYear()===2026);
  assert('DD/MM/YY',parseDate('15/01/26')?.getFullYear()===2026);
  assert('YYYY-MM-DD',parseDate('2026-01-15')?.getMonth()===0);
  assert('Empty = null',parseDate('')===null);
  assert('Garbage = null',parseDate('notadate')===null);
  assert('toISO converts',toISO('15/01/2026')==='2026-01-15');
  assert('toISO empty',toISO('')==='');
  assert('daysAgoISO(0) = today',daysAgoISO(0)===todayISO());
  assert('daysAgoISO(1) < today',daysAgoISO(1)<todayISO());
  assert('dateInRange: within',dateInRange('15/01/2026','2026-01-10','2026-01-20'));
  assert('dateInRange: before from',!dateInRange('05/01/2026','2026-01-10','2026-01-20'));
  assert('dateInRange: no range = true',dateInRange('15/01/2026','',''));
  assert('dateInRange: null date+range = false',!dateInRange('','2026-01-10','2026-01-20'));

  // ‚îÄ‚îÄ COLUMN MAPPING (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Column Mapping');
  assert('Date Added = index 0',ci('Date Added')===0);
  assert('Name = index 2',ci('Name')===2);
  assert('Phone = index 3',ci('Phone')===3);
  assert('Agent = index 7',ci('Agent')===7);
  assert('FU1 Date = index 8',ci('FU1 Date')===8);
  assert('n2l(0)=A',n2l(0)==='A');assert('n2l(25)=Z',n2l(25)==='Z');assert('n2l(26)=AA',n2l(26)==='AA');
  assert('rowToLead correct',(()=>{const r=['15/01/2026','Whatsapp','Priya','9876543210','Newborn','Pimpri','3m','Rajshree'];const l=rowToLead(r);return l['Name']==='Priya'&&l['Phone']==='9876543210';})());
  assert('leadToRow roundtrip',(()=>{const lead={};FIELDS.forEach(f=>lead[f]='');lead['Name']='Test';lead['Phone']='9999';const back=rowToLead(leadToRow(lead));return back['Name']==='Test';})());

  // ‚îÄ‚îÄ TAG SYSTEM (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Auto-tag: deriveTag');
  assert('Booked = booked',deriveTag({'FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='booked');
  assert('Lost Lead = cold',deriveTag({'FU1 Notes':'Lost Lead','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='cold');
  assert('Not Interested = cold',deriveTag({'FU1 Notes':'Not Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='cold');
  assert('Cancelled = cold',deriveTag({'FU1 Notes':'Cancelled','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='cold');
  assert('No Response = nore',deriveTag({'FU1 Notes':'No Response','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='nore');
  assert('CNR = nore',deriveTag({'FU1 Notes':'CNR msg sent','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='nore');
  assert('Call Busy = nore',deriveTag({'FU1 Notes':'Call Busy','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='nore');
  assert('Voice Mail = nore',deriveTag({'FU1 Notes':'Voice Mail','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='nore');
  assert('Budget Issue = nore',deriveTag({'FU1 Notes':'Budget Issue','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='nore');
  assert('Interested = int',deriveTag({'FU1 Notes':'Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='int');
  assert('Still Interested = int',deriveTag({'FU2 Notes':'Still Interested','FU1 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='int');
  assert('Not Interested NOT int',deriveTag({'FU1 Notes':'Not Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})!=='int');
  assert('Sent Package = warm',deriveTag({'FU1 Notes':'Sent Package Details','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='warm');
  assert('Call Later = warm',deriveTag({'FU1 Notes':'Call Later','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='warm');
  assert('Future Plan = warm',deriveTag({'FU1 Notes':'Future Plan','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='warm');
  assert('Out of Pune = oop',deriveTag({'FU1 Notes':'Out of Pune','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='oop');
  assert('Outsider = oop',deriveTag({'FU1 Notes':'Not from Pune','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='oop');
  assert('Invalid = inv',deriveTag({'FU1 Notes':'Invalid Number','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='inv');
  assert('Shoot Done = done',deriveTag({'FU4 Notes':'Shoot Done','FU1 Notes':'','FU2 Notes':'','FU3 Notes':'','General Notes':''})==='done');
  assert('Empty = new',deriveTag({'FU1 Notes':'','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''})==='new');
  assert('Last note wins: FU4 overrides FU1',deriveTag({'FU1 Notes':'Interested','FU2 Notes':'No Response','FU3 Notes':'','FU4 Notes':'Booked','General Notes':''})==='booked');
  assert('FU4 cold overrides FU1 interest',deriveTag({'FU1 Notes':'Interested','FU4 Notes':'Lost Lead','FU2 Notes':'','FU3 Notes':'','General Notes':''})==='cold');

  group('Auto-tag: getTag + stored override');
  assert('Stored tag used when valid',(()=>{const l={Tag:'int','FU1 Notes':'No Response','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''};return getTag(l)==='int';})());
  assert('Invalid stored tag falls back to derived',(()=>{const l={Tag:'garbage','FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''};return getTag(l)==='booked';})());
  assert('Empty tag falls back to derived',(()=>{const l={Tag:'','FU1 Notes':'Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''};return getTag(l)==='int';})());
  assert('tagInfo returns correct dot class',(()=>{const l={'FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':'','General Notes':''};return tagInfo(l).dot==='dg';})());
  assert('tagInfo booked has correct badge',(()=>{const l={'FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':'','General Notes':''};return tagInfo(l).badge==='btag-booked';})());
  assert('All TAG_DEFS have required fields (badge fix)',Object.values(TAG_DEFS).every(d=>d.label&&d.emoji&&d.dot&&d.badge&&d.bg&&d.color));
  // ‚îÄ‚îÄ REAL SHEET NOTE PATTERNS (v6.1 regression tests) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Real Sheet Note Patterns ‚Äî LilliputLand');
  // These are the exact note strings from the actual sheet
  function mk(fu1,notes='',fu2='',fu3=''){return{'FU1 Notes':fu1,'General Notes':notes,'FU2 Notes':fu2,'FU3 Notes':fu3,'FU4 Notes':'','Tag':''};}
  assert('CNR/Voice Mail ‚Üí noresponse',deriveTag(mk('No Response/CNR msg sent/Call Busy/Voice Mail'))==='noresponse');
  assert('CNA ‚Üí noresponse',deriveTag(mk('CNA'))==='noresponse');
  assert('Not from Pune/Outsider ‚Üí outofarea',deriveTag(mk('Not from Pune/Outsider'))==='outofarea');
  assert('Not Interested/Call Disconnected ‚Üí cold',deriveTag(mk('Not Interested/Call Disconnected'))==='cold');
  assert('Invalid Number/Call on Whatsapp ‚Üí invalid',deriveTag(mk('Invalid Number/Call on Whatsapp/No incoming calls'))==='invalid');
  assert('Shoot done/No Requirement ‚Üí done',deriveTag(mk('Shoot done/No Requirement'))==='done');
  assert('Interested ‚Üí interested',deriveTag(mk('Interested'))==='interested');
  assert('Details Shared ‚Üí interested',deriveTag(mk('Details Shared'))==='interested');
  assert('Sent Package Details ‚Üí interested',deriveTag(mk('Sent Package Details'))==='interested');
  assert('Budget Issue ‚Üí cold',deriveTag(mk('Budget Issue'))==='cold');
  assert('Asked me to call later ‚Üí warm',deriveTag(mk('Asked me to call later.'))==='warm');
  assert('Plan for next Month ‚Üí warm',deriveTag(mk('Plan for next Month'))==='warm');
  assert('Out of Pune (FU2) ‚Üí outofarea',(()=>{const l=mk('No Response/CNR','','out of pune msg send','');return deriveTag(l)==='outofarea';})());
  assert('NoResponse/CNRmsgsent/VoiceMail ‚Üí noresponse',deriveTag(mk('NoResponse/CNRmsgsent/VoiceMail'))==='noresponse');
  assert('Out of service/network ‚Üí invalid',deriveTag(mk('Out of service/network/not reachable'))==='invalid');
  assert('Call Disconnected alone ‚Üí cold',deriveTag(mk('Call Disconnected'))==='cold');
  assert('Not Intrested (typo) ‚Üí cold',deriveTag(mk('Not Intrested'))==='cold');
  assert('Booking confirmed ‚Üí booked',deriveTag(mk('Booking confirmed'))==='booked');
  assert('Call busy ‚Üí noresponse',deriveTag(mk('Call busy'))==='noresponse');
  assert('Switched off ‚Üí noresponse',deriveTag(mk('Switched off'))==='noresponse');
  assert('Will visit studio ‚Üí warm',deriveTag(mk('Will visit studio'))==='warm');
  assert('Passed to MP ‚Üí outofarea',deriveTag(mk('Passed to MP'))==='outofarea');
  assert('tagInfo() exists and returns badge property',typeof tagInfo(mk('Interested'))==='object'&&!!tagInfo(mk('Interested')).badge);
  assert('tagInfo() noresponse has orange dot',tagInfo(mk('CNA')).dot==='do');
  assert('tagInfo() outofarea has purple dot',tagInfo(mk('Not from Pune/Outsider')).dot==='dp');
  assert('tagInfo() cold has red dot',tagInfo(mk('Not Interested')).dot==='dr');
  assert('tagInfo() invalid has grey dot',tagInfo(mk('Invalid Number/Call on Whatsapp/No incoming calls')).dot==='dgy');
  assert('tagInfo() interested has blue dot',tagInfo(mk('Interested')).dot==='db');
  assert('tagInfo() stored tag overrides derive',(()=>{const l={...mk('Interested'),'Tag':'booked'};return tagInfo(l).badge==='btag-booked';})());
  assert('getTag() falls back to deriveTag when Tag field empty',getTag(mk('CNA'))==='noresponse');
  // ‚îÄ‚îÄ SHOOT TYPE CLASSIFICATION (v6.1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Age ‚Üí Shoot Type (JavaScript)');
  function ageTag(age){const l={'Baby Age':age,'General Notes':'','FU1 Notes':''};return classifyShootType(age);}
  // We embed the JS classifier here
  function classifyShootType(rawAge,notes=''){
    if(!rawAge)return'';
    const s=rawAge.trim().toLowerCase();const n=(notes||'').toLowerCase();
    if(/mat|mater|matern|pregnancy/.test(s)||s==='mat'||n.includes('maternity'))return'Maternity';
    if(s==='nb'||s.includes('newborn')||s.includes('new born'))return'Newborn';
    const dm=s.match(/(\d+)\s*days?/);if(dm){const d=parseInt(dm[1]);return d<=45?'Newborn':'Milestone';}
    const ym=s.match(/(\d+(?:\.\d+)?)\s*(?:y(?:r?s?|ear?s?))/);
    const mm=s.match(/(\d+(?:\.\d+)?)\s*(?:m(?:o(?:n(?:th?s?)?)?)?h?)(?![a-z])/);
    let months=null;
    if(ym&&!mm)months=parseFloat(ym[1])*12;
    else if(mm&&!ym)months=parseFloat(mm[1]);
    else if(ym&&mm)months=Math.min(parseFloat(mm[1]),parseFloat(ym[1])*12);
    else{const nm=s.split(/[\/&,\s]/)[0].match(/^(\d+(?:\.\d+)?)$/);if(nm){const v=parseFloat(nm[1]);months=v<=24?v:v*12;}}
    if(months===null)return'';
    if(months<=1)return'Newborn';
    if(months<=6)return'Milestone';
    if(months<11)return'Pre Birthday Shoot';
    if(months<14)return'Birthday / Cake Smash';
    if(n.includes('family shoot')||n.includes('family package'))return'Family';
    return'Kids';
  }
  assert('NB ‚Üí Newborn',classifyShootType('NB')==='Newborn');
  assert('Newborn ‚Üí Newborn',classifyShootType('Newborn')==='Newborn');
  assert('new born ‚Üí Newborn',classifyShootType('new born')==='Newborn');
  assert('1m ‚Üí Newborn (0-1m rule)',classifyShootType('1m')==='Newborn');
  assert('8 days ‚Üí Newborn',classifyShootType('8 days')==='Newborn');
  assert('45 days ‚Üí Newborn',classifyShootType('45 days')==='Newborn');
  assert('2m ‚Üí Milestone (2-6m rule)',classifyShootType('2m')==='Milestone');
  assert('3m ‚Üí Milestone',classifyShootType('3m')==='Milestone');
  assert('5m ‚Üí Milestone',classifyShootType('5m')==='Milestone');
  assert('6m ‚Üí Milestone',classifyShootType('6m')==='Milestone');
  assert('6M ‚Üí Milestone',classifyShootType('6M')==='Milestone');
  assert('6 month ‚Üí Milestone',classifyShootType('6 month')==='Milestone');
  assert('6 M ‚Üí Milestone',classifyShootType('6 M')==='Milestone');
  assert('7m ‚Üí Pre Birthday Shoot',classifyShootType('7m')==='Pre Birthday Shoot');
  assert('7 month ‚Üí Pre Birthday Shoot',classifyShootType('7 month')==='Pre Birthday Shoot');
  assert('8m ‚Üí Pre Birthday Shoot',classifyShootType('8m')==='Pre Birthday Shoot');
  assert('10 month ‚Üí Pre Birthday Shoot',classifyShootType('10 month')==='Pre Birthday Shoot');
  assert('10M ‚Üí Pre Birthday Shoot',classifyShootType('10M')==='Pre Birthday Shoot');
  assert('10 mo ‚Üí Pre Birthday Shoot',classifyShootType('10 mo')==='Pre Birthday Shoot');
  assert('1y ‚Üí Birthday / Cake Smash',classifyShootType('1y')==='Birthday / Cake Smash');
  assert('1 year ‚Üí Birthday / Cake Smash',classifyShootType('1 year')==='Birthday / Cake Smash');
  assert('12 month ‚Üí Birthday / Cake Smash',classifyShootType('12 month')==='Birthday / Cake Smash');
  assert('11 month ‚Üí Birthday / Cake Smash',classifyShootType('11 month')==='Birthday / Cake Smash');
  assert('maternity ‚Üí Maternity',classifyShootType('maternity')==='Maternity');
  assert('MATERNITY ‚Üí Maternity',classifyShootType('MATERNITY')==='Maternity');
  assert('maternaty (typo) ‚Üí Maternity',classifyShootType('maternaty')==='Maternity');
  assert('2y ‚Üí Kids (14m+ default)',classifyShootType('2y')==='Kids');
  assert('5y ‚Üí Kids',classifyShootType('5y')==='Kids');
  assert('3y family notes ‚Üí Family',classifyShootType('3y','family shoot')==='Family');
  assert('empty ‚Üí empty string',classifyShootType('')==='');
  assert('Demo leads all have Tag set',leads.every(l=>!!(l['Tag'])));
  assert('Auto-tagged demo booked lead',leads.some(l=>l['Tag']==='booked'));
  assert('Auto-tagged demo cold lead',leads.some(l=>l['Tag']==='cold'));
  assert('Auto-tagged demo int lead',leads.some(l=>l['Tag']==='int'));
  assert('Auto-tagged demo nore lead',leads.some(l=>l['Tag']==='nore'));
  assert('Auto-tagged demo warm lead',leads.some(l=>l['Tag']==='warm'));

  group('Auto-tag: backfill (only blank tags)');
  assert('deriveTag fills blank tags',(()=>{
    const l={'FU1 Notes':'Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':'','General Notes':''};
    const tag=deriveTag(l);return tag==='int';
  })());
  assert('Backfill skips leads with existing tag',(()=>{
    const l={'FU1 Notes':'No Response','Tag':'int','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''};
    return getTag(l)==='int'; // stored tag preserved
  })());
  assert('save applies tag on new leads',(()=>{
    const l={'FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':'','Tag':''};
    l['Tag']=deriveTag(l);return l['Tag']==='booked';
  })());

  // ‚îÄ‚îÄ DATE QUICK-PICKS (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Date Quick-Picks');
  const origFrom=document.getElementById('fDateFrom').value;
  const origTo=document.getElementById('fDateTo').value;
  setDatePreset('today');
  assert('Today: from=to=today',document.getElementById('fDateFrom').value===todayISO()&&document.getElementById('fDateTo').value===todayISO());
  setDatePreset('yesterday');
  assert('Yesterday: from=to=1d ago',document.getElementById('fDateFrom').value===daysAgoISO(1)&&document.getElementById('fDateTo').value===daysAgoISO(1));
  setDatePreset('2days');
  assert('2days: from=to=2d ago',document.getElementById('fDateFrom').value===daysAgoISO(2));
  setDatePreset('3days');
  assert('3days: from=to=3d ago',document.getElementById('fDateFrom').value===daysAgoISO(3));
  setDatePreset('clear');
  assert('Clear empties both fields',document.getElementById('fDateFrom').value===''&&document.getElementById('fDateTo').value==='');
  setDatePreset('week');
  assert('Week: from <= today',document.getElementById('fDateFrom').value<=todayISO());
  assert('Week: to = today',document.getElementById('fDateTo').value===todayISO());
  setDatePreset('month');
  assert('Month: from ends in -01',document.getElementById('fDateFrom').value.endsWith('-01'));
  document.getElementById('fDateFrom').value=origFrom;document.getElementById('fDateTo').value=origTo;

  // ‚îÄ‚îÄ WHATSAPP LINK (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('WhatsApp Link Generation');
  assert('wa.me URL format correct',(()=>{const ph='9876543210';return'https://wa.me/91'+ph.replace(/\D/g,'')===`https://wa.me/919876543210`;})());
  assert('Phone stripped of spaces',(()=>{const ph='+91 98765 43210';return'https://wa.me/91'+ph.replace(/\D/g,'')!=='';})());
  assert('Phone stripped of dashes',(()=>{const ph='98765-43210';return'91'+ph.replace(/\D/g,'')!=='';})());
  assert('Empty phone produces empty target',(()=>{const ph='';return ph.replace(/\D/g,'')==='';})());
  assert('Non-reachable from pune lead can still have WA link',(()=>{const l=leads.find(l=>l['Tag']==='oop');return l&&!!(l['Phone']);})());

  // ‚îÄ‚îÄ LEAD AGE BADGE (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Lead Age Badge');
  assert('Age 0 for today lead',leadAgeDays({'Date Added':todayISO()})===0);
  assert('Age 1 for yesterday lead',leadAgeDays({'Date Added':daysAgoISO(1)})===1);
  assert('Age > 14 shows badge',(()=>{const l={'Date Added':daysAgoISO(20)};return leadAgeDays(l)>14;})());
  assert('Age 0 does not show badge',(()=>{const l={'Date Added':todayISO()};const age=leadAgeDays(l);return(!isClosed(l)&&age>14)===false;})());
  assert('Stale lead in demo has badge',leads.some(l=>!isClosed(l)&&leadAgeDays(l)>14));
  assert('Age returns 0 for missing date',leadAgeDays({'Date Added':''})===0);
  assert('Age returns number',typeof leadAgeDays({'Date Added':todayISO()})==='number');

  // ‚îÄ‚îÄ ALERT BANNER (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Overdue Alert Banner');
  const today=new Date();today.setHours(0,0,0,0);
  const activeLeads=leads.filter(l=>!isClosed(l));
  const overdueLeads=activeLeads.filter(l=>{const nd=nextFUDate(l);if(!nd)return false;const d=parseDate(nd);if(!d)return false;d.setHours(0,0,0,0);return d<today;});
  const dueTodayLeads=activeLeads.filter(l=>{const nd=nextFUDate(l);if(!nd)return false;const d=parseDate(nd);if(!d)return false;d.setHours(0,0,0,0);return d.getTime()===today.getTime();});
  assert('Overdue filter returns array',Array.isArray(overdueLeads));
  assert('Due today filter returns array',Array.isArray(dueTodayLeads));
  assert('Overdue are all past',overdueLeads.every(l=>{const nd=nextFUDate(l);const d=parseDate(nd);d.setHours(0,0,0,0);return d<today;}));
  assert('Due today are exactly today',dueTodayLeads.every(l=>{const nd=nextFUDate(l);const d=parseDate(nd);d.setHours(0,0,0,0);return d.getTime()===today.getTime();}));
  assert('updateAlertBanner runs without error',(()=>{try{updateAlertBanner();return true;}catch(e){return false;}})());

  // ‚îÄ‚îÄ BULK ASSIGN (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Bulk Select + Assign');
  assert('selectedRis is a Set',selectedRis instanceof Set);
  assert('toggleChk adds to set',(()=>{const prev=selectedRis.size;toggleChk(999,true);const ok=selectedRis.has(999);toggleChk(999,false);return ok&&selectedRis.size===prev;})());
  assert('toggleChk removes from set',(()=>{toggleChk(998,true);toggleChk(998,false);return!selectedRis.has(998);})());
  assert('bulkClear empties set',(()=>{toggleChk(997,true);bulkClear();return selectedRis.size===0;})());
  assert('Bulk bar shows when leads selected',(()=>{toggleChk(996,true);const show=selectedRis.size>0;bulkClear();return show;})());
  assert('FIELDS includes Agent for bulk assign',FIELDS.includes('Agent'));

  // ‚îÄ‚îÄ QUICK CALL MODE (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Quick Call Mode');
  assert('qcmActive starts false',!qcmActive);
  assert('qcmQueue starts empty',qcmQueue.length===0);
  assert('startQCM loads queue',(()=>{const prevF=[...filtered];filtered=leads.filter(l=>!isClosed(l)).slice(0,3);if(filtered.length){startQCM();const ok=qcmActive&&qcmQueue.length>0;qcmExit();filtered=prevF;return ok;}filtered=prevF;return true;})());
  assert('qcmExit resets state',(()=>{qcmActive=true;qcmQueue=[{_ri:1}];qcmIdx=1;qcmExit();return!qcmActive&&qcmQueue.length===0&&qcmIdx===0;})());
  assert('qcmNext increments index',(()=>{qcmQueue=[{_ri:2},{_ri:3},{_ri:4}];qcmIdx=0;qcmActive=true;qcmIdx++;const ok=qcmIdx===1;qcmExit();return ok;})());

  // ‚îÄ‚îÄ EXPORT CSV (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('CSV Export');
  assert('exportLeadList handles empty gracefully',(()=>{try{const prevBody=document.getElementById('leadsBody').innerHTML;exportLeadList([],'test');document.getElementById('leadsBody').innerHTML=prevBody;return true;}catch(e){return false;}})());
  assert('CSV rows = leads.length + 1 header',(()=>{const list=[leads[0],leads[1]].filter(Boolean);if(!list.length)return true;const rows=[FIELDS,...list.map(l=>FIELDS.map(f=>l[f]||''))];return rows.length===list.length+1;})());
  assert('CSV escapes quotes',(()=>{const v='say "hello"';const esc_v=`"${v.replace(/"/g,'""')}"`;return esc_v==='\'say "hello"\''||esc_v.includes('""');})());
  assert('FIELDS used as CSV header',Array.isArray(FIELDS)&&FIELDS.includes('Name')&&FIELDS.includes('Phone'));
  assert('Filtered export uses filtered array',(()=>{const fBefore=filtered.length;filtered=leads.slice(0,2);const ok=filtered.length===2;filtered=leads.filter(l=>!isClosed(l));return ok;})());

  // ‚îÄ‚îÄ DUPLICATE DETECTION (new v5) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Duplicate Phone Detection on Import');
  assert('Duplicate detected by phone number',(()=>{const existing=new Set(['9876543210']);const ph='9876543210';return existing.has(ph.replace(/\D/g,''));})());
  assert('Non-dup not flagged',(()=>{const existing=new Set(['9876543210']);return!existing.has('9999999999');})());
  assert('Phone normalised before check',(()=>{const existing=new Set(['9876543210']);const ph='+91 9876543210';return existing.has(ph.replace(/\D/g,'').slice(-10));})());
  assert('Leads with existing phones excluded from import',(()=>{const existingPhones=new Set(leads.map(l=>(l['Phone']||'').replace(/\D/g,'')).filter(Boolean));const newPh='1111111111';return!existingPhones.has(newPh);})());
  assert('All demo phones are unique',(()=>{const phones=leads.map(l=>(l['Phone']||'').replace(/\D/g,'')).filter(Boolean);return phones.length===new Set(phones).size;})());

  // ‚îÄ‚îÄ CLOSED / ACTIVE (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Closed / Active Detection');
  assert('Booked = closed',isClosed({'FU1 Notes':'Booked','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':''}));
  assert('Lost Lead = closed',isClosed({'FU2 Notes':'Lost Lead','FU1 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':''}));
  assert('Not Interested = closed',isClosed({'FU1 Notes':'Not Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':''}));
  assert('Shoot Done = closed',isClosed({'FU4 Notes':'Shoot Done','FU1 Notes':'','FU2 Notes':'','FU3 Notes':'','Tag':''}));
  assert('Interested = active',!isClosed({'FU1 Notes':'Interested','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':''}));
  assert('Empty = active',!isClosed({'FU1 Notes':'','FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','Tag':''}));

  // ‚îÄ‚îÄ FU STAGE FILTER (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('FU Stage Filter');
  const newL=leads.filter(l=>!isClosed(l)&&!(l['FU1 Notes']||l['FU1 Date']));
  assert('New filter: none have FU1',newL.every(l=>!(l['FU1 Notes']||l['FU1 Date'])));
  assert('New filter: none are closed',newL.every(l=>!isClosed(l)));

  // ‚îÄ‚îÄ WINDOW MISSED (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Window Missed Detection');
  assert('Newborn 30d old = missed',wmCheck({'Shoot Type':'Newborn','Baby Age':'Newborn','Date Added':'01/01/2026'}));
  assert('Newborn today = not missed',!wmCheck({'Shoot Type':'Newborn','Baby Age':'Newborn','Date Added':todayISO()}));
  assert('Missing fields = not missed',!wmCheck({'Shoot Type':'','Baby Age':'','Date Added':''}));

  // ‚îÄ‚îÄ COLUMN VISIBILITY (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Column Visibility');
  assert('col-tag is hideable',HIDEABLE_COLS.some(c=>c.key==='col-tag'));
  assert('col-source is hideable',HIDEABLE_COLS.some(c=>c.key==='col-source'));
  assert('All 6 cols hideable',HIDEABLE_COLS.length===6);
  assert('colClass visible=empty string',colClass('col-tag')===(colVisibility['col-tag']?'':'col-hide'));

  // ‚îÄ‚îÄ CSV IMPORT PARSING (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('CSV Import Parsing');
  assert('Detects headers',(()=>{const r=parseCSV('Phone,Name\n9876543210,Priya');return r.headers[0]==='Phone'&&r.rows[0][0]==='9876543210';})());
  assert('Numbers-only = Column labels',(()=>{const r=parseCSV('9876543210\n9123456789');return r.headers[0]==='Column 1'&&r.rows.length===2;})());
  assert('Quoted values parsed',(()=>{const r=parseCSV('"Phone","Name"\n"9876543210","Priya Sharma"');return r.rows[0][1]==='Priya Sharma';})());
  assert('Comma in quotes handled',(()=>{const r=parseCSV('Name,Note\n"Smith, John","Test"');return r.rows[0][0]==='Smith, John';})());

  // ‚îÄ‚îÄ CONFIG SYNC (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Config Sync');
  assert('shootTypes join/split roundtrip',(()=>{const a=CFG.shootTypes;return a.join('|').split('|').filter(Boolean).join('|')===a.join('|');})());
  assert('fuLabels have 4 entries',CFG.fuLabels.length===4);
  assert('getStage uses fuLabels',getStage({'FU1 Notes':'x','FU1 Date':'x','FU2 Notes':'','FU2 Date':'','FU3 Notes':'','FU3 Date':'','FU4 Notes':'','FU4 Date':''}).includes(CFG.fuLabels[0]));

  // ‚îÄ‚îÄ CSV RFC 4180 PARSER (v6 fix) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('CSV Parser ‚Äî RFC 4180');
  assert('Simple CSV parses correctly',(()=>{const r=parseCSV('Name,Phone\nPriya,9876543210');return r.rows[0][0]==='Priya'&&r.rows[0][1]==='9876543210';})());
  assert('Comma inside quoted field',(()=>{const r=parseCSV('Name,Note\n"Smith, John","Good client"');return r.rows[0][0]==='Smith, John';})());
  assert('2nd field after quoted comma correct',(()=>{const r=parseCSV('Name,Note\n"Smith, John","Good client"');return r.rows[0][1]==='Good client';})());
  assert('Double-quote escape inside field',(()=>{const r=parseCSV('Name,Quote\n"Alice","She said ""hello"""');return r.rows[0][1]==='She said "hello"';})());
  assert('Quoted field with comma in value',(()=>{const r=parseCSV('"Pimpri, Pune",9876543210');return r.rows[0][0]==='Pimpri, Pune';})());
  assert('Numbers-only CSV gets Column headers',(()=>{const r=parseCSV('9876543210\n9123456789');return r.headers[0]==='Column 1';})());
  assert('Detects text headers',(()=>{const r=parseCSV('Phone,Name\n9876543210,Priya');return r.headers[0]==='Phone';})());
  assert('Empty rows filtered out',(()=>{const r=parseCSV('Name,Phone\nPriya,9876\n\n\nAnita,9123');return r.rows.length===2;})());
  assert('CRLF line endings handled',(()=>{const r=parseCSV('Name,Phone\r\nPriya,9876');return r.rows[0][0]==='Priya';})());
  assert('Three columns with quoted comma',(()=>{const r=parseCSV('A,B,C\n"a,1",b,c');return r.rows[0][0]==='a,1'&&r.rows[0][1]==='b'&&r.rows[0][2]==='c';})());

  // ‚îÄ‚îÄ SCHEDULED REMINDER LOGIC (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Scheduled Reminder Logic');
  const futureDate=(n=1)=>{const d=new Date();d.setDate(d.getDate()+n);return d.toISOString().split('T')[0];};
  const pastDate=(n=5)=>{const d=new Date();d.setDate(d.getDate()-n);return d.toISOString().split('T')[0];};
  const schLead={'FU1 Date':futureDate(3),'FU1 Notes':'','FU2 Date':'','FU2 Notes':'','FU3 Date':'','FU3 Notes':'','FU4 Date':'','FU4 Notes':''};
  const notSchLead={'FU1 Date':futureDate(3),'FU1 Notes':'Interested','FU2 Date':'','FU2 Notes':'','FU3 Date':'','FU3 Notes':'','FU4 Date':'','FU4 Notes':''};
  const todaySchLead={'FU1 Date':todayISO(),'FU1 Notes':'','FU2 Date':'','FU2 Notes':'','FU3 Date':'','FU3 Notes':'','FU4 Date':'','FU4 Notes':''};
  assert('Date set no notes ‚Üí isScheduledReminder',isScheduledReminder(schLead));
  assert('Date set with notes ‚Üí NOT scheduled',!isScheduledReminder(notSchLead));
  assert('Past date no notes ‚Üí NOT scheduled',!isScheduledReminder({'FU1 Date':pastDate(3),'FU1 Notes':'','FU2 Date':'','FU2 Notes':'','FU3 Date':'','FU3 Notes':'','FU4 Date':'','FU4 Notes':''}));
  assert('Today date no notes ‚Üí IS scheduled',isScheduledReminder(todaySchLead));
  assert('Scheduled lead ‚Üí tag=scheduled',getTag(schLead)==='scheduled');
  assert('Non-scheduled lead ‚Üí not scheduled tag',getTag(notSchLead)!=='scheduled');
  assert('reminderDate returns future date',reminderDate(schLead)===schLead['FU1 Date']);
  assert('reminderDate empty for non-scheduled',reminderDate(notSchLead)==='');

  // ‚îÄ‚îÄ OVERDUE VS DUE TODAY SPLIT (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Overdue vs Due Today Split');
  const baseActive={'Tag':'','Stage':'Active','FU3 Date':'','FU3 Notes':'','FU4 Date':'','FU4 Notes':''};
  const overdueL={...baseActive,'FU1 Notes':'Interested','FU1 Date':pastDate(5),'FU2 Date':pastDate(2),'FU2 Notes':''};
  const dueTodayL={...baseActive,'FU1 Notes':'Interested','FU1 Date':pastDate(5),'FU2 Date':todayISO(),'FU2 Notes':''};
  const futureL={...baseActive,'FU1 Notes':'Interested','FU1 Date':pastDate(5),'FU2 Date':futureDate(3),'FU2 Notes':''};
  assert('Past next FU ‚Üí isOverdue',isOverdue(overdueL));
  assert('Today next FU ‚Üí NOT overdue',!isOverdue(dueTodayL));
  assert('Future next FU ‚Üí NOT overdue',!isOverdue(futureL));
  assert('Today FU ‚Üí isDueToday',isDueToday(dueTodayL));
  assert('Past FU ‚Üí NOT isDueToday',!isDueToday(overdueL));
  assert('Future FU ‚Üí NOT isDueToday',!isDueToday(futureL));
  assert('Scheduled future ‚Üí NOT overdue',!isOverdue(schLead));
  assert('Scheduled today ‚Üí isDueToday',isDueToday(todaySchLead));
  assert('Scheduled future ‚Üí NOT isDueToday',!isDueToday(schLead));

  // ‚îÄ‚îÄ ARCHIVE LOGIC (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Archive Logic');
  const old62=(()=>{const d=new Date();d.setDate(d.getDate()-62);return d.toISOString().split('T')[0];})();
  const stale={...baseActive,'Date Added':old62,'FU1 Notes':'No Response','FU1 Date':old62,'FU2 Date':'','FU2 Notes':''};
  const staleWithFuture={...baseActive,'Date Added':old62,'FU1 Notes':'Interested','FU1 Date':old62,'FU2 Date':futureDate(5),'FU2 Notes':''};
  assert('62d old, no future FU ‚Üí archiveable',isArchiveable(stale));
  assert('62d old WITH future FU ‚Üí NOT archiveable',!isArchiveable(staleWithFuture));
  assert('Fresh lead ‚Üí NOT archiveable',!isArchiveable({...baseActive,'Date Added':todayISO(),'FU1 Date':'','FU1 Notes':'','FU2 Date':'','FU2 Notes':''}));

  // ‚îÄ‚îÄ SOURCES CONFIG (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Sources Config');
  assert('Default sources has Whatsapp',CFG.sources.includes('Whatsapp'));
  assert('Default sources has Incoming Call',CFG.sources.includes('Incoming Call'));
  assert('Sources are unique strings',CFG.sources.every(s=>typeof s==='string'&&s.length>0));
  assert('Sources roundtrip through pipe',CFG.sources.join('|').split('|').filter(Boolean).every((s,i)=>s===CFG.sources[i]));

  // ‚îÄ‚îÄ PER-FU OUTCOMES (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Per-FU Stage Outcomes');
  assert('fuOutcomes has 4 stages',CFG.fuOutcomes.length===4);
  assert('FU1 outcomes non-empty',CFG.fuOutcomes[0].length>0);
  assert('FU2 differs from FU1',JSON.stringify(CFG.fuOutcomes[0])!==JSON.stringify(CFG.fuOutcomes[1]));
  assert('FU4 has Booked option',CFG.fuOutcomes[3].some(o=>o.toLowerCase().includes('booked')));
  assert('outcomeColor Booked=sg',outcomeColor('Booked')==='sg');
  assert('outcomeColor Not Interested=sr',outcomeColor('Not Interested')==='sr');
  assert('outcomeColor No Response=so',outcomeColor('No Response')==='so');
  assert('outcomeColor Interested=sb',outcomeColor('Interested')==='sb');
  assert('fuOutcomes JSON roundtrip',(()=>{const s=JSON.stringify(CFG.fuOutcomes);return JSON.stringify(JSON.parse(s))===s;})());

  // ‚îÄ‚îÄ CUSTOM TAGS (v6) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Custom Tags & resolveTagKey');
  assert('booked resolves',resolveTagKey('booked')==='booked');
  assert('Booked (caps) resolves',resolveTagKey('Booked')==='booked');
  assert('not interested ‚Üí cold',resolveTagKey('not interested')==='cold');
  assert('warm resolves',resolveTagKey('warm')==='warm');
  assert('cnr busy ‚Üí noresponse',resolveTagKey('cnr busy')==='noresponse');
  assert('unknown tag ‚Üí null',resolveTagKey('xyz_unknown_999')===null);
  assert('empty ‚Üí null',resolveTagKey('')===null);
  assert('null ‚Üí null',resolveTagKey(null)===null);
  assert('Shoot Done ‚Üí done',resolveTagKey('Shoot Done')==='done');
  assert('All TAG_DEFS have required fields',Object.values(TAG_DEFS).every(d=>d.bg&&d.color&&d.border&&d.dot&&d.emoji));
  assert('customTags default non-empty',CFG.customTags.length>0);

  // ‚îÄ‚îÄ TAG PRIORITY (v7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Tag Priority ‚Äî Manual Override vs Auto-Derive');
  // Simulate what saveLead does: manualTag wins over deriveTag
  function resolveLeadTag(manualTag, notes){
    const l={'FU1 Notes':notes,'FU2 Notes':'','FU3 Notes':'','FU4 Notes':'','General Notes':''};
    return manualTag||deriveTag(l)||'';
  }
  assert('Manual Cold beats auto-derive',resolveLeadTag('cold','Details Shared')==='cold');
  assert('Manual Booked beats CNR notes',resolveLeadTag('booked','CNR CNR CNR')==='booked');
  assert('Manual Interested beats cold notes',resolveLeadTag('interested','Not Interested')==='interested');
  assert('No manual ‚Üí auto-derive CNR',resolveLeadTag('','CNR')==='noresponse');
  assert('No manual ‚Üí auto-derive interested',resolveLeadTag('','Details Shared')==='interested');
  assert('No manual + empty notes ‚Üí new',resolveLeadTag('','')==='new'||resolveLeadTag('','')==='');
  assert('Manual warm + auto-cold ‚Üí warm',resolveLeadTag('warm','Not Interested')==='warm');
  assert('Manual outofarea stays',resolveLeadTag('outofarea','Details Shared')==='outofarea');

  // ‚îÄ‚îÄ IS CLOSED (v7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('isClosed ‚Äî Close Logic');
  const mkL=(tag,notes='')=>({'Tag':tag,'Stage':'','FU1 Notes':notes,'FU2 Notes':'','FU3 Notes':'','FU4 Notes':''});
  assert('Tag=booked ‚Üí closed',isClosed(mkL('booked')));
  assert('Tag=done ‚Üí closed',isClosed(mkL('done')));
  assert('Tag=cold ‚Üí closed',isClosed(mkL('cold')));
  assert('Tag=invalid ‚Üí closed',isClosed(mkL('invalid')));
  assert('Tag=outofarea ‚Üí NOT closed',!isClosed(mkL('outofarea')));
  assert('Tag=interested ‚Üí NOT closed',!isClosed(mkL('interested')));
  assert('Tag=warm ‚Üí NOT closed',!isClosed(mkL('warm')));
  assert('Tag=noresponse ‚Üí NOT closed',!isClosed(mkL('noresponse')));
  assert('Tag=new ‚Üí NOT closed',!isClosed(mkL('new')));
  assert('Notes: booked ‚Üí closed',isClosed(mkL('','booking confirmed')));
  assert('Notes: shoot done ‚Üí closed',isClosed(mkL('','shoot done')));
  assert('Notes: not interested ‚Üí closed',isClosed(mkL('','not interested')));
  assert('Notes: not intrested typo ‚Üí closed',isClosed(mkL('','not intrested')));
  assert('Notes: invalid number ‚Üí closed',isClosed(mkL('','invalid number')));
  assert('Notes: CNR ‚Üí NOT closed',!isClosed(mkL('','CNR')));
  assert('Notes: details shared ‚Üí NOT closed',!isClosed(mkL('','details shared')));
  assert('Notes: not from pune ‚Üí NOT closed',!isClosed(mkL('','not from pune')));
  assert('Stage=Closed stored ‚Üí closed',isClosed({...mkL(''),'Stage':'Closed'}));

  // ‚îÄ‚îÄ DUPLICATE PHONE DETECTION (v7) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Duplicate Phone Detection');
  const testLeads=[
    {Phone:'9876543210',Name:'Priya','Tag':'interested',_ri:2},
    {Phone:'9123456789',Name:'Anita','Tag':'new',_ri:3},
    {Phone:'+91 98765 43210',Name:'Priya Dup','Tag':'cold',_ri:4},
  ];
  function checkDupPhone(newPhone, existingLeads){
    const ph=newPhone.replace(/\D/g,'');
    return existingLeads.find(l=>l.Phone&&l.Phone.replace(/\D/g,'')===ph)||null;
  }
  assert('Exact match detected',checkDupPhone('9876543210',testLeads)!==null);
  assert('No match ‚Üí null',checkDupPhone('9999999999',testLeads)===null);
  assert('Different number ‚Üí null',checkDupPhone('9000000000',testLeads)===null);
  assert('+91 prefix normalised ‚Üí match',checkDupPhone('+91 98765 43210',testLeads)!==null);
  assert('Spaces stripped ‚Üí match',checkDupPhone('98765 43210',testLeads)!==null);
  assert('Dashes stripped ‚Üí match',checkDupPhone('987-654-3210',testLeads)!==null);
  assert('Dup returns correct lead name',checkDupPhone('9876543210',testLeads).Name==='Priya');
  assert('No dup on empty leads',checkDupPhone('9876543210',[])==null);

  // ‚îÄ‚îÄ clearFilters + setDatePreset exist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('clearFilters sanity');
  assert('clearFilters is a function',typeof clearFilters==='function');
  assert('setDatePreset is a function',typeof setDatePreset==='function');
  assert('clearDateQuick does NOT exist (was crashing)',typeof clearDateQuick==='undefined');
  assert('activeDatePreset resets on clear',(()=>{setDatePreset('today');setDatePreset('clear');return activeDatePreset==='clear';})());

  // ‚îÄ‚îÄ FUNCTIONS THAT MUST EXIST (regression guard) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  group('Required Functions Exist');
  const mustExist=['deriveTag','classifyShootType','isClosed','getTag','tagInfo','openPanel',
    'saveLead','loadLeads','clearFilters','setDatePreset','resolveTagKey','switchTab',
    'buildPipelineDropdown','switchPipeline','bookmarkPipeline','applyURLPipeline',
    'pushSettingsToCloud','pullSettingsFromCloud','saveSettingsSheet','renderPipelineList'];
  mustExist.forEach(fn=>assert(`${fn}() exists`,typeof eval(fn)==='function'));

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const total=pass+fail;
  document.getElementById('testSummary').textContent=`${pass}/${total} passed${fail>0?' ‚Äî '+fail+' FAILED':'  ‚úì All pass'}`;
  document.getElementById('testSummary').style.color=fail>0?'var(--rd)':'var(--gr)';
  let html='';
  results.forEach(r=>{
    if(r.group)html+=`<div class="tg">${esc(r.group)}</div>`;
    else html+=`<div class="tr2"><span class="${r.ok?'tp':'tf'}">${r.ok?'‚úì':'‚úó'}</span><span>${esc(r.name)}</span>${!r.ok?'<span style="color:var(--rd);font-size:10px;margin-left:auto">FAIL</span>':''}</div>`;
  });
  document.getElementById('testOutput').innerHTML=html;
  return{pass,fail,total};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{
  const c=localStorage.getItem('sc'),s=localStorage.getItem('ss2'),n=localStorage.getItem('sn2');
  if(c)document.getElementById('cfgCid').value=c;
  if(s)document.getElementById('cfgSid').value=s;
  if(n)document.getElementById('cfgSname').value=n;
  // v8: reportDate removed, now using reportFrom/reportTo
});
</script>
</body>
</html>
